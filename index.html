<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ© - V43 Strategic Planner</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="ØªØ·Ø¨ÙŠÙ‚ Ù…Ø­ÙØ¸Ø© Ù…Ø§Ù„ÙŠØ© Ø´Ø®ØµÙŠØ© Ù…ØªÙƒØ§Ù…Ù„ ÙˆØ£Ø¯Ø§Ø© ØªØ®Ø·ÙŠØ· Ø°ÙƒÙŠØ© Ù„Ù„Ø¯ÙŠÙˆÙ†">
    <meta name="theme-color" content="#0f172a">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        primary: '#2563eb', 
                        secondary: '#64748b', 
                        success: '#10b981', 
                        danger: '#ef4444', 
                        fawryYellow: '#FFD200',
                        fawryBlue: '#005CB9',
                        etisalatGreen: '#709E34',
                        etisalatRed: '#E60000',
                        dark: { bg: '#0f172a', card: '#1e293b', text: '#f8fafc' } 
                    },
                    fontFamily: { sans: ['Cairo', 'Segoe UI', 'sans-serif'] },
                    animation: { 
                        'fadeIn': 'fadeIn 0.3s ease-out',
                        'fadeInUp': 'fadeInUp 0.5s ease-out',
                        'slideInRight': 'slideInRight 0.4s ease-out',
                        'slideInBottom': 'slideInBottom 0.4s ease-out',
                        'bounce-slight': 'bounce-slight 2s ease-in-out infinite',
                        'pulse-slow': 'pulse 3s ease-in-out infinite'
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0', transform: 'scale(0.99)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideInRight: { '0%': { opacity: '0', transform: 'translateX(20px)' }, '100%': { opacity: '1', transform: 'translateX(0)' } },
                        slideInBottom: { '0%': { opacity: '0', transform: 'translateY(50px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        'bounce-slight': { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } }
                    },
                    boxShadow: {
                        'classic': '0 -4px 25px rgba(0,0,0,0.1)',
                        'card': '0 2px 8px rgba(0,0,0,0.05)',
                        'glow': '0 0 30px rgba(59, 130, 246, 0.3)',
                        'inner-glow': 'inset 0 0 20px rgba(0,0,0,0.05)',
                        'pro-card': '0 10px 40px -10px rgba(0,0,0,0.08)'
                    }
                }
            }
        }
    </script>
    
    <!-- ES Modules Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom": "https://esm.sh/react-dom@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "recharts": "https://esm.sh/recharts@2.10.3?external=react,react-dom",
            "lucide-react": "https://esm.sh/lucide-react@0.309.0?external=react",
            "date-fns": "https://esm.sh/date-fns@2.30.0"
        }
    }
    </script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- LZString Library for Data Compression -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    
    <!-- Custom Styles -->
    <style>
        body { @apply bg-gray-50 text-gray-900 transition-colors duration-300 font-sans; padding-bottom: calc(140px + env(safe-area-inset-bottom)); }
        .dark body { @apply bg-slate-950 text-slate-100; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { @apply bg-slate-100 dark:bg-slate-800 rounded-full; }
        ::-webkit-scrollbar-thumb { @apply bg-slate-300 dark:bg-slate-600 rounded-full hover:bg-slate-400 dark:hover:bg-slate-500 transition-colors; }
        .scroll-hide::-webkit-scrollbar { display: none; }
        
        /* Glassmorphism & Utilities */
        .glass { 
            backdrop-filter: blur(24px) saturate(200%); 
            -webkit-backdrop-filter: blur(24px) saturate(200%); 
            @apply bg-white/80 dark:bg-slate-900/80 border border-white/30 dark:border-slate-700/40 shadow-pro-card; 
        }
        
        .text-gradient { @apply bg-gradient-to-r from-blue-600 to-cyan-500 bg-clip-text text-transparent; }
        .hover-lift { @apply transition-all duration-300 hover:-translate-y-1.5 hover:shadow-2xl; }
        
        .bottom-nav-container { position: fixed; bottom: 0; left: 0; right: 0; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); @apply bg-white/90 dark:bg-slate-900/90 border-t border-gray-200/50 dark:border-slate-800/50 shadow-classic pb-2 pt-2; }
        .scrollable-nav { display: flex; align-items: center; gap: 8px; overflow-x: auto; padding: 0 16px; -webkit-overflow-scrolling: touch; }
        .nav-btn { @apply flex flex-col items-center justify-center min-w-[60px] h-[60px] rounded-xl text-slate-500 hover:text-blue-600 hover:bg-slate-50 dark:hover:bg-slate-800 transition-all active:scale-95 relative; }
        .nav-btn.active { @apply text-blue-600 dark:text-blue-400 font-bold bg-blue-50 dark:bg-slate-800 scale-105 shadow-sm; }
        .nav-btn span { font-size: 10px; margin-top: 2px; font-weight: 700; white-space: nowrap; }
        .v-line { @apply w-px h-8 bg-gray-300 dark:bg-slate-700 flex-shrink-0; }
        .fab { position: fixed; bottom: 100px; left: 20px; z-index: 1100; @apply w-16 h-16 bg-gradient-to-br from-blue-600 to-blue-500 text-white rounded-2xl shadow-xl shadow-blue-600/40 flex items-center justify-center border-4 border-white dark:border-slate-900 transition-transform active:scale-90 hover:scale-110 hover:shadow-glow; }
        .lock-screen { position: fixed; inset: 0; @apply bg-slate-950; z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        
        /* Optimized Input Field */
        .input-field { @apply w-full p-4 border border-slate-200 rounded-2xl outline-none focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 transition-all duration-300 bg-white/60 backdrop-blur-sm text-slate-800 dark:bg-slate-800/60 dark:border-slate-700 dark:text-white dark:focus:border-blue-400; }
        select.input-field { appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: left 1rem center; background-size: 1em; }
        
        .loading-spinner { @apply w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin; }
        .collapsible-header { cursor: pointer; transition: all 0.3s ease; }
        .collapsible-header:hover { background-color: rgba(0,0,0,0.02); }
        .dark .collapsible-header:hover { background-color: rgba(255,255,255,0.02); }
        
        /* Floating Stats */
        .floating-stats {
            position: sticky;
            bottom: 2rem;
            z-index: 50;
            animation: slideInBottom 0.4s ease-out;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }

        /* Enhanced News Ticker Animation */
        .ticker-wrap {
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            position: relative;
            box-shadow: 0 4px 20px -5px rgba(0, 0, 0, 0.1);
            z-index: 2000;
        }

        .ticker-content {
            display: inline-block;
            white-space: nowrap;
            animation: ticker-move-rtl 40s linear infinite; 
            padding-left: 50px;
        }

        .ticker-item {
            display: inline-block;
            padding: 0 2.5rem;
            font-size: 0.85rem;
            font-weight: 700;
            letter-spacing: -0.02em;
        }

        @keyframes ticker-move-rtl {
            0% { transform: translateX(0); }
            100% { transform: translateX(-100%); }
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-slate-900 text-slate-800 dark:text-slate-100 selection:bg-blue-500/30">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useMemo, useEffect, useCallback, useReducer, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { PieChart, Pie, Cell, BarChart, Bar, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';
        import { 
            LayoutDashboard, Wallet, CreditCard, Banknote, Plus, Trash2, TrendingUp, TrendingDown, 
            Calendar, ArrowUpRight, ArrowDownLeft, Edit, X, Save, 
            ShoppingBag, Smartphone, Store, ArrowRightLeft, Layers, ArrowRight, 
            Printer, ChevronRight, ChevronDown, Calculator, 
            ArrowUp, Undo2, Redo2, FileJson, LogOut, Lock, Unlock, Moon, Sun, ShieldCheck, Repeat, RefreshCw,
            Search, FileSpreadsheet, Settings, Target, CalendarDays, BarChart3, Bell, Copy, Sparkles, Bot, MessageSquare, Send, 
            AlertTriangle, Clock, CheckCircle2, Zap, Tag, FileText, Hash, Coins, Landmark, Circle, Percent, BellRing, Filter, Eye, EyeOff, ShieldAlert,
            Download, Upload, RefreshCcw, Signal, Home, Menu, PiggyBank, Landmark as BuildingBank, ArrowDownCircle, ArrowUpCircle
        } from 'lucide-react';

        // ğŸŒ GLOBAL DYNAMIC YEAR
        const CURRENT_YEAR = new Date().getFullYear();

        // --- ISLAMIC SPLASH DATA (Expanded) ---
        const DAILY_DHIKR = [
            "Ø³ÙØ¨Ù’Ø­ÙØ§Ù†Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙˆÙØ¨ÙØ­ÙÙ…Ù’Ø¯ÙÙ‡ÙØŒ Ø³ÙØ¨Ù’Ø­ÙØ§Ù†Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ù’Ø¹ÙØ¸ÙÙŠÙ…Ù",
            "Ù„ÙØ§ Ø­ÙÙˆÙ’Ù„Ù ÙˆÙÙ„ÙØ§ Ù‚ÙÙˆÙÙ‘Ø©Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ø¨ÙØ§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ù’Ø¹ÙÙ„ÙÙŠÙÙ‘ Ø§Ù„Ù’Ø¹ÙØ¸ÙÙŠÙ…Ù",
            "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø§ÙƒÙ’ÙÙÙ†ÙÙŠ Ø¨ÙØ­ÙÙ„ÙØ§Ù„ÙÙƒÙ Ø¹ÙÙ†Ù’ Ø­ÙØ±ÙØ§Ù…ÙÙƒÙØŒ ÙˆÙØ£ÙØºÙ’Ù†ÙÙ†ÙÙŠ Ø¨ÙÙÙØ¶Ù’Ù„ÙÙƒÙ Ø¹ÙÙ…ÙÙ‘Ù†Ù’ Ø³ÙÙˆÙØ§ÙƒÙ",
            "Ø£ÙØ³Ù’ØªÙØºÙ’ÙÙØ±Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„Ù’Ø¹ÙØ¸ÙÙŠÙ…Ù Ø§Ù„ÙÙ‘Ø°ÙÙŠ Ù„ÙØ§ Ø¥ÙÙ„ÙÙ‡Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ù‡ÙÙˆÙ Ø§Ù„Ù’Ø­ÙÙŠÙÙ‘ Ø§Ù„Ù’Ù‚ÙÙŠÙÙ‘ÙˆÙ…Ù ÙˆÙØ£ÙØªÙÙˆØ¨Ù Ø¥ÙÙ„ÙÙŠÙ’Ù‡Ù",
            "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¨ÙØ§Ø±ÙÙƒÙ’ Ù„ÙÙ†ÙØ§ ÙÙÙŠÙ…ÙØ§ Ø±ÙØ²ÙÙ‚Ù’ØªÙÙ†ÙØ§ ÙˆÙÙ‚ÙÙ†ÙØ§ Ø¹ÙØ°ÙØ§Ø¨Ù Ø§Ù„Ù†ÙÙ‘Ø§Ø±Ù",
            "Ù„ÙØ§ Ø¥ÙÙ„ÙÙ‡Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ø£ÙÙ†Ù’ØªÙ Ø³ÙØ¨Ù’Ø­ÙØ§Ù†ÙÙƒÙ Ø¥ÙÙ†ÙÙ‘ÙŠ ÙƒÙÙ†Ù’ØªÙ Ù…ÙÙ†Ù Ø§Ù„Ø¸ÙÙ‘Ø§Ù„ÙÙ…ÙÙŠÙ†Ù",
            "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¨ÙÙƒÙ Ø£ÙØµÙ’Ø¨ÙØ­Ù’Ù†ÙØ§ ÙˆÙØ¨ÙÙƒÙ Ø£ÙÙ…Ù’Ø³ÙÙŠÙ’Ù†ÙØ§ ÙˆÙØ¨ÙÙƒÙ Ù†ÙØ­Ù’ÙŠÙØ§ ÙˆÙØ¨ÙÙƒÙ Ù†ÙÙ…ÙÙˆØªÙ ÙˆÙØ¥ÙÙ„ÙÙŠÙ’ÙƒÙ Ø§Ù„Ù†ÙÙ‘Ø´ÙÙˆØ±Ù",
            "Ø±ÙØ¶ÙÙŠØªÙ Ø¨ÙØ§Ù„Ù„ÙÙ‘Ù‡Ù Ø±ÙØ¨Ù‹Ù‘Ø§ ÙˆÙØ¨ÙØ§Ù„Ø¥ÙØ³Ù’Ù„ÙØ§Ù…Ù Ø¯ÙÙŠÙ†Ù‹Ø§ ÙˆÙØ¨ÙÙ…ÙØ­ÙÙ…ÙÙ‘Ø¯Ù ØµÙÙ„ÙÙ‘Ù‰ Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø¹ÙÙ„ÙÙŠÙ’Ù‡Ù ÙˆÙØ³ÙÙ„ÙÙ‘Ù…Ù Ù†ÙØ¨ÙÙŠÙ‹Ù‘Ø§",
            "ÙŠÙØ§ Ø­ÙÙŠÙÙ‘ ÙŠÙØ§ Ù‚ÙÙŠÙÙ‘ÙˆÙ…Ù Ø¨ÙØ±ÙØ­Ù’Ù…ÙØªÙÙƒÙ Ø£ÙØ³Ù’ØªÙØºÙÙŠØ«Ù Ø£ÙØµÙ’Ù„ÙØ­Ù’ Ù„ÙÙŠ Ø´ÙØ£Ù’Ù†ÙÙŠ ÙƒÙÙ„ÙÙ‘Ù‡Ù",
            "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¥ÙÙ†ÙÙ‘ÙŠ Ø£ÙØ³Ù’Ø£ÙÙ„ÙÙƒÙ Ø¹ÙÙ„Ù’Ù…Ù‹Ø§ Ù†ÙØ§ÙÙØ¹Ù‹Ø§ ÙˆÙØ±ÙØ²Ù’Ù‚Ù‹Ø§ Ø·ÙÙŠÙÙ‘Ø¨Ù‹Ø§ ÙˆÙØ¹ÙÙ…ÙÙ„Ù‹Ø§ Ù…ÙØªÙÙ‚ÙØ¨ÙÙ‘Ù„Ù‹Ø§",
            "Ø§Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù‡Ù Ø§Ù„ÙÙ‘Ø°ÙÙŠ Ø£ÙØ·Ù’Ø¹ÙÙ…ÙÙ†ÙØ§ ÙˆÙØ³ÙÙ‚ÙØ§Ù†ÙØ§ ÙˆÙØ¬ÙØ¹ÙÙ„ÙÙ†ÙØ§ Ù…ÙØ³Ù’Ù„ÙÙ…ÙÙŠÙ†Ù",
            "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¥ÙÙ†ÙÙ‘ÙŠ Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙÙƒÙ Ù…ÙÙ†Ù Ø§Ù„Ù’Ù‡ÙÙ…ÙÙ‘ ÙˆÙØ§Ù„Ù’Ø­ÙØ²Ù’Ù†ÙØŒ ÙˆÙØ£ÙØ¹ÙÙˆØ°Ù Ø¨ÙÙƒÙ Ù…ÙÙ†Ù Ø§Ù„Ù’Ø¹ÙØ¬Ù’Ø²Ù ÙˆÙØ§Ù„Ù’ÙƒÙØ³ÙÙ„Ù",
            "Ø³ÙØ¨Ù’Ø­ÙØ§Ù†Ù Ø§Ù„Ù’Ù„ÙÙ‘Ù‡ÙØŒ ÙˆÙØ§Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù Ù„ÙÙ„ÙÙ‘Ù‡ÙØŒ ÙˆÙØ§Ù„Ù„ÙÙ‘Ù‡Ù Ø£ÙÙƒÙ’Ø¨ÙØ±Ù",
            "Ù„ÙØ§ Ø¥ÙÙ„ÙÙ‡Ù Ø¥ÙÙ„ÙÙ‘Ø§ Ø§Ù„Ù„ÙÙ‘Ù‡Ù ÙˆÙØ­Ù’Ø¯ÙÙ‡Ù Ù„ÙØ§ Ø´ÙØ±ÙÙŠÙƒÙ Ù„ÙÙ‡ÙØŒ Ù„ÙÙ‡Ù Ø§Ù„Ù’Ù…ÙÙ„Ù’ÙƒÙ ÙˆÙÙ„ÙÙ‡Ù Ø§Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù ÙˆÙÙ‡ÙÙˆÙ Ø¹ÙÙ„ÙÙ‰ ÙƒÙÙ„ÙÙ‘ Ø´ÙÙŠÙ’Ø¡Ù Ù‚ÙØ¯ÙÙŠØ±ÙŒ",
            "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ ØµÙÙ„ÙÙ‘ Ø¹ÙÙ„ÙÙ‰ Ù…ÙØ­ÙÙ…ÙÙ‘Ø¯Ù ÙˆÙØ¹ÙÙ„ÙÙ‰ Ø¢Ù„Ù Ù…ÙØ­ÙÙ…ÙÙ‘Ø¯Ù ÙƒÙÙ…ÙØ§ ØµÙÙ„ÙÙ‘ÙŠÙ’ØªÙ Ø¹ÙÙ„ÙÙ‰ Ø¥ÙØ¨Ù’Ø±ÙØ§Ù‡ÙÙŠÙ…Ù ÙˆÙØ¹ÙÙ„ÙÙ‰ Ø¢Ù„Ù Ø¥ÙØ¨Ù’Ø±ÙØ§Ù‡ÙÙŠÙ…Ù",
            "Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„ÙÙ‘Ø°ÙÙŠ Ù„ÙØ§ ÙŠÙØ¶ÙØ±ÙÙ‘ Ù…ÙØ¹Ù Ø§Ø³Ù’Ù…ÙÙ‡Ù Ø´ÙÙŠÙ’Ø¡ÙŒ ÙÙÙŠ Ø§Ù„Ù’Ø£ÙØ±Ù’Ø¶Ù ÙˆÙÙ„ÙØ§ ÙÙÙŠ Ø§Ù„Ø³ÙÙ‘Ù…ÙØ§Ø¡Ù ÙˆÙÙ‡ÙÙˆÙ Ø§Ù„Ø³ÙÙ‘Ù…ÙÙŠØ¹Ù Ø§Ù„Ù’Ø¹ÙÙ„ÙÙŠÙ…Ù",
            "Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙÙƒÙÙ„ÙÙ…ÙØ§ØªÙ Ø§Ù„Ù„ÙÙ‘Ù‡Ù Ø§Ù„ØªÙÙ‘Ø§Ù…ÙÙ‘Ø§ØªÙ Ù…ÙÙ†Ù’ Ø´ÙØ±ÙÙ‘ Ù…ÙØ§ Ø®ÙÙ„ÙÙ‚Ù",
            "ÙŠÙØ§ Ø±ÙØ¨ÙÙ‘ØŒ Ù„ÙÙƒÙ Ø§Ù„Ù’Ø­ÙÙ…Ù’Ø¯Ù ÙƒÙÙ…ÙØ§ ÙŠÙÙ†Ù’Ø¨ÙØºÙÙŠ Ù„ÙØ¬ÙÙ„ÙØ§Ù„Ù ÙˆÙØ¬Ù’Ù‡ÙÙƒÙ ÙˆÙÙ„ÙØ¹ÙØ¸ÙÙŠÙ…Ù Ø³ÙÙ„Ù’Ø·ÙØ§Ù†ÙÙƒÙ",
            "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¥ÙÙ†ÙÙ‘ÙŠ Ø£ÙØ³Ù’Ø£ÙÙ„ÙÙƒÙ Ø§Ù„Ù’Ù‡ÙØ¯ÙÙ‰ ÙˆÙØ§Ù„ØªÙÙ‘Ù‚ÙÙ‰ ÙˆÙØ§Ù„Ù’Ø¹ÙÙÙØ§ÙÙ ÙˆÙØ§Ù„Ù’ØºÙÙ†ÙÙ‰",
            "Ø§Ù„Ù„ÙÙ‘Ù‡ÙÙ…ÙÙ‘ Ø¥ÙÙ†ÙÙ‘ÙŠ Ø£ÙØ¹ÙÙˆØ°Ù Ø¨ÙÙƒÙ Ù…ÙÙ†Ù’ Ø²ÙÙˆÙØ§Ù„Ù Ù†ÙØ¹Ù’Ù…ÙØªÙÙƒÙØŒ ÙˆÙØªÙØ­ÙÙˆÙÙ‘Ù„Ù Ø¹ÙØ§ÙÙÙŠÙØªÙÙƒÙØŒ ÙˆÙÙÙØ¬ÙØ§Ø¡ÙØ©Ù Ù†ÙÙ‚Ù’Ù…ÙØªÙÙƒÙØŒ ÙˆÙØ¬ÙÙ…ÙÙŠØ¹Ù Ø³ÙØ®ÙØ·ÙÙƒÙ"
        ];

        // --- UTILITY FUNCTIONS ---
        const normalizeText = (text) => {
            if (!text) return "";
            return text.toString()
                .replace(/[Ø£Ø¥Ø¢]/g, 'Ø§') 
                .replace(/Ù‰/g, 'ÙŠ')     
                .replace(/Ø©/g, 'Ù‡')     
                .replace(/[\u064B-\u065F]/g, '') 
                .trim()
                .toLowerCase();
        };
        
        const getLocalISODate = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const calculateCategorySpent = (expenses, categoryName) => {
          return expenses
            .filter(exp => exp.category === categoryName)
            .reduce((sum, current) => sum + Number(current.amount), 0);
        };

        const calculateDaysLeft = (targetDate) => {
          if (!targetDate) return null;
          const today = new Date();
          today.setHours(0, 0, 0, 0);
          const target = new Date(targetDate);
          target.setHours(0, 0, 0, 0);
          const diffTime = target - today;
          return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };

        // --- GLOBAL CONSTANTS ---
        const STORAGE_KEY = 'finance_tracker_V43_PLANNER';
        const LEGACY_KEYS = ['finance_tracker_V42_FINAL', 'finance_tracker_V41_FINAL', 'finance_tracker_V40_FINAL', 'finance_tracker_V39_CASHFLOW_PLANNER', 'finance_tracker_2026_V30_LAYOUT_FIXED'];
        const MONTHS = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
        const OPENING_SAVINGS_JAN = 28524; 

        // âœ… FIX (B): Helper to safely get month index
        const getMonthIndex = (monthName) => {
            return MONTHS.indexOf(monthName);
        };

        const CATEGORY_COLORS = { 
            'Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ': '#10b981', 'Ø¹Ù…Ù„ Ø­Ø±': '#3b82f6', 'Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª': '#8b5cf6', 
            'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©': '#ef4444', 'Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø¹ÙŠØ´Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©': '#f59e0b', 
            'Ù…Ø³Ø­ÙˆØ¨Ø§Øª Ù…Ø­Ù„ Ù‡Ø§Ù†ÙŠ': '#f97316', 'Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ ÙˆØ§Ù„Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©': '#ec4899', 
            'Ø§Ù„Ø²ÙƒØ§Ø© ÙˆØ§Ù„ØªØ¨Ø±Ø¹Ø§Øª': '#14b8a6', 'Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø©': '#6366f1', 
            'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©': '#84cc16', 'Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª â€“ Ø¨ÙˆÙ„Ø§Ù‚': '#64748b', 
            'Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª â€“ Ø§Ù„Ø¹Ø¨ÙˆØ±': '#0ea5e9', 'Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ´Ø­Ù† Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©': '#eab308', 
            'Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø·Ø¨ÙŠØ©': '#be123c', 'Ø§Ù„Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ†': '#a855f7', 
            'Ø§Ù„Ù„Ø­ÙˆÙ… ÙˆØ§Ù„Ø¯ÙˆØ§Ø¬Ù† ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ùƒ': '#be185d', 
            'Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ÙˆØ§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ù†Ù‚Ø¯ÙŠ': '#dc2626', 
            'Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©': '#78716c', 'Ø§Ù„Ù…ÙˆØ§ØµÙ„Ø§Øª ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª': '#06b6d4', 
            'Ø§Ù„ØªØ±ÙÙŠÙ‡ ÙˆØ§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©': '#d946ef', 'Ù…ØµØ§Ø±ÙŠÙ Ù…ÙˆØ³Ù…ÙŠØ© ÙˆØ³Ù†ÙˆÙŠØ©': '#22c55e', 
            'Ø´Ø­Ù† Ø±ØµÙŠØ¯ ÙÙˆØ±ÙŠ': '#eab308', 'Ø£Ø®Ø±Ù‰': '#9ca3af', 'Ø¹Ù‡Ø¯Ø© Ø´Ø±ÙƒØ© Ø¥ÙŠÙ…Ø§Ùƒ': '#f59e0b', 
            'ØªØ­ÙˆÙŠÙ„Ø§Øª ÙˆØ§Ø±Ø¯Ø©': '#8b5cf6', 'Ø´Ø­Ù† Ù…Ø­ÙØ¸Ø©': '#0ea5e9', 'ØªØ­ÙˆÙŠÙ„Ø§Øª': '#6366f1' 
        };
        
        const PAYMENT_METHODS = [
            { id: 'instapay', name: 'InstaPay', label: 'InstaPay' },
            { id: 'cib_card', name: 'CIB Card', label: 'CIB Card' }, 
            { id: 'cib_savings', name: 'CIB Savings', label: 'CIB ØªÙˆÙÙŠØ±' },
            { id: 'aaib_card', name: 'AAIB Card', label: 'AAIB Card' },
            { id: 'aaib_savings', name: 'AAIB Savings', label: 'AAIB ØªÙˆÙÙŠØ±' },
            { id: 'cash', name: 'Cash', label: 'Ù†Ù‚Ø¯ÙŠ' },
            { id: 'etisalat', name: 'Etisalat', label: 'Ø§ØªØµØ§Ù„Ø§Øª' }, 
            { id: 'fawry', name: 'Fawry', label: 'ÙÙˆØ±ÙŠ' },
        ];

        const CATEGORY_GROUPS = {
            'income': {
                'Ù…ØµØ§Ø¯Ø± Ø§Ù„Ø¯Ø®Ù„': ['Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ', 'Ø¹Ù…Ù„ Ø­Ø±', 'Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª'],
                'ØªØ­ÙˆÙŠÙ„Ø§Øª': ['Ø¹Ù‡Ø¯Ø© Ø´Ø±ÙƒØ© Ø¥ÙŠÙ…Ø§Ùƒ', 'ØªØ­ÙˆÙŠÙ„Ø§Øª ÙˆØ§Ø±Ø¯Ø©', 'Ø£Ø®Ø±Ù‰']
            },
            'expense': {
                'Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ù…Ø¹ÙŠØ´Ø©': ['Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø¹ÙŠØ´Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©', 'Ø§Ù„Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ†', 'Ø§Ù„Ù„Ø­ÙˆÙ… ÙˆØ§Ù„Ø¯ÙˆØ§Ø¬Ù† ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ùƒ', 'Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ ÙˆØ§Ù„Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©', 'Ù…Ø³Ø­ÙˆØ¨Ø§Øª Ù…Ø­Ù„ Ù‡Ø§Ù†ÙŠ'],
                'ÙÙˆØ§ØªÙŠØ± ÙˆØ®Ø¯Ù…Ø§Øª': ['Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ´Ø­Ù† Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©', 'Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª â€“ Ø¨ÙˆÙ„Ø§Ù‚', 'Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª â€“ Ø§Ù„Ø¹Ø¨ÙˆØ±', 'Ø´Ø­Ù† Ø±ØµÙŠØ¯ ÙÙˆØ±ÙŠ', 'Ø´Ø­Ù† Ù…Ø­ÙØ¸Ø©', 'Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©'],
                'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø´Ù‡Ø±ÙŠØ©': ['Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©', 'Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø©', 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©', 'Ø§Ù„Ø²ÙƒØ§Ø© ÙˆØ§Ù„ØªØ¨Ø±Ø¹Ø§Øª'],
                'Ù†Ù‚Ù„ ÙˆØµØ­Ø© ÙˆØªØ±ÙÙŠÙ‡': ['Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø·Ø¨ÙŠØ©', 'Ø§Ù„Ù…ÙˆØ§ØµÙ„Ø§Øª ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª', 'Ø§Ù„ØªØ±ÙÙŠÙ‡ ÙˆØ§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©', 'Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ÙˆØ§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ù†Ù‚Ø¯ÙŠ', 'Ù…ØµØ§Ø±ÙŠÙ Ù…ÙˆØ³Ù…ÙŠØ© ÙˆØ³Ù†ÙˆÙŠØ©', 'Ø£Ø®Ø±Ù‰'],
                'ØªØ­ÙˆÙŠÙ„Ø§Øª': ['ØªØ­ÙˆÙŠÙ„Ø§Øª']
            }
        };

        const CATEGORIES = {
            income: ['Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ', 'Ø¹Ù…Ù„ Ø­Ø±', 'Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª', 'Ø¹Ù‡Ø¯Ø© Ø´Ø±ÙƒØ© Ø¥ÙŠÙ…Ø§Ùƒ', 'ØªØ­ÙˆÙŠÙ„Ø§Øª ÙˆØ§Ø±Ø¯Ø©', 'Ø£Ø®Ø±Ù‰'],
            expense: [ 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©', 'Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø¹ÙŠØ´Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©', 'Ù…Ø³Ø­ÙˆØ¨Ø§Øª Ù…Ø­Ù„ Ù‡Ø§Ù†ÙŠ', 'Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ ÙˆØ§Ù„Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©', 'Ø§Ù„Ø²ÙƒØ§Ø© ÙˆØ§Ù„ØªØ¨Ø±Ø¹Ø§Øª', 'Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø©', 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©', 'Ø´Ø­Ù† Ø±ØµÙŠØ¯ ÙÙˆØ±ÙŠ', 'Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª â€“ Ø¨ÙˆÙ„Ø§Ù‚', 'Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª â€“ Ø§Ù„Ø¹Ø¨ÙˆØ±', 'Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ´Ø­Ù† Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©', 'Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø·Ø¨ÙŠØ©', 'Ø§Ù„Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ†', 'Ø§Ù„Ù„Ø­ÙˆÙ… ÙˆØ§Ù„Ø¯ÙˆØ§Ø¬Ù† ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ùƒ', 'Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ ÙˆØ§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„Ù†Ù‚Ø¯ÙŠ', 'Ø§Ù„ØµÙŠØ§Ù†Ø© ÙˆØ§Ù„Ø¥ØµÙ„Ø§Ø­Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©', 'Ø§Ù„Ù…ÙˆØ§ØµÙ„Ø§Øª ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª', 'Ø§Ù„ØªØ±ÙÙŠÙ‡ ÙˆØ§Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ©', 'Ù…ØµØ§Ø±ÙŠÙ Ù…ÙˆØ³Ù…ÙŠØ© ÙˆØ³Ù†ÙˆÙŠØ©', 'Ø´Ø­Ù† Ù…Ø­ÙØ¸Ø©', 'ØªØ­ÙˆÙŠÙ„Ø§Øª', 'Ø£Ø®Ø±Ù‰' ]
        };

        // --- SECURITY ---
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- ERROR BOUNDARY ---
        class ErrorBoundary extends React.Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error('Application Error:', error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col h-screen items-center justify-center bg-red-50 dark:bg-red-900/20 text-red-900 dark:text-red-100 p-8 text-center animate-fadeIn" dir="rtl">
                            <div className="w-24 h-24 bg-red-100 dark:bg-red-900/30 rounded-full flex items-center justify-center mb-6 animate-pulse"><AlertTriangle size={48} /></div>
                            <h1 className="text-3xl font-bold mb-2 text-slate-800 dark:text-white">Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ</h1>
                            <p className="mb-6 max-w-md text-sm dark:text-slate-300">ÙŠØ¨Ø¯Ùˆ Ø£Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.</p>
                            <div className="flex gap-4">
                                <button onClick={() => window.location.reload()} className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-2xl font-bold transition-all shadow-lg hover:shadow-blue-500/30 flex items-center gap-2"><RefreshCcw size={20}/> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„</button>
                                <button onClick={() => { localStorage.removeItem(STORAGE_KEY); window.location.reload(); }} className="bg-red-600 hover:bg-red-700 text-white px-8 py-4 rounded-2xl font-bold transition-all shadow-lg hover:shadow-red-500/30 flex items-center gap-2"><Trash2 size={20}/> Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
                            </div>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- REFACTORING: WALLET CONFIG ---
        const WALLET_CONFIGS = {
            fawry: { id: 'fawry', title: 'Ù…Ø­ÙØ¸Ø© ÙÙˆØ±ÙŠ', subtitle: 'ØªØªØ¨Ø¹ Ø§Ù„Ø´Ø­Ù† ÙˆØ§Ù„Ø³Ø¯Ø§Ø¯', themeColor: 'text-fawryBlue', bgColor: 'bg-yellow-50/50 dark:bg-yellow-900/10', icon: Store, headerClass: 'bg-yellow-50/50 dark:bg-yellow-900/10 text-yellow-900 dark:text-yellow-100' },
            etisalat: { id: 'etisalat', title: 'Ø³Ø¬Ù„ Ø§ØªØµØ§Ù„Ø§Øª ÙƒØ§Ø´', subtitle: 'ØªØªØ¨Ø¹ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹ ÙˆØ§Ù„Ø³Ø­Ø¨', themeColor: 'text-etisalatGreen', bgColor: 'bg-emerald-50/50 dark:bg-emerald-900/10', icon: Signal, headerClass: 'bg-emerald-50/50 dark:bg-emerald-900/10 text-emerald-900 dark:text-emerald-100' },
            cib_savings: { id: 'cib_savings', title: 'Ø³Ø¬Ù„ Ø­Ø³Ø§Ø¨ ØªÙˆÙÙŠØ± CIB', subtitle: 'ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø¬Ø§Ø±ÙŠØ©', themeColor: 'text-blue-700', bgColor: 'bg-blue-50/50 dark:bg-blue-900/10', icon: BuildingBank, headerClass: 'bg-blue-50/50 dark:bg-blue-900/10 text-blue-900 dark:text-blue-100' },
            aaib_savings: { id: 'aaib_savings', title: 'Ø³Ø¬Ù„ Ø­Ø³Ø§Ø¨ ØªÙˆÙÙŠØ± AAIB', subtitle: 'ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª ÙˆØ§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø¬Ø§Ø±ÙŠØ©', themeColor: 'text-emerald-700', bgColor: 'bg-emerald-50/50 dark:bg-emerald-900/10', icon: PiggyBank, headerClass: 'bg-emerald-50/50 dark:bg-emerald-900/10 text-emerald-900 dark:text-emerald-100' }
        };

        // âœ… REFACTORING COMPONENT: GENERIC LEDGER
        const GenericLedgerComponent = React.memo(({ 
            walletKey, 
            ledgerData, 
            isExpanded, 
            onToggle, 
            onEdit, 
            onDelete, 
            onEditTransaction,
            theme 
        }) => {
            if (!ledgerData || ledgerData.length === 0) {
                return (
                    <div className={`glass rounded-[2.5rem] overflow-hidden border border-slate-200 dark:border-slate-700 ${theme.bgClass}`}>
                        <div className={`collapsible-header p-6 flex justify-between items-center border-b border-slate-100 dark:border-slate-800 ${theme.headerClass}`} onClick={onToggle}>
                            <div className="flex items-center gap-3"><theme.icon size={28} className={theme.color} /><div><h3 className="text-xl font-black">{theme.title}</h3><p className="text-xs text-slate-500 font-bold mt-1">{theme.subtitle}</p></div></div>
                            <ChevronDown size={24} className={`text-slate-400 transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`} />
                        </div>
                    </div>
                );
            }

            return (
                <div className={`glass rounded-[2.5rem] overflow-hidden border border-slate-200 dark:border-slate-700 mb-6 ${theme.bgClass}`}>
                    <div className={`collapsible-header p-6 flex justify-between items-center border-b border-slate-100 dark:border-slate-800 ${theme.headerClass}`} onClick={onToggle}>
                        <div className="flex items-center gap-3"><theme.icon size={28} className={theme.color} /><div><h3 className="text-xl font-black">{theme.title}</h3><p className="text-xs text-slate-500 font-bold mt-1">{theme.subtitle}</p></div></div>
                        <ChevronDown size={24} className={`text-slate-400 transition-transform duration-300 ${isExpanded ? 'rotate-180' : ''}`} />
                    </div>
                    {isExpanded && (
                        <div className="overflow-x-auto animate-fadeIn p-6">
                            <table className="w-full text-right text-sm">
                                <thead className={theme.headerClass}>
                                    <tr className={`font-bold uppercase text-xs tracking-wider ${theme.color}`}>
                                        <th className="p-4 rounded-tr-2xl">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                        <th className="p-4">Ø§Ù„ÙˆØµÙ</th>
                                        <th className="p-4 text-center">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                                        <th className="p-4 text-left">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                        <th className="p-4 text-left">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø§Ø±ÙŠ</th>
                                        <th className="p-4 text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100 dark:divide-slate-800">
                                    {ledgerData.map((t, idx) => (
                                        <tr key={t.id} className={`hover:bg-white/30 dark:hover:bg-black/5 transition-colors group`}>
                                            <td className="p-4 text-slate-500 whitespace-nowrap">{t.date}</td>
                                            <td className="p-4 font-bold text-slate-800 dark:text-slate-200">{t.description || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ'}</td>
                                            <td className="p-4 text-center">
                                                <span className={`px-3 py-1 rounded-full text-xs font-bold ${t.subType === 'deposit' ? 'bg-emerald-100 text-emerald-700' : 'bg-red-100 text-red-700'}`}>
                                                    {t.subType === 'deposit' ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø³Ø­Ø¨'}
                                                </span>
                                            </td>
                                            <td className={`p-4 text-left font-black ${t.subType === 'deposit' ? 'text-emerald-600' : 'text-red-500'}`}>
                                                {t.subType === 'deposit' ? '+' : '-'}{Number(t.amount).toLocaleString()}
                                            </td>
                                            <td className={`p-4 text-left font-black bg-white/20 dark:bg-black/10 ${theme.color}`}>
                                                {t.runningBalance.toLocaleString()} Ø¬.Ù…
                                            </td>
                                            <td className="p-4 text-center">
                                                <div className="flex gap-2 justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button type="button" onClick={() => onEditTransaction(t)} className="text-blue-500 hover:bg-blue-50 p-2 rounded-lg transition-colors"><Edit size={14} /></button>
                                                    <button type="button" onClick={() => onDelete(t.id)} className="text-red-400 hover:bg-red-50 p-2 rounded-lg transition-colors"><Trash2 size={14} /></button>
                                                </div>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    )}
                </div>
            );
        });

        // âœ… NEW COMPONENT: DUPLICATE DETECTION SYSTEM
        const DuplicateDetectionSystem = ({ transactions, dispatch, addNotification, MONTHS }) => {
            const [duplicateThreshold, setDuplicateThreshold] = useState(2);
            const [selectedMonth, setSelectedMonth] = useState('ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±');
            const [expandedGroups, setExpandedGroups] = useState({});

            const detectDuplicates = useMemo(() => {
                const amountMap = {};
                const filtered = selectedMonth === 'ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±' ? transactions : transactions.filter(t => t.month === selectedMonth);
                filtered.forEach(t => {
                    const key = `${Number(t.amount)}_${t.method}_${t.category}`;
                    if (!amountMap[key]) amountMap[key] = [];
                    amountMap[key].push(t);
                });
                return Object.entries(amountMap).filter(([_, items]) => items.length >= duplicateThreshold).map(([key, items]) => ({
                    key, amount: items[0].amount, count: items.length, items, category: items[0].category,
                    risk: items.length >= 5 ? 'high' : items.length >= 3 ? 'medium' : 'low'
                }));
            }, [transactions, duplicateThreshold, selectedMonth]);

            const handleDeleteAll = () => {
                if (window.confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø©ØŸ Ø³ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù†Ø³Ø®Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø©.`)) {
                    const idsToDelete = detectDuplicates.flatMap(d => d.items.slice(1).map(i => i.id));
                    dispatch({ type: 'UPDATE_TRANSACTIONS', payload: transactions.filter(t => !idsToDelete.includes(t.id)) });
                    addNotification({ type: 'success', title: 'ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ', message: `Ø­Ø°Ù ${idsToDelete.length} Ø¹Ù…Ù„ÙŠØ© Ù…ÙƒØ±Ø±Ø©` });
                }
            };

            return (
                <div className="space-y-8 animate-fadeIn pb-20">
                    <div className="glass p-8 rounded-[2.5rem] flex justify-between items-center border-r-8 border-blue-500">
                        <div><h2 className="text-2xl font-black flex items-center gap-3"><Filter className="text-blue-500" /> ÙƒØ§Ø´Ù Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</h2><p className="text-slate-500 mt-1 text-sm font-bold">ØªØ­Ù„ÙŠÙ„ Ø°ÙƒÙŠ Ù„Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªÙƒÙˆÙ† Ø³Ø¬Ù„Øª Ù…Ø±ØªÙŠÙ† Ø¨Ø§Ù„Ø®Ø·Ø£</p></div>
                        <button onClick={handleDeleteAll} disabled={detectDuplicates.length === 0} className={`px-6 py-3 rounded-2xl font-bold transition-all flex items-center gap-2 ${detectDuplicates.length === 0 ? 'bg-slate-100 text-slate-400' : 'bg-red-600 text-white shadow-lg hover:scale-105'}`}><Trash2 size={18} /> ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¬Ù„</button>
                    </div>
                    <div className="glass p-6 rounded-[2.5rem] grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div><label className="block text-xs font-black mb-3 opacity-50 uppercase tracking-widest">Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¨Ø­Ø«</label><select className="input-field" value={selectedMonth} onChange={e => setSelectedMonth(e.target.value)}><option value="ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø´Ù‡ÙˆØ±</option>{MONTHS.map(m => <option key={m} value={m}>{m}</option>)}</select></div>
                        <div><label className="block text-xs font-black mb-3 opacity-50 uppercase tracking-widest">Ø­Ø³Ø§Ø³ÙŠØ© Ø§Ù„ÙƒØ´Ù (Ø£ÙƒØ«Ø± Ù…Ù† {duplicateThreshold} Ù…Ø±Ø§Øª)</label><input type="range" min="2" max="10" className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" value={duplicateThreshold} onChange={e => setDuplicateThreshold(Number(e.target.value))} /></div>
                    </div>
                    <div className="space-y-4">
                        {detectDuplicates.map(dup => (
                            <div key={dup.key} className="glass rounded-3xl overflow-hidden border border-slate-200 dark:border-slate-700">
                                <div className={`p-5 flex justify-between items-center cursor-pointer ${dup.risk === 'high' ? 'bg-red-50/50' : 'bg-amber-50/50'}`} onClick={() => setExpandedGroups(p => ({...p, [dup.key]: !p[dup.key]}))}>
                                    <div className="flex items-center gap-4"><div className={`p-3 rounded-2xl ${dup.risk === 'high' ? 'bg-red-100 text-red-600' : 'bg-amber-100 text-amber-600'}`}><Repeat size={24} /></div><div><h4 className="font-black text-lg">{Number(dup.amount).toLocaleString()} Ø¬.Ù…</h4><span className="text-xs font-bold opacity-60">{dup.category} - ØªÙƒØ±Ø± {dup.count} Ù…Ø±Ø§Øª</span></div></div>
                                    <ChevronDown className={`transition-transform duration-300 ${expandedGroups[dup.key] ? 'rotate-180' : ''}`} />
                                </div>
                                {expandedGroups[dup.key] && (
                                    <div className="p-4 bg-white/50 dark:bg-black/20 divide-y dark:divide-slate-800 animate-fadeIn">
                                        {dup.items.map((item, idx) => (
                                            <div key={item.id} className="py-4 flex justify-between items-center px-4">
                                                <div className="text-sm font-bold">ğŸ“… {item.date} <span className="mx-2 text-slate-300">|</span> ğŸ“ {item.description || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ'}</div>
                                                {idx !== 0 && <button onClick={() => dispatch({ type: 'UPDATE_TRANSACTIONS', payload: transactions.filter(t => t.id !== item.id) })} className="text-red-500 hover:bg-red-50 p-2 rounded-xl transition-all"><Trash2 size={16} /></button>}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- INITIAL DATA GENERATOR ---
        const getInitialData = () => {
            const loans = [
                { id: 1, name: 'Ù‚Ø±Ø¶ Ø´Ø®ØµÙŠ AAIB', totalAmount: 81532.99, prePaidAmount: 0, monthlyInstallment: 5098, dueDay: 1, interest: 'ÙŠÙ†ØªÙ‡ÙŠ Ø£Ø¨Ø±ÙŠÙ„ 2027', description: 'Ø´Ø§Ù…Ù„ Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø£Ø®ÙŠØ± (5,062)', type: 'loan', nextPaymentDate: `${CURRENT_YEAR}-02-01` },
                { id: 2, name: 'Ù…Ø¯Ø±Ø³Ø© Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù†', totalAmount: 15500, prePaidAmount: 0, monthlyInstallment: 0, dueDay: 15, interest: 'ÙŠÙ†Ø§ÙŠØ±+', description: 'Ù…Ø³ØªØ­Ù‚ ÙÙŠ ÙŠÙ†Ø§ÙŠØ± (7000)', type: 'debt', nextPaymentDate: `${CURRENT_YEAR}-02-15` },
                { id: 3, name: 'Ù…Ø¯Ø±Ø³Ø© Ø£Ù†Ø³', totalAmount: 14500, prePaidAmount: 7000, monthlyInstallment: 0, dueDay: 15, interest: 'Ø¯ÙØ¹Ø§Øª Ù…Ø±Ù†Ø©', description: 'ØªÙ… Ø³Ø¯Ø§Ø¯ 7000 Ø³Ø§Ø¨Ù‚Ø§Ù‹', type: 'debt', nextPaymentDate: `${CURRENT_YEAR}-03-15` },
                { id: 4, name: 'Ø¬Ø§Ù…Ø¹Ø© Ø³Ù„Ù…Ù‰', totalAmount: 10000, prePaidAmount: 0, monthlyInstallment: 10000, dueDay: 5, interest: `Ù…Ø³ØªØ­Ù‚ Ù…Ø§Ø±Ø³ ${CURRENT_YEAR}`, description: 'Ø¯ÙØ¹ Ø¨Ø¨Ø·Ø§Ù‚Ø© CIB', type: 'debt', nextPaymentDate: `${CURRENT_YEAR}-03-05` },
                { id: 5, name: 'Ø£Ù‚Ø³Ø§Ø· Valu - Ù…ØµØ·ÙÙ‰', totalAmount: 4444, prePaidAmount: 0, monthlyInstallment: 1111, dueDay: 5, interest: `ÙŠÙ†ØªÙ‡ÙŠ Ø£Ø¨Ø±ÙŠÙ„ ${CURRENT_YEAR}`, description: '4 Ø£Ù‚Ø³Ø§Ø·', type: 'debt', nextPaymentDate: `${CURRENT_YEAR}-02-05` },
                { id: 6, name: 'Ø£Ù‚Ø³Ø§Ø· Ø£Ø®Ø±Ù‰', totalAmount: 0, prePaidAmount: 0, monthlyInstallment: 0, dueDay: 1, interest: 'Ù…ØªÙ†ÙˆØ¹', description: 'Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø£Ø®Ø±Ù‰', type: 'debt', nextPaymentDate: '' }
            ];

            const cards = [
                { id: 1, name: 'Titanium', bank: 'CIB', limit: 37000, openingBalance: 4250, expiry: '01/29', holderName: 'AHMED M. KHALIL', last4: '1016', dueDate: '05 Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø±', type: 'mastercard', theme: 'silver' },
                { id: 2, name: 'Gold', bank: 'AAIB', limit: 13600, openingBalance: 4255, expiry: '10/26', holderName: 'AHMED M. KHALIL', last4: '0688', dueDate: '25 Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø±', type: 'visa', theme: 'gold' }
            ];

            let transactions = [];
            
            const INCOME_RULES = [
                { name: 'Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ', amount: 39975, category: 'Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ', method: 'instapay', startMonth: 0, endMonth: 11 }, 
                { name: 'Ø¹Ù…Ù„ Ø­Ø±', amount: 300, category: 'Ø¹Ù…Ù„ Ø­Ø±', method: 'cash', startMonth: 0, endMonth: 11 }, 
                { name: 'ØªØ­ÙˆÙŠÙ„ Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„', amount: 1600, category: 'ØªØ­ÙˆÙŠÙ„Ø§Øª ÙˆØ§Ø±Ø¯Ø©', method: 'instapay', startMonth: 0, endMonth: 11 }, 
                { name: 'Ø¹Ù‡Ø¯Ø© Ø´Ø±ÙƒØ© Ø¥ÙŠÙ…Ø§Ùƒ', amount: 5500, category: 'Ø¹Ù‡Ø¯Ø© Ø´Ø±ÙƒØ© Ø¥ÙŠÙ…Ø§Ùƒ', method: 'cash', startMonth: 0, endMonth: 11 }, 
                { name: 'ØªØ­ÙˆÙŠÙ„ Ù…ØµØ·ÙÙ‰', amount: 3850, category: 'ØªØ­ÙˆÙŠÙ„Ø§Øª ÙˆØ§Ø±Ø¯Ø©', method: 'cash', startMonth: 0, endMonth: 3 }, 
                { name: 'CIB Rate', amount: 50, category: 'Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª', method: 'cib_savings', startMonth: 0, endMonth: 11 }, 
                { name: 'Ø¹Ø§Ø¦Ø¯ Ø­Ø³Ø§Ø¨ ØªÙˆÙÙŠØ± AAIB', amount: 0, category: 'Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª', method: 'aaib_savings', startMonth: 0, endMonth: 11 }, 
                { name: 'Ø¹Ø§Ø¦Ø¯ Ø­Ø³Ø§Ø¨ ØªÙˆÙÙŠØ± CIB', amount: 0, category: 'Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª', method: 'cib_savings', startMonth: 0, endMonth: 11 } 
            ];

            const janSpecificIncome = [
                { name: 'Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ', amount: 39975, category: 'Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ', method: 'instapay' },
                { name: 'Ø¹Ù…Ù„ Ø­Ø±', amount: 300, category: 'Ø¹Ù…Ù„ Ø­Ø±', method: 'cash' },
                { name: 'ØªØ­ÙˆÙŠÙ„ Ø¥Ø³Ù…Ø§Ø¹ÙŠÙ„', amount: 1600, category: 'ØªØ­ÙˆÙŠÙ„Ø§Øª ÙˆØ§Ø±Ø¯Ø©', method: 'instapay' },
                { name: 'Ø¹Ù‡Ø¯Ø© Ø´Ø±ÙƒØ© Ø¥ÙŠÙ…Ø§Ùƒ', amount: 5500, category: 'Ø¹Ù‡Ø¯Ø© Ø´Ø±ÙƒØ© Ø¥ÙŠÙ…Ø§Ùƒ', method: 'cash' },
                { name: 'ØªØ­ÙˆÙŠÙ„ Ù…ØµØ·ÙÙ‰', amount: 3850, category: 'ØªØ­ÙˆÙŠÙ„Ø§Øª ÙˆØ§Ø±Ø¯Ø©', method: 'cash' },
                { name: 'ØªØ­ÙˆÙŠÙ„ Bav', amount: 7100, category: 'ØªØ­ÙˆÙŠÙ„Ø§Øª ÙˆØ§Ø±Ø¯Ø©', method: 'instapay' }, 
                { name: 'CIB Rate', amount: 50, category: 'Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª', method: 'cib_savings' }, 
                { name: 'Ø¹Ø§Ø¦Ø¯ Ø­Ø³Ø§Ø¨ ØªÙˆÙÙŠØ± AAIB', amount: 0, category: 'Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª', method: 'aaib_savings' }, 
                { name: 'Ø¹Ø§Ø¦Ø¯ Ø­Ø³Ø§Ø¨ ØªÙˆÙÙŠØ± CIB', amount: 0, category: 'Ø§Ø³ØªØ«Ù…Ø§Ø±Ø§Øª', method: 'cib_savings' } 
            ];

            janSpecificIncome.forEach((item, i) => {
                transactions.push({
                    id: `inc-jan-${i}`, type: 'income', category: item.category, amount: item.amount, quantity:1, unitPrice: item.amount, 
                    date: `${CURRENT_YEAR}-01-01`, 
                    month: 'ÙŠÙ†Ø§ÙŠØ±', method: item.method, description: item.name, status: 'paid', subType: 'deposit'
                });
            });

            MONTHS.forEach((monthName, monthIndex) => {
                if (monthIndex === 0) return; 
                INCOME_RULES.forEach(rule => {
                    if (monthIndex >= rule.startMonth && monthIndex <= rule.endMonth) {
                        transactions.push({
                            id: `inc-auto-${monthIndex}-${rule.name}`, type: 'income', category: rule.category, amount: rule.amount, quantity: 1, unitPrice: rule.amount, 
                            date: `${CURRENT_YEAR}-${String(monthIndex+1).padStart(2,'0')}-01`,
                            month: monthName, method: rule.method, description: rule.name, subType: 'deposit'
                        });
                    }
                });
            });

            MONTHS.forEach((month, index) => {
                loans.forEach(loan => {
                      if(loan.monthlyInstallment > 0) {
                        transactions.push({
                            id: `loan-auto-${loan.id}-${index}`, type: 'expense', category: 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©',
                            amount: loan.monthlyInstallment, quantity: 1, unitPrice: loan.monthlyInstallment, 
                            date: `${CURRENT_YEAR}-${String(index+1).padStart(2,'0')}-${String(loan.dueDay || 1).padStart(2, '0')}`,
                            month, method: 'instapay', description: `Ù‚Ø³Ø· ${loan.name}`, linkedLoanId: loan.id, subType: 'withdrawal'
                        });
                      }
                });
            });

            transactions.push({
                id: 'salma-uni-mar', type: 'expense', category: 'Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø©',
                amount: 10000, quantity: 1, unitPrice: 10000, 
                date: `${CURRENT_YEAR}-03-01`,
                month: 'Ù…Ø§Ø±Ø³', method: 'cib_card', description: 'Ù‚Ø³Ø· Ø¬Ø§Ù…Ø¹Ø© Ø³Ù„Ù…Ù‰', linkedCardId: 1, subType: 'withdrawal'
            });

            const janSpecifics = [
                { type: 'expense', category: 'Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø©', amount: 7000, description: 'Ù‚Ø³Ø· Ù…Ø¯Ø±Ø³Ø© Ø¹Ø¨Ø¯ Ø§Ù„Ø±Ø­Ù…Ù† (Ø¬Ø²Ø¡ 1)', method: 'cash', linkedLoanId: 2, date: `${CURRENT_YEAR}-01-15`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø´Ø­Ù† Ø±ØµÙŠØ¯ ÙÙˆØ±ÙŠ', amount: 1000, description: 'Ø´Ø­Ù† Ø±ØµÙŠØ¯ Ù„Ù„Ù…Ø±Ø§ÙÙ‚', method: 'instapay', date: `${CURRENT_YEAR}-01-01`, subType: 'deposit' },
                { type: 'expense', category: 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©', amount: 5000, description: 'Ø³Ø¯Ø§Ø¯ CIB Credit', method: 'instapay', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©', amount: 5000, description: 'Ø³Ø¯Ø§Ø¯ AAIB Credit', method: 'instapay', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø¹ÙŠØ´Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©', amount: 1540, quantity: 22, unitPrice: 70, description: 'Ù…ØµØ§Ø±ÙŠÙ Ø£Ø­Ù…Ø¯ Ù…Ø¹ÙŠØ´Ø©', method: 'cash', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ ÙˆØ§Ù„Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©', amount: 7500, description: 'Ø´Ø±Ø§Ø¡ Ù…Ù„Ø§Ø¨Ø³ Ø´ØªÙˆÙŠ', method: 'cash', date: `${CURRENT_YEAR}-01-10`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ ÙˆØ§Ù„Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©', amount: 1100, description: 'Ù…Ù„Ø§Ø¨Ø³ Ø´ØªÙˆÙŠ Ø£Ø¨Ùˆ Ø¹Ù„Ø§Ø¡', method: 'cash', date: `${CURRENT_YEAR}-01-10`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ø²ÙƒØ§Ø© ÙˆØ§Ù„ØªØ¨Ø±Ø¹Ø§Øª', amount: 1000, description: 'Ø²ÙƒØ§Ø© ØªØ­ÙˆÙŠÙ„', method: 'instapay', date: `${CURRENT_YEAR}-01-05`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ø²ÙƒØ§Ø© ÙˆØ§Ù„ØªØ¨Ø±Ø¹Ø§Øª', amount: 500, description: 'Ø²ÙƒØ§Ø© Ù†Ù‚Ø¯ÙŠ', method: 'cash', date: `${CURRENT_YEAR}-01-05`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø©', amount: 2780, description: 'Ø¯Ø±ÙˆØ³ Ø¨ÙˆØ¯Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†', method: 'instapay', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø©', amount: 800, description: 'Ø¯Ø±ÙˆØ³ Ø¨ÙˆØ¯Ø© Ù†Ù‚Ø¯ÙŠ', method: 'cash', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø©', amount: 600, description: 'Ø£Ù†Ø³ Ø¯ÙˆØ±ÙŠ', method: 'instapay', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©', amount: 1000, description: 'Ù…ØµØ±ÙˆÙ Ø³Ù„Ù…Ù‰', method: 'cash', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©', amount: 500, description: 'Ù…ØµØ±ÙˆÙ Ø¨ÙˆØ¯Ø©', method: 'cash', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©', amount: 250, description: 'Ù…ØµØ±ÙˆÙ Ø£Ù†Ø³', method: 'cash', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©', amount: 6000, description: 'Ù…ØµØ±ÙˆÙ Ø§Ù„Ø¨ÙŠØª', method: 'cash', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª â€“ Ø¨ÙˆÙ„Ø§Ù‚', amount: 475, description: 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø¨ÙˆÙ„Ø§Ù‚', method: 'fawry', date: `${CURRENT_YEAR}-01-28`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª â€“ Ø¨ÙˆÙ„Ø§Ù‚', amount: 935, description: 'Ø¥Ù†ØªØ±Ù†Øª Ø¨ÙˆÙ„Ø§Ù‚', method: 'aaib_savings', date: `${CURRENT_YEAR}-01-20`, subType: 'withdrawal' }, 
                { type: 'expense', category: 'Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª â€“ Ø§Ù„Ø¹Ø¨ÙˆØ±', amount: 100, description: 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡ Ø§Ù„Ø¹Ø¨ÙˆØ±', method: 'fawry', date: `${CURRENT_YEAR}-01-20`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª â€“ Ø§Ù„Ø¹Ø¨ÙˆØ±', amount: 28, description: 'Ù…ÙŠØ§Ù‡ Ø§Ù„Ø¹Ø¨ÙˆØ±', method: 'fawry', date: `${CURRENT_YEAR}-01-20`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª â€“ Ø§Ù„Ø¹Ø¨ÙˆØ±', amount: 23, description: 'ØºØ§Ø² Ø§Ù„Ø¹Ø¨ÙˆØ±', method: 'fawry', date: `${CURRENT_YEAR}-01-20`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ´Ø­Ù† Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©', amount: 1100, description: 'ØªÙ„ÙŠÙÙˆÙ† Ø´ÙŠÙ…Ø§Ø¡', method: 'aaib_savings', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' }, 
                { type: 'expense', category: 'Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ´Ø­Ù† Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©', amount: 120, description: 'ØªÙ„ÙŠÙÙˆÙ† Ø³Ù„Ù…Ù‰', method: 'aaib_savings', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' }, 
                { type: 'expense', category: 'Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ´Ø­Ù† Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©', amount: 120, description: 'ØªÙ„ÙŠÙÙˆÙ† Ø¨ÙˆØ¯Ø©', method: 'aaib_savings', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' }, 
                { type: 'expense', category: 'Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ´Ø­Ù† Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©', amount: 120, description: 'ØªÙ„ÙŠÙÙˆÙ† Ø£Ù†Ø³', method: 'aaib_savings', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' }, 
                { type: 'expense', category: 'Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø·Ø¨ÙŠØ©', amount: 1124, description: 'Ø¯ÙˆØ§Ø¡ Ø¬ÙŠÙ†Ø±Ø§', method: 'cib_savings', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' }, 
                { type: 'expense', category: 'Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø±Ø¹Ø§ÙŠØ© Ø§Ù„Ø·Ø¨ÙŠØ©', amount: 1350, description: 'ÙƒØ´Ù Ø³Ù„Ù…Ù‰', method: 'instapay', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' },
                { type: 'expense', category: 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©', amount: 7664, description: 'ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ Ø¥Ù†Ø³ØªØ§ (Ø¥Ø¬Ù…Ø§Ù„ÙŠ)', method: 'cash', date: `${CURRENT_YEAR}-01-01`, subType: 'withdrawal' },
            ];

            janSpecifics.forEach((item, i) => {
                transactions.push({ id: `jan-spec-${i}`, ...item, month: 'ÙŠÙ†Ø§ÙŠØ±', quantity: item.quantity || 1, unitPrice: item.unitPrice || item.amount, subType: item.subType || 'withdrawal' });
            });

            const hanyItems = [
                { d: 12, desc: 'Ø±ØµÙŠØ¯ Ù…Ø±Ø­Ù„', am: 485 }, { d: 12, desc: 'Ø¨ÙˆØ¯Ø©', am: 21 },
                { d: 13, desc: 'Ø³Ø¬Ø§Ø¦Ø±', am: 60 }, { d: 13, desc: 'Ù„Ø¨Ù†', am: 32 }, { d: 13, desc: 'Ù„Ø¨Ù†', am: 23 }, { d: 13, desc: 'Ø¨ÙŠØ¨Ø³ÙŠ', am: 35 },
                { d: 15, desc: 'Ø³Ø¬Ø§Ø¦Ø±', am: 60 }, { d: 15, desc: 'Ø¨ÙˆØ¯Ø©', am: 25 },
                { d: 16, desc: 'Ø³Ø¬Ø§Ø¦Ø±', am: 60 }, { d: 16, desc: 'Ø£Ù†Ø³', am: 15 }, { d: 16, desc: 'Ø¨ÙŠØ¨Ø³ÙŠ', am: 35 }, { d: 16, desc: 'Ø³Ø¬Ø§Ø¦Ø±', am: 70 },
                { d: 17, desc: 'Ø£Ù†Ø³', am: 11 }, { d: 17, desc: 'Ø¨ÙŠØ¨Ø³ÙŠ', am: 35 }, { d: 17, desc: 'Ø³Ø¬Ø§Ø¦Ø±', am: 70 },
                { d: 18, desc: 'Ù„Ø¨Ù†', am: 23 }, { d: 18, desc: 'Ø³Ø¬Ø§Ø¦Ø±', am: 70 }, { d: 18, desc: 'Ø´ÙŠØ¨Ø³ÙŠ', am: 10 },
                { d: 19, desc: 'Ù„Ø¨Ù†', am: 23 }, { d: 19, desc: 'Ø£Ù†Ø³', am: 20 }, { d: 19, desc: 'Ø³Ø¬Ø§Ø¦Ø±', am: 70 }, { d: 19, desc: 'Ù„Ø¨Ù†', am: 45 }, { d: 19, desc: 'Ø¨ÙŠØ¨Ø³ÙŠ', am: 35 }, { d: 19, desc: 'Ø£Ù†Ø³', am: 10 },
                { d: 20, desc: 'Ø´ÙŠØ¨Ø³ÙŠ', am: 15 }, { d: 20, desc: 'Ø¨ÙŠØ¨Ø³ÙŠ', am: 35 }, { d: 20, desc: 'Ø³Ø¬Ø§Ø¦Ø±', am: 70 }, { d: 20, desc: 'Ø´ÙŠØ¨Ø³ÙŠ', am: 20 },
                { d: 21, desc: 'Ø¹Ø¨Ø¯Ù‡', am: 50 }, { d: 21, desc: 'Ø³Ø¬Ø§Ø¦Ø±', am: 70 },
                { d: 22, desc: 'Ø¹Ø¨Ø¯Ù‡', am: 50 }, { d: 22, desc: 'Ø¹ØµÙŠØ±', am: 30 }, { d: 22, desc: 'Ø¨ÙŠØ¨Ø³ÙŠ', am: 35 }, { d: 22, desc: 'Ø³Ø¬Ø§Ø¦Ø±', am: 70 }
            ];

            const hanyExpenses = hanyItems.map((item, idx) => ({
                id: `hany-opt-${idx}`,
                type: 'expense',
                category: 'Ù…Ø³Ø­ÙˆØ¨Ø§Øª Ù…Ø­Ù„ Ù‡Ø§Ù†ÙŠ',
                amount: item.am,
                quantity: 1,
                unitPrice: item.am,
                date: `${CURRENT_YEAR}-01-${String(item.d).padStart(2, '0')}`,
                month: 'ÙŠÙ†Ø§ÙŠØ±',
                description: item.desc,
                method: 'instapay',
                subType: 'withdrawal'
            }));
            
            transactions = [...transactions, ...hanyExpenses];
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

            return { 
                transactions, 
                loans, 
                cards, 
                fawryAccount: { id: 'f1', name: 'ÙÙˆØ±ÙŠ', openingBalance: 0 }, 
                etisalatAccount: { id: 'e1', name: 'Ù…Ø­ÙØ¸Ø© Ø§ØªØµØ§Ù„Ø§Øª', openingBalance: 0 },
                savingsGoals: [], 
                recurringItems: [] 
            };
        };

        // --- STATE REDUCER ---
        const initialState = {
            data: getInitialData(),
            activeTab: 'planner', // ğŸ¯ NEW: Start with Planner to showcase it
            selectedMonth: 'ÙŠÙ†Ø§ÙŠØ±', transViewMode: 'expense', catViewType: 'expense',
            isFormOpen: false, formMode: 'add', 
            formData: { type: 'expense', subType: 'withdrawal' }, 
            activeCategoryDetail: null, repeatMonths: [],
            isLocked: false, isDarkMode: localStorage.getItem('theme') === 'dark', expandedGroup: null,
            budgets: JSON.parse(localStorage.getItem('budgets') || '{}'), editingCard: null, editingLoan: null, editingTransaction: null,
            searchTerm: '', editingBudgetCategory: null, budgetAmount: '', editingFawry: null, editingEtisalat: null,
            isRecurringModalOpen: false, recurringFormData: { title: '', amount: '', day: 1, category: 'Ø£Ø®Ø±Ù‰' },
            filterType: 'all', hidePast: false, notifications: [], isAiModalOpen: false, aiTab: 'analyze',
            aiQuery: '', aiResponse: '', isAiLoading: false,
            fawryData: JSON.parse(localStorage.getItem('fawryData')) || { id: 'f_1', name: 'Ù…Ø­ÙØ¸Ø© ÙÙˆØ±ÙŠ', openingBalance: 0 },
            etisalatData: JSON.parse(localStorage.getItem('etisalatData')) || { id: 'e_1', name: 'Ù…Ø­ÙØ¸Ø© Ø§ØªØµØ§Ù„Ø§Øª', openingBalance: 0 },
            history: [], future: [],
            expandedLedgers: { fawry: true, etisalat: true, cib_savings: true, aaib_savings: true },
            expandedCardsSection: true,
            statusFilter: 'all',
            showProjectedDebt: false,
            confirmDialog: { isOpen: false, title: '', message: '', onConfirm: null },
            isQuickTransferModalOpen: false, quickTransferData: { from: 'cash', to: 'fawry', amount: 0 },
            isBackupReminderOpen: false, // âœ… NEW: Added backup reminder state
        };

        function dataReducer(state, action) {
            switch (action.type) {
                case 'SET_DATA': return { ...state, data: action.payload };
                case 'SET_ACTIVE_TAB': return { ...state, activeTab: action.payload };
                case 'SET_SELECTED_MONTH': return { ...state, selectedMonth: action.payload };
                case 'SET_TRANS_VIEW_MODE': return { ...state, transViewMode: action.payload };
                case 'SET_CAT_VIEW_TYPE': return { ...state, catViewType: action.payload };
                case 'SET_FORM_OPEN': return { ...state, isFormOpen: action.payload };
                case 'SET_FORM_DATA': return { ...state, formData: action.payload };
                case 'SET_FORM_MODE': return { ...state, formMode: action.payload };
                case 'SET_ACTIVE_CATEGORY_DETAIL': return { ...state, activeCategoryDetail: action.payload };
                case 'SET_REPEAT_MONTHS': return { ...state, repeatMonths: action.payload };
                case 'TOGGLE_DARK_MODE': return { ...state, isDarkMode: action.payload };
                case 'SET_EXPANDED_GROUP': return { ...state, expandedGroup: action.payload };
                case 'SET_BUDGETS': return { ...state, budgets: action.payload };
                case 'SET_EDITING_CARD': return { ...state, editingCard: action.payload };
                case 'SET_EDITING_LOAN': return { ...state, editingLoan: action.payload };
                case 'SET_SEARCH_TERM': return { ...state, searchTerm: action.payload };
                case 'SET_EDITING_BUDGET_CATEGORY': return { ...state, editingBudgetCategory: action.payload };
                case 'SET_BUDGET_AMOUNT': return { ...state, budgetAmount: action.payload };
                case 'SET_EDITING_FAWRY': return { ...state, editingFawry: action.payload };
                case 'SET_EDITING_ETISALAT': return { ...state, editingEtisalat: action.payload };
                case 'SET_RECURRING_MODAL_OPEN': return { ...state, isRecurringModalOpen: action.payload };
                case 'SET_RECURRING_FORM_DATA': return { ...state, recurringFormData: action.payload };
                case 'SET_FILTER_TYPE': return { ...state, filterType: action.payload };
                case 'SET_HIDE_PAST': return { ...state, hidePast: action.payload };
                case 'SET_AI_MODAL_OPEN': return { ...state, isAiModalOpen: action.payload };
                case 'SET_AI_TAB': return { ...state, aiTab: action.payload };
                case 'SET_AI_QUERY': return { ...state, aiQuery: action.payload };
                case 'SET_AI_RESPONSE': return { ...state, aiResponse: action.payload };
                case 'SET_AI_LOADING': return { ...state, isAiLoading: action.payload };
                case 'SET_IS_LOCKED': return { ...state, isLocked: action.payload };
                case 'ADD_NOTIFICATION': return { ...state, notifications: [...state.notifications, { id: Date.now(), ...action.payload }] };
                case 'REMOVE_NOTIFICATION': return { ...state, notifications: state.notifications.filter(n => n.id !== action.payload) };
                case 'UPDATE_TRANSACTIONS': return { ...state, data: { ...state.data, transactions: action.payload } };
                case 'UPDATE_LOANS': return { ...state, data: { ...state.data, loans: action.payload } };
                case 'UPDATE_CARDS': return { ...state, data: { ...state.data, cards: action.payload } };
                case 'UPDATE_FAWRY_DATA': return { ...state, fawryData: action.payload };
                case 'UPDATE_ETISALAT_DATA': return { ...state, etisalatData: action.payload };
                case 'UPDATE_RECURRING_ITEMS': return { ...state, data: { ...state.data, recurringItems: action.payload } };
                case 'ADD_TO_HISTORY': return { ...state, history: [...state.history, action.payload], future: [] };
                case 'UNDO': 
                    if (state.history.length === 0) return state;
                    const previous = state.history[state.history.length - 1];
                    return { ...state, data: previous, history: state.history.slice(0, state.history.length - 1), future: [state.data, ...state.future] };
                case 'REDO':
                    if (state.future.length === 0) return state;
                    const next = state.future[0];
                    return { ...state, data: next, history: [...state.history, state.data], future: state.future.slice(1) };
                case 'TOGGLE_LEDGER':
                    return { 
                        ...state, 
                        expandedLedgers: { 
                            ...state.expandedLedgers, 
                            [action.payload]: !state.expandedLedgers[action.payload] 
                        } 
                    };
                case 'TOGGLE_CARDS_SECTION':
                    return { ...state, expandedCardsSection: !state.expandedCardsSection };
                case 'SET_STATUS_FILTER':
                    return { ...state, statusFilter: action.payload };
                
                case 'UPDATE_LOAN_DUE_DATE':
                    return {
                        ...state,
                        data: {
                            ...state.data,
                            loans: state.data.loans.map(loan => 
                                loan.id === action.payload.loanId 
                                ? { ...loan, nextPaymentDate: action.payload.newDate } 
                                : loan
                            )
                        }
                    };

                case 'SHOW_CONFIRM':
                    return { 
                        ...state, 
                        confirmDialog: { 
                            isOpen: true, 
                            title: action.title, 
                            message: action.message, 
                            onConfirm: action.onConfirm 
                        } 
                    };
                case 'HIDE_CONFIRM':
                    return { 
                        ...state, 
                        confirmDialog: { isOpen: false, title: '', message: '', onConfirm: null } 
                    };

                case 'SET_QUICK_TRANSFER_MODAL_OPEN':
                    return { ...state, isQuickTransferModalOpen: action.payload };
                case 'SET_QUICK_TRANSFER_DATA':
                    return { ...state, quickTransferData: { ...state.quickTransferData, ...action.payload } };
                
                // âœ… NEW CASE: Backup Reminder
                case 'SET_BACKUP_REMINDER_OPEN': 
                    return { ...state, isBackupReminderOpen: action.payload };
                    
                default: return state;
            }
        }

        const LoginScreen = ({ onLogin }) => {
            const [pin, setPin] = useState(['', '', '', '']);
            const [error, setError] = useState(false);
            const hasLegacyPin = !!localStorage.getItem('appPin');
            const hasHash = !!localStorage.getItem('appPinHash');
            const setupMode = !hasLegacyPin && !hasHash;

            const handlePinChange = async (index, value) => {
                if (value.length > 1 || !/^\d?$/.test(value)) return;
                const newPin = [...pin];
                newPin[index] = value;
                setPin(newPin);
                if (value && index < 3) { document.getElementById(`pin-${index + 1}`)?.focus(); }
                if (index === 3 && value && newPin.every(d => d !== '')) {
                    const enteredPin = newPin.join('');
                    if (enteredPin === '9999') { 
                        localStorage.removeItem('appPin'); localStorage.removeItem('appPinHash'); alert('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ø·ÙˆØ§Ø±Ø¦. Ù‚Ù… Ø¨ØªØ¹ÙŠÙŠÙ† Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ø¢Ù†.'); setPin(['', '', '', '']); setError(false); return; 
                    }
                    try {
                        if (setupMode) { const hash = await sha256(enteredPin); localStorage.setItem('appPinHash', hash); onLogin(); } 
                        else if (hasLegacyPin && !hasHash) {
                            if (enteredPin === localStorage.getItem('appPin')) { const hash = await sha256(enteredPin); localStorage.setItem('appPinHash', hash); localStorage.removeItem('appPin'); onLogin(); } 
                            else { setError(true); setTimeout(() => { setPin(['', '', '', '']); setError(false); document.getElementById('pin-0')?.focus(); }, 500); }
                        } else {
                            const hash = await sha256(enteredPin);
                            if (hash === localStorage.getItem('appPinHash')) { onLogin(); } 
                            else { setError(true); setTimeout(() => { setPin(['', '', '', '']); setError(false); document.getElementById('pin-0')?.focus(); }, 500); }
                        }
                    } catch (err) { console.error(err); setError(true); }
                }
            };
            const handleKeyDown = (e, index) => { 
                if (e.key === 'Backspace' && !pin[index] && index > 0) { document.getElementById(`pin-${index - 1}`)?.focus(); }
            };
            return (
                <div className="lock-screen bg-[radial-gradient(ellipse_at_center,_var(--tw-gradient-stops))] from-slate-900 via-slate-950 to-black animate-fadeIn">
                    <div className="bg-slate-900/50 p-8 rounded-[3rem] border border-slate-800 shadow-2xl backdrop-blur-xl flex flex-col items-center max-w-sm w-full mx-4 relative overflow-hidden">
                        <div className="absolute top-0 right-0 w-32 h-32 bg-blue-600/20 rounded-full blur-[50px] -translate-y-1/2 translate-x-1/2"></div>
                        <div className="absolute bottom-0 left-0 w-32 h-32 bg-emerald-600/20 rounded-full blur-[50px] translate-y-1/2 -translate-x-1/2"></div>
                        <div className="w-24 h-24 bg-blue-600/20 rounded-full flex items-center justify-center mb-8 shadow-glow text-blue-500 animate-bounce-slight relative z-10"><ShieldCheck size={48} /></div>
                        <h2 className="text-3xl font-black mb-2 bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent text-center relative z-10">{setupMode ? 'ØªØ¹ÙŠÙŠÙ† Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù†' : 'Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹'}</h2>
                        <p className="text-slate-400 text-sm mb-8 font-medium text-center relative z-10 opacity-80">{setupMode ? 'Ø§Ø®ØªØ± Ø±Ù…Ø²Ø§Ù‹ Ø³Ø±ÙŠØ§Ù‹ Ù…ÙƒÙˆÙ† Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…' : 'Ø£Ø¯Ø®Ù„ Ø±Ù…Ø² Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©'}</p>
                        <div className="flex gap-4 mb-8 relative z-10" dir="ltr">
                            {pin.map((digit, i) => (
                                <input 
                                    key={i} id={`pin-${i}`} type="password" inputMode="numeric" pattern="[0-9]*" value={digit} 
                                    onChange={(e) => handlePinChange(i, e.target.value)} 
                                    onKeyDown={(e) => handleKeyDown(e, i)} maxLength="1" autoComplete="off"
                                    className={`w-14 h-20 text-center text-4xl bg-slate-800/80 border-2 rounded-2xl focus:outline-none focus:border-blue-500 focus:shadow-glow transition-all duration-300 text-white ${error ? 'border-red-500 animate-pulse' : 'border-slate-700'}`} 
                                    autoFocus={i === 0} aria-label={`Ø§Ù„Ø±Ù‚Ù… ${i + 1}`} 
                                />
                            ))}
                        </div>
                        <p className="text-xs text-slate-500 text-center mt-4 relative z-10">{setupMode ? 'ØªØ°ÙƒØ± Ø§Ù„Ø±Ù…Ø² Ø¬ÙŠØ¯Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡' : 'Ù†Ø³ÙŠØª Ø§Ù„Ø±Ù…Ø²ØŸ Ø£Ø¯Ø®Ù„ 9999 Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¹ÙŠÙŠÙ†'}</p>
                    </div>
                </div>
            );
        };

        function App() {
            const [state, dispatch] = useReducer(dataReducer, initialState);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [isProcessing, setIsProcessing] = useState(false);
            const [visibleTransactions, setVisibleTransactions] = useState(15);
            const mainContentRef = useRef(null);

            const { data, activeTab, selectedMonth, transViewMode, catViewType, isFormOpen, formMode, formData, activeCategoryDetail, repeatMonths, isLocked, isDarkMode, expandedGroup, budgets, editingCard, editingLoan, editingTransaction, searchTerm, editingBudgetCategory, budgetAmount, editingFawry, editingEtisalat, isRecurringModalOpen, recurringFormData, filterType, hidePast, notifications, isAiModalOpen, aiTab, aiQuery, aiResponse, isAiLoading, fawryData, etisalatData, history, future, expandedLedgers, expandedCardsSection, statusFilter, confirmDialog, isQuickTransferModalOpen, quickTransferData, isBackupReminderOpen } = state;
            const { transactions = [], loans = [], cards = [], recurringItems = [], savingsGoals = [] } = data || {};

            //1. AUTO DATA RECOVERY & MIGRATION
            useEffect(() => {
                if (!isAuthenticated) return;
                const currentData = localStorage.getItem(STORAGE_KEY);
                const isCompressed = localStorage.getItem(STORAGE_KEY + '_IS_COMPRESSED') === 'true';
                if (currentData) {
                    try {
                        let parsed;
                        if (isCompressed) {
                            const decompressed = LZString.decompressFromUTF16(currentData);
                            parsed = JSON.parse(decompressed);
                        } else {
                            parsed = JSON.parse(currentData);
                        }
                        if (parsed.transactions && parsed.transactions.length > 0) { 
                            const migratedTransactions = parsed.transactions.map(t => {
                                let method = t.method;
                                if (method === 'cib') method = 'cib_card';
                                if (method === 'aaib') method = 'aaib_card';
                                if (!t.subType) {
                                    if (t.type === 'income') t.subType = 'deposit';
                                    else if (t.type === 'expense') {
                                        if (t.category === 'Ø´Ø­Ù† Ø±ØµÙŠØ¯ ÙÙˆØ±ÙŠ') t.subType = 'deposit';
                                        else t.subType = 'withdrawal';
                                    } else { t.subType = 'withdrawal'; }
                                }
                                if (t.category === 'Ø§Ù„Ù„Ø­ÙˆÙ… Ù„Ù„Ø¯ÙˆØ§Ø¬Ù† ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ùƒ') { t.category = 'Ø§Ù„Ù„Ø­ÙˆÙ… ÙˆØ§Ù„Ø¯ÙˆØ§Ø¬Ù† ÙˆØ§Ù„Ø£Ø³Ù…Ø§Ùƒ'; }
                                return { ...t, method, subType: t.subType };
                            });
                            dispatch({ type: 'SET_DATA', payload: { ...parsed, transactions: migratedTransactions } }); 
                            return; 
                        } 
                    } catch (e) { console.error('Data corrupted', e); }
                }
                for (const key of LEGACY_KEYS) {
                    const legacyData = localStorage.getItem(key);
                    if (legacyData) {
                        try { const parsed = JSON.parse(legacyData); if (parsed.transactions && Array.isArray(parsed.transactions)) { console.log(`Migrating data from ${key}`); dispatch({ type: 'SET_DATA', payload: parsed }); return; } } catch (e) { /* ignore */ }
                    }
                }
            }, [isAuthenticated]);

            //2. FINANCE SNAPSHOT CALCULATION
            // âœ… FIX (B): Using month indices for calculation logic
            const financeSnapshot = useMemo(() => {
                let runningBalance = Number(OPENING_SAVINGS_JAN);
                const currentMonthIndex = getMonthIndex(selectedMonth);
                
                for (let i = 0; i < currentMonthIndex; i++) {
                    const mName = MONTHS[i]; // Keep name for display/logging
                    const mIncome = transactions.filter(t => getMonthIndex(t.month) === i && t.type === 'income').reduce((a, c) => a + Number(c.amount || 0), 0);
                    const mCashExpenses = transactions.filter(t => 
                        getMonthIndex(t.month) === i && 
                        t.type === 'expense' && 
                        !['cib_card', 'aaib_card'].includes(t.method) 
                    ).reduce((a, c) => a + Number(c.amount || 0), 0);
                    runningBalance += (mIncome - mCashExpenses);
                }
                const openingSavings = runningBalance; 
                const currentMonthIncome = transactions.filter(t => getMonthIndex(t.month) === currentMonthIndex && t.type === 'income').reduce((a, c) => a + Number(c.amount || 0), 0);
                let monthlyCashExpenses = 0;
                let monthlyCreditExpenses = 0;
                transactions.filter(t => getMonthIndex(t.month) === currentMonthIndex && t.type === 'expense').forEach(t => {
                    if (['cib_card', 'aaib_card'].includes(t.method)) monthlyCreditExpenses += Number(t.amount || 0);
                    else monthlyCashExpenses += Number(t.amount || 0);
                });
                const netCashFlow = currentMonthIncome - monthlyCashExpenses;
                const projectedClosingBalance = openingSavings + netCashFlow;
                return { income: currentMonthIncome, cashExpenses: monthlyCashExpenses, creditExpenses: monthlyCreditExpenses, netCashFlow, openingSavings, projectedClosingBalance }; 
            }, [transactions, selectedMonth]);

            //3. CHART DATA CALCULATION
            const chartData = useMemo(() => MONTHS.map(m => ({
                name: m, 
                Ø¯Ø®Ù„: transactions.filter(t => t.month === m && t.type === 'income').reduce((a, c) => a + (Number(c.amount) || 0), 0),
                Ù…ØµØ±ÙˆÙ: transactions.filter(t => t.month === m && t.type === 'expense').reduce((a, c) => a + (Number(c.amount) || 0), 0)
            })), [transactions]);

            //4. UPDATED LOANS CALCULATION
            const updatedLoans = useMemo(() => {
                const map = transactions.reduce((acc, t) => {
                    if (t.linkedLoanId && (t.status === 'paid' || t.status === 'partial')) { acc[t.linkedLoanId] = (acc[t.linkedLoanId] || 0) + Number(t.amount); }
                    return acc;
                }, {});
                return loans.map(l => ({ ...l, totalPaid: (Number(l.prePaidAmount) || 0) + (map[l.id] || 0), remaining: Math.max(0, Number(l.totalAmount) - ((Number(l.prePaidAmount) || 0) + (map[l.id] || 0))) }));
            }, [transactions, loans]);

            //5. UPDATED GROUPED TRANSACTIONS (FIXED FILTER LOGIC & DATE LOGIC)
            const groupedTransactions = useMemo(() => { 
                const groups = {}; 
                const term = normalizeText(searchTerm);
                const selectedMonthIndex = getMonthIndex(selectedMonth);
                
                transactions.filter(t => {
                    // âœ… FIX (B): Safe month index comparison
                    const isMonth = getMonthIndex(t.month) === selectedMonthIndex;
                    const isType = t.type === transViewMode;
                    const isSearch = !searchTerm || 
                        normalizeText(t.description).includes(term) || 
                        normalizeText(t.category).includes(term) ||
                        normalizeText(Number(t.amount).toString()).includes(term);
                    
                    let isStatusMatch = true;
                    if (statusFilter === 'paid') {
                        isStatusMatch = t.status === 'paid';
                    } else if (statusFilter === 'pending') {
                        isStatusMatch = t.status !== 'paid';
                    }

                    if (!isMonth || !isType || !isSearch || !isStatusMatch) return false;
                    if (filterType === 'all') return true;
                    if (filterType === 'high' && Number(t.amount) >= 1000) return true;
                    if (filterType === 'cib' && (t.method === 'cib_card' || t.method === 'cib_savings')) return true;
                    if (filterType === 'aaib' && (t.method === 'aaib_card' || t.method === 'aaib_savings')) return true;
                    if (t.method === filterType) return true;
                    return false; 
                }).forEach(t => { 
                    if (!groups[t.category]) groups[t.category] = { category: t.category, total: 0, count: 0, items: [] }; 
                    groups[t.category].total += Number(t.amount); 
                    groups[t.category].count++; 
                    groups[t.category].items.push(t); 
                }); 
                return Object.values(groups).sort((a, b) => b.total - a.total).slice(0, visibleTransactions); 
            }, [transactions, selectedMonth, transViewMode, searchTerm, filterType, visibleTransactions, statusFilter]);

            const visibleStats = useMemo(() => {
                const flatItems = groupedTransactions.flatMap(g => g.items);
                const totalCount = flatItems.length;
                const totalAmount = flatItems.reduce((sum, t) => sum + Number(t.amount), 0);
                return { count: totalCount, sum: totalAmount };
            }, [groupedTransactions]);

            // --- WALLET BALANCE LOGIC ---
            
            const fawryStats = useMemo(() => {
                const deposits = transactions.filter(t => t.method === 'fawry' && t.subType === 'deposit').reduce((sum, t) => sum + Number(t.amount), 0);
                const withdrawals = transactions.filter(t => t.method === 'fawry' && t.subType === 'withdrawal').reduce((sum, t) => sum + Number(t.amount), 0);
                return { deposits, withdrawals };
            }, [transactions]);

            const currentFawryBalance = (Number(fawryData.openingBalance) || 0) + fawryStats.deposits - fawryStats.withdrawals;

            const etisalatStats = useMemo(() => {
                const deposits = transactions.filter(t => t.method === 'etisalat' && t.subType === 'deposit').reduce((sum, t) => sum + Number(t.amount), 0);
                const withdrawals = transactions.filter(t => t.method === 'etisalat' && t.subType === 'withdrawal').reduce((sum, t) => sum + Number(t.amount), 0);
                return { deposits, withdrawals };
            }, [transactions]);

            const currentEtisalatBalance = (Number(etisalatData.openingBalance) || 0) + etisalatStats.deposits - etisalatStats.withdrawals;

            // âœ… FIX (D): Robust Sorting Logic for Ledgers
            const getSavingsLedger = useCallback((methodId) => {
                const accTransactions = transactions.filter(t => t.method === methodId).sort((a, b) => new Date(a.date) - new Date(b.date));
                let runningBalance = 0;
                return accTransactions.map(t => {
                    const amount = Number(t.amount);
                    const isDeposit = t.subType === 'deposit' || (t.type === 'income' && !t.subType);
                    if (isDeposit) runningBalance += amount;
                    else runningBalance -= amount;
                    return { ...t, runningBalance };
                }).reverse(); 
            }, [transactions]);

            const fawryLedger = useMemo(() => {
                const accTransactions = transactions.filter(t => t.method === 'fawry').sort((a, b) => new Date(a.date) - new Date(b.date));
                let runningBalance = fawryData.openingBalance || 0;
                return accTransactions.map(t => {
                    const amount = Number(t.amount);
                    const isDeposit = t.subType === 'deposit';
                    if (isDeposit) runningBalance += amount;
                    else runningBalance -= amount;
                    return { ...t, runningBalance };
                }).reverse(); 
            }, [transactions, fawryData]);

            const etisalatLedger = useMemo(() => {
                const accTransactions = transactions.filter(t => t.method === 'etisalat').sort((a, b) => new Date(a.date) - new Date(b.date));
                let runningBalance = etisalatData.openingBalance || 0;
                return accTransactions.map(t => {
                    const amount = Number(t.amount);
                    const isDeposit = t.subType === 'deposit';
                    if (isDeposit) runningBalance += amount;
                    else runningBalance -= amount;
                    return { ...t, runningBalance };
                }).reverse();
            }, [transactions, etisalatData]);

            const calculateCardHistory = useCallback((card) => {
                let runningDebt = Number(card.openingBalance) || 0; 
                return MONTHS.map(m => {
                    const expenses = transactions.filter(t => 
                        t.month === m && 
                        t.type === 'expense' && 
                        ((t.method === 'cib_card' && card.bank === 'CIB') || (t.method === 'aaib_card' && card.bank === 'AAIB'))
                    ).reduce((a, b) => a + Number(b.amount), 0);

                    const payments = transactions.filter(t => 
                        t.month === m && 
                        t.category === 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©' && 
                        (t.linkedCardId === card.id || t.description?.includes(card.bank)) &&
                        !t.linkedLoanId 
                    ).reduce((a, b) => a + Number(b.amount), 0);
                    
                    const openingDebt = runningDebt;
                    runningDebt = runningDebt + expenses - payments; 
                    
                    return { 
                        month: m, 
                        openingDebt, 
                        expenses, 
                        payments, 
                        closingDebt: runningDebt, 
                        available: Number(card.limit) - runningDebt 
                    };
                });
            }, [transactions]);

            const getAgendaItems = useCallback(() => {
                try {
                    const today = new Date();
                    const currentDay = today.getDate();
                    const currentMonth = today.getMonth();
                    const currentYear = today.getFullYear();
                    const items = [];
                    if (Array.isArray(cards)) {
                        cards.forEach(card => {
                            const dueDay = parseInt(card.dueDate) || 5;
                            let targetMonth = currentMonth; 
                            let targetYear = currentYear;
                            if (dueDay < currentDay) { 
                                targetMonth++; 
                                if (targetMonth > 11) { 
                                    targetMonth = 0; 
                                    targetYear++; 
                                } 
                            }
                            const date = new Date(targetYear, targetMonth, dueDay);
                            items.push({ 
                                id: `agenda-card-${card.id}-${targetMonth}-${targetYear}`, 
                                title: `Ø³Ø¯Ø§Ø¯ Ø¨Ø·Ø§Ù‚Ø© ${card.bank}`, 
                                date: date.toISOString().split('T')[0], 
                                amount: Math.max(0, card.limit - (card.openingBalance || 0)), 
                                type: 'warning', 
                                icon: CreditCard, 
                                desc: 'Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø¯ÙˆØ±ÙŠ' 
                            });
                        });
                    }
                    if (Array.isArray(loans)) {
                        loans.forEach(loan => {
                            if (loan.monthlyInstallment > 0) {
                                const dueDay = parseInt(loan.dueDay) || 1;
                                let targetMonth = currentMonth; 
                                let targetYear = currentYear;
                                if (dueDay < currentDay) { 
                                    targetMonth++; 
                                    if (targetMonth > 11) { 
                                        targetMonth = 0; 
                                        targetYear++; 
                                    } 
                                }
                                const date = new Date(targetYear, targetMonth, dueDay);
                                items.push({ 
                                    id: `agenda-loan-${loan.id}-${targetMonth}-${targetYear}`, 
                                    title: `Ù‚Ø³Ø· ${loan.name}`, 
                                    date: date.toISOString().split('T')[0], 
                                    amount: loan.monthlyInstallment, 
                                    type: 'danger', 
                                    icon: Banknote, 
                                    desc: loan.description 
                                });
                            }
                        });
                    }
                    return items.sort((a, b) => new Date(a.date) - new Date(b.date));
                } catch (err) { console.error("Agenda Error:", err); return []; }
            }, [cards, loans, recurringItems]);
            
            const removeNotification = useCallback((id) => { dispatch({ type: 'REMOVE_NOTIFICATION', payload: id }); }, []);
            const addNotification = useCallback((notification) => {
                const exists = notifications.some(n => n.title === notification.title && n.message === notification.message);
                if (exists) return;

                const id = Date.now() + Math.random();
                dispatch({ type: 'ADD_NOTIFICATION', payload: { id, ...notification } });
                if (!notification.persistent) setTimeout(() => removeNotification(id), 6000);
            }, [notifications, removeNotification]);

            const saveHistory = useCallback(() => { dispatch({ type: 'ADD_TO_HISTORY', payload: JSON.parse(JSON.stringify(data)) }); }, [data]);
            
            // âœ… FIX (A, C): Updated Save Transaction Logic
            const handleSaveTransaction = useCallback((e) => {
                e.preventDefault(); setIsProcessing(true);
                setTimeout(() => {
                    saveHistory();
                    let finalSubType = formData.subType;
                    if (['Ø´Ø­Ù† Ø±ØµÙŠØ¯ ÙÙˆØ±ÙŠ', 'Ø´Ø­Ù† Ø±ØµÙŠØ¯', 'Ø¥ÙŠØ¯Ø§Ø¹', 'Ø´Ø­Ù† Ù…Ø­ÙØ¸Ø©'].includes(formData.category) && 
                        ['fawry', 'etisalat', 'cib_savings', 'aaib_savings'].includes(formData.method)) {
                        finalSubType = 'deposit';
                    } else {
                        finalSubType = formData.subType || (formData.type === 'income' ? 'deposit' : 'withdrawal');
                    }

                    if (formData.type === 'expense' && finalSubType === 'withdrawal') {
                        let balance = Infinity;
                        if (formData.method === 'fawry') balance = currentFawryBalance;
                        else if (formData.method === 'etisalat') balance = currentEtisalatBalance;
                        
                        if (Number(formData.amount) > balance) {
                            if (!window.confirm(`âš ï¸ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ (${balance.toLocaleString()}) ØºÙŠØ± ÙƒØ§ÙÙ. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø±ØŸ`)) {
                                setIsProcessing(false);
                                return; 
                            }
                        }
                    }

                    // âœ… FIX (C): Unique ID generation handled inside function to ensure uniqueness per loop
                    const processTransaction = (m, idOverride) => {
                        return {
                            ...formData, 
                            // âœ… CRITICAL FIX: Use crypto.randomUUID if available for true uniqueness, otherwise fallback
                            id: idOverride || (typeof crypto !== 'undefined' && crypto.randomUUID ? crypto.randomUUID() : `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`), 
                            amount: Number(formData.amount), 
                            quantity: Number(formData.quantity) || 1, 
                            unitPrice: Number(formData.unitPrice) || Number(formData.amount), 
                            month: m, 
                            // âœ… FIX (B): Add monthIndex for future logic robustness
                            monthIndex: getMonthIndex(m),
                            date: formData.date || getLocalISODate(),
                            subType: finalSubType 
                        };
                    };
                    
                    let newTransactions = [...transactions];
                    if (formMode === 'add') {
                        // Add main transaction
                        newTransactions.push(processTransaction(selectedMonth));
                        // Add recurring
                        repeatMonths.forEach(m => { 
                            newTransactions.push(processTransaction(m)); 
                        });
                    } else {
                        // Edit mode: Update existing by ID, keep original ID
                        newTransactions = newTransactions.map(t => t.id === formData.id ? processTransaction(formData.month, formData.id) : t);
                    }

                    // âœ… FIX (A): Only update loan date if adding NEW paid transaction
                    if (formMode === 'add' && formData.linkedLoanId && formData.category === 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©' && formData.status === 'paid') {
                        const targetLoan = loans.find(l => l.id === formData.linkedLoanId);
                        if (targetLoan && targetLoan.nextPaymentDate) {
                            const oldDate = new Date(targetLoan.nextPaymentDate);
                            const newDateObj = new Date(oldDate.setMonth(oldDate.getMonth() + 1));
                            const newDateStr = newDateObj.toISOString().split('T')[0];
                            
                            dispatch({
                                type: 'UPDATE_LOAN_DUE_DATE',
                                payload: { loanId: targetLoan.id, newDate: newDateStr }
                            });
                        }
                    }
                    
                    newTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    dispatch({ type: 'UPDATE_TRANSACTIONS', payload: newTransactions });
                    dispatch({ type: 'SET_FORM_OPEN', payload: false });
                    dispatch({ type: 'SET_REPEAT_MONTHS', payload: [] });
                    setVisibleTransactions(15);
                    addNotification({ type: 'success', title: formMode === 'add' ? 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­' : 'ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­' });
                    setIsProcessing(false);
                }, 500);
            }, [formData, formMode, selectedMonth, repeatMonths, transactions, saveHistory, addNotification, currentFawryBalance, currentEtisalatBalance, loans, dispatch]);

            const handleDelete = useCallback((id) => {
                dispatch({ 
                    type: 'SHOW_CONFIRM', 
                    title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù', 
                    message: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.', 
                    onConfirm: () => { 
                        saveHistory(); 
                        dispatch({ type: 'UPDATE_TRANSACTIONS', payload: transactions.filter(t => t.id !== id) }); 
                        addNotification({ type: 'success', title: 'ØªÙ… Ø§Ù„Ø­Ø°Ù', message: 'ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­' });
                    } 
                });
            }, [transactions, saveHistory, dispatch, addNotification]);

            const handleQuickTransfer = useCallback((e) => {
                e.preventDefault();
                setIsProcessing(true);
                setTimeout(() => {
                    saveHistory();
                    const amount = Number(quickTransferData.amount);
                    if (amount <= 0) {
                        addNotification({ type: 'error', title: 'Ø®Ø·Ø£', message: 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­' });
                        setIsProcessing(false);
                        return;
                    }

                    const fromTransaction = {
                        id: `qt-withdraw-${Date.now()}`,
                        type: 'expense',
                        category: 'ØªØ­ÙˆÙŠÙ„Ø§Øª',
                        amount: amount,
                        description: `ØªØ­ÙˆÙŠÙ„ Ø³Ø±ÙŠØ¹ Ø¥Ù„Ù‰ ${PAYMENT_METHODS.find(p => p.id === quickTransferData.to)?.label}`,
                        method: quickTransferData.from,
                        date: getLocalISODate(),
                        month: selectedMonth,
                        monthIndex: getMonthIndex(selectedMonth), // âœ… FIX (B)
                        subType: 'withdrawal'
                    };

                    const toTransaction = {
                        id: `qt-deposit-${Date.now()}`,
                        type: 'income',
                        category: 'ØªØ­ÙˆÙŠÙ„Ø§Øª ÙˆØ§Ø±Ø¯Ø©',
                        amount: amount,
                        description: `ØªØ­ÙˆÙŠÙ„ Ù…Ù† ${PAYMENT_METHODS.find(p => p.id === quickTransferData.from)?.label}`,
                        method: quickTransferData.to,
                        date: getLocalISODate(),
                        month: selectedMonth,
                        monthIndex: getMonthIndex(selectedMonth), // âœ… FIX (B)
                        subType: 'deposit'
                    };

                    const newTransactions = [...transactions, fromTransaction, toTransaction];
                    newTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    dispatch({ type: 'UPDATE_TRANSACTIONS', payload: newTransactions });
                    dispatch({ type: 'SET_QUICK_TRANSFER_MODAL_OPEN', payload: false });
                    dispatch({ type: 'SET_QUICK_TRANSFER_DATA', payload: { from: 'cash', to: 'fawry', amount: 0 } });
                    addNotification({ type: 'success', title: 'ØªÙ… Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­', message: `ØªÙ… ØªØ­ÙˆÙŠÙ„ ${amount.toLocaleString()} Ø¬.Ù…` });
                    setIsProcessing(false);
                }, 600);
            }, [quickTransferData, selectedMonth, transactions, saveHistory, dispatch, addNotification]);

            const handleUpdateLoan = useCallback((e) => { e.preventDefault(); saveHistory(); dispatch({ type: 'UPDATE_LOANS', payload: loans.map(l => l.id === editingLoan.id ? editingLoan : l) }); dispatch({ type: 'SET_EDITING_LOAN', payload: null }); }, [loans, editingLoan, saveHistory]);
            const handleUpdateCard = useCallback((e) => { e.preventDefault(); saveHistory(); dispatch({ type: 'UPDATE_CARDS', payload: cards.map(c => c.id === editingCard.id ? editingCard : c) }); dispatch({ type: 'SET_EDITING_CARD', payload: null }); }, [cards, editingCard, saveHistory]);
            const handleSaveBudget = useCallback(() => { saveHistory(); const newBudgets = { ...budgets, [editingBudgetCategory]: Number(budgetAmount) }; dispatch({ type: 'SET_BUDGETS', payload: newBudgets }); dispatch({ type: 'SET_EDITING_BUDGET_CATEGORY', payload: null }); dispatch({ type: 'SET_BUDGET_AMOUNT', payload: '' }); }, [budgets, editingBudgetCategory, budgetAmount, saveHistory]);
            const handleSaveRecurring = useCallback((e) => { e.preventDefault(); saveHistory(); const newItem = { ...recurringFormData, id: Date.now() }; dispatch({ type: 'UPDATE_RECURRING_ITEMS', payload: [...recurringItems, newItem] }); dispatch({ type: 'SET_RECURRING_MODAL_OPEN', payload: false }); addNotification({ type: 'success', title: 'ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©', message: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ°ÙƒÙŠØ± Ø§Ù„Ø¯ÙˆØ±ÙŠ' }); }, [recurringFormData, recurringItems, saveHistory, addNotification]);
            const deleteRecurring = useCallback((id) => { saveHistory(); dispatch({ type: 'UPDATE_RECURRING_ITEMS', payload: recurringItems.filter(i => i.id !== id) }); }, [recurringItems, saveHistory]);
            const handleUpdateFawry = useCallback((e) => { e.preventDefault(); saveHistory(); dispatch({ type: 'UPDATE_FAWRY_DATA', payload: editingFawry }); dispatch({ type: 'SET_EDITING_FAWRY', payload: null }); }, [editingFawry, saveHistory]);
            const handleUpdateEtisalat = useCallback((e) => { e.preventDefault(); saveHistory(); dispatch({ type: 'UPDATE_ETISALAT_DATA', payload: editingEtisalat }); dispatch({ type: 'SET_EDITING_ETISALAT', payload: null }); }, [editingEtisalat, saveHistory]);

            const handleExportCSV = useCallback(() => {
                const bom = "\uFEFF"; const header = "Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø§Ù„Ù†ÙˆØ¹,Ø§Ù„ÙØ¦Ø©,Ø§Ù„ÙˆØµÙ,Ø§Ù„Ù…Ø¨Ù„Øº,Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©,Ø§Ù„Ø­Ø§Ù„Ø©\n";
                const rows = transactions.map(t => `${t.date},${t.type},${t.category},"${t.description || ''}",${t.amount},${PAYMENT_METHODS.find(p=>p.id===t.method)?.label},${t.status || 'pending'}`).join("\n");
                const blob = new Blob([bom + header + rows], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `transactions_${CURRENT_YEAR}.csv`; a.click();
            }, [transactions]);
            const handleExport = useCallback(() => { const blob = new Blob([JSON.stringify({data, budgets})], {type: 'application/json'}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `finance_backup_${new Date().toISOString().split('T')[0]}.json`; a.click(); }, [data, budgets]);
            const handleImport = useCallback((e) => { const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = (evt) => { try { const parsed = JSON.parse(evt.target.result); if(parsed.data) { saveHistory(); dispatch({ type: 'SET_DATA', payload: parsed.data }); if(parsed.budgets) dispatch({ type: 'SET_BUDGETS', payload: parsed.budgets }); addNotification({ type: 'success', title: 'ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­' }); } } catch(err) { addNotification({ type: 'error', title: 'Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­' }); } }; reader.readAsText(file); }, [saveHistory, addNotification]);
            const printReport = useCallback((title, items) => {
                const w = window.open();
                const total = items.reduce((s,i)=>s+Number(i.amount),0);
                w.document.write(`<html dir="rtl"><head><title>${title}</title><link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet"><style>body{font-family:'Cairo',sans-serif;padding:40px;direction:rtl;color:#1e293b}table{width:100%;border-collapse:collapse;margin-top:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}th,td{border:1px solid #e2e8f0;padding:12px 16px;text-align:right}th{background:#f1f5f9;color:#475569;font-weight:700}tr:nth-child(even){background-color:#f8fafc}.header{text-align:center;margin-bottom:40px;border-bottom:2px solid #e2e8f0;padding-bottom:20px}.total{font-size:1.4em;font-weight:bold;margin-top:30px;text-align:left;padding:15px;background:#f1f5f9;border-radius:12px;color:#0f172a}</style></head><body><div class="header"><h1>${title}</h1><p>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${new Date().toLocaleDateString('ar-EG')}</p></div><table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>${items.map(i => `<tr><td>${i.date}</td><td>${i.category}</td><td>${i.description||'-'}</td><td>${PAYMENT_METHODS.find(p=>p.id===i.method)?.label||i.method}</td><td>${Number(i.amount).toLocaleString()} Ø¬.Ù…</td></tr>`).join('')}</tbody></table><div class="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toLocaleString()} Ø¬.Ù…</div><script>window.print();window.close();<\/script></body></html>`); w.document.close();
            }, []);
            const resetData = useCallback(() => { if(window.confirm("ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹.")) { localStorage.removeItem(STORAGE_KEY); window.location.reload(); } }, []);

            const handleAnalyzeFinances = useCallback(async () => { dispatch({ type: 'SET_AI_LOADING', payload: true }); setTimeout(() => { const totalIncome = transactions.reduce((a,c)=>c.type==='income'?a+Number(c.amount):a, 0); const totalExp = transactions.reduce((a,c)=>c.type==='expense'?a+Number(c.amount):a, 0); const ratio = Math.round((totalExp/totalIncome)*100); dispatch({ type: 'SET_AI_RESPONSE', payload: `ØªØ­Ù„ÙŠÙ„ Ø³Ø±ÙŠØ¹: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¯Ø®Ù„Ùƒ Ø§Ù„Ù…Ø³Ø¬Ù„ ${totalIncome.toLocaleString()} ÙˆÙ…ØµØ±ÙˆÙØ§ØªÙƒ ${totalExp.toLocaleString()} (${ratio}%). ÙˆØ¶Ø¹Ùƒ Ø§Ù„Ù…Ø§Ù„ÙŠ ${ratio > 90 ? 'Ø­Ø±Ø¬ØŒ ØªØ­ØªØ§Ø¬ Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ù†ÙÙ‚Ø§Øª' : 'Ø¬ÙŠØ¯ ÙˆÙ…Ø³ØªÙ‚Ø±'}.` }); dispatch({ type: 'SET_AI_LOADING', payload: false }); }, 1500); }, [transactions]);
            const handleSmartAdd = useCallback(async () => { dispatch({ type: 'SET_AI_LOADING', payload: true }); setTimeout(() => { const txt = aiQuery.toLowerCase(); let amount = txt.match(/\d+/)?.[0]; let type = (txt.includes('Ù‚Ø¨Ø¶Øª') || txt.includes('Ø§Ø®Ø¯Øª') || txt.includes('ØªØ­ÙˆÙŠÙ„ Ù„ÙŠ')) ? 'income' : 'expense'; let category = 'Ø£Ø®Ø±Ù‰'; if (txt.includes('Ø§ÙƒÙ„') || txt.includes('ØºØ¯Ø§') || txt.includes('Ø³ÙˆØ¨Ø±')) category = 'Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø¹ÙŠØ´Ø© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©'; else if (txt.includes('Ø±ØµÙŠØ¯') || txt.includes('Ø´Ø­Ù†')) category = 'Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª ÙˆØ´Ø­Ù† Ø§Ù„Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø­Ù…ÙˆÙ„Ø©'; else if (txt.includes('Ø¨Ù†Ø²ÙŠÙ†') || txt.includes('Ù…ÙˆØ§ØµÙ„Ø§Øª')) category = 'Ø§Ù„Ù…ÙˆØ§ØµÙ„Ø§Øª ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„Ø§Øª'; else if (txt.includes('Ø¯Ø±Ø³') || txt.includes('Ù…Ø¯Ø±Ø³Ø©')) category = 'Ø§Ù„ØªØ¹Ù„ÙŠÙ… ÙˆØ§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø©'; if (amount) { dispatch({ type: 'SET_FORM_MODE', payload: 'add' }); dispatch({ type: 'SET_FORM_DATA', payload: { type, category, amount: Number(amount), description: aiQuery, date: getLocalISODate(), month: selectedMonth, method: 'cash', quantity:1, unitPrice: Number(amount), subType: type === 'income' ? 'deposit' : 'withdrawal' } }); dispatch({ type: 'SET_FORM_OPEN', payload: true }); dispatch({ type: 'SET_AI_MODAL_OPEN', payload: false }); dispatch({ type: 'SET_AI_QUERY', payload: '' }); } else { dispatch({ type: 'SET_AI_RESPONSE', payload: "Ù„Ù… Ø£ØªÙ…ÙƒÙ† Ù…Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ø¨Ù„Øº. ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ù‚Ù… Ø¨ÙˆØ¶ÙˆØ­ (Ù…Ø«Ø§Ù„: 500)" }); } dispatch({ type: 'SET_AI_LOADING', payload: false }); }, 1000); }, [aiQuery, selectedMonth]);

            useEffect(() => {
                const lastBackup = localStorage.getItem('last_backup');
                const now = new Date().getTime();
                if (!lastBackup || (now - lastBackup) > 7 * 24 * 60 * 60 * 1000) {
                    addNotification({ type: 'warning', title: 'ØªØ°ÙƒÙŠØ± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ', message: 'ÙŠØ±Ø¬Ù‰ ØªØ­Ù…ÙŠÙ„ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø¶ÙŠØ§Ø¹Ù‡Ø§.', persistent: false });
                    localStorage.setItem('last_backup', now);
                }
            }, [addNotification]);
            
            useEffect(() => { 
                if (isAuthenticated) { 
                    const jsonString = JSON.stringify(data);
                    const compressed = LZString.compressToUTF16(jsonString);
                    try {
                        localStorage.setItem(STORAGE_KEY, compressed);
                        localStorage.setItem(STORAGE_KEY + '_IS_COMPRESSED', 'true');
                    } catch (e) {
                        console.error("Storage full, saving uncompressed as fallback");
                        localStorage.setItem(STORAGE_KEY, jsonString);
                    }
                } 
            }, [data, isAuthenticated]);
            
            useEffect(() => { localStorage.setItem('budgets', JSON.stringify(budgets)); }, [budgets]);
            useEffect(() => { document.documentElement.classList.toggle('dark', isDarkMode); localStorage.setItem('theme', isDarkMode ? 'dark' : 'light'); }, [isDarkMode]);
            
            useEffect(() => { 
                if (isAuthenticated && transactions.length > 0) { 
                    const today = new Date(); 
                    const currentDay = today.getDate(); 
                    const hasNotified = (msg) => notifications.some(n => n.message.includes(msg));

                    cards.forEach(card => { 
                        const dueDay = parseInt(card.dueDate.split(' ')[0]) ||1; 
                        if ((currentDay === dueDay - 1 || currentDay === dueDay) && !hasNotified(card.name)) {
                             addNotification({ type: 'warning', title: 'ğŸ“… ØªØ°ÙƒÙŠØ± Ø¨Ø§Ù„Ø³Ø¯Ø§Ø¯', message: `Ù…ÙˆØ¹Ø¯ Ø³Ø¯Ø§Ø¯ Ø¨Ø·Ø§Ù‚Ø© ${card.name} (${card.bank})`, persistent: true }); 
                        }
                    }); 
                    
                    loans.forEach(loan => { 
                        if (loan.monthlyInstallment > 0 && loan.dueDay === currentDay && !hasNotified(loan.name)) { 
                            addNotification({ type: 'warning', title: 'ğŸ“¢ ØªØ°ÙƒÙŠØ± Ù‚Ø³Ø·', message: `Ø§Ù„ÙŠÙˆÙ… Ù…ÙˆØ¹Ø¯ Ø§Ø³ØªØ­Ù‚Ø§Ù‚ ${loan.name}`, persistent: true }); 
                        } 
                    }); 
                } 
            }, [isAuthenticated, cards, loans, recurringItems, addNotification, notifications]); 

            const tickerData = useMemo(() => {
                const totalCashAvailable = financeSnapshot.projectedClosingBalance.toLocaleString();
                const totalDebtRemaining = updatedLoans.reduce((acc, loan) => acc + loan.remaining, 0).toLocaleString();
                const today = new Date();
                const gregDate = today.toLocaleDateString('ar-EG', { weekday: 'long', day: 'numeric', month: 'short' });
                const hijriDate = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', { day: 'numeric', month: 'long', year: 'numeric' }).format(today);
                return { totalCashAvailable, totalDebtRemaining, gregDate, hijriDate };
            }, [financeSnapshot, updatedLoans]);

            const ProfessionalTicker = React.memo(() => {
                const [quote] = React.useState(() => DAILY_DHIKR[Math.floor(Math.random() * DAILY_DHIKR.length)]);
                return (
                    <div className="fixed top-0 left-0 right-0 z-[2000] bg-slate-900 text-white h-8 shadow-md border-b border-white/10 flex items-center overflow-hidden">
                        <div className="bg-blue-600 h-full w-8 flex items-center justify-center z-10 shadow-lg relative flex-shrink-0">
                            <Zap size={14} className="text-white animate-pulse" />
                        </div>
                        <div className="ticker-wrap flex-1 h-full flex items-center bg-slate-800/50 overflow-hidden">
                            <div className="ticker-content text-[10px] sm:text-xs font-bold tracking-wide flex items-center h-full whitespace-nowrap pl-4 animate-[ticker-move-rtl_40s_linear_infinite]">
                                <span className="ticker-item text-blue-300 flex items-center gap-2"><span className="opacity-70">ğŸ“…</span>{tickerData.gregDate}</span>
                                <span className="text-white/20 mx-2">|</span>
                                <span className="ticker-item text-amber-300 flex items-center gap-2"><span className="opacity-70">ğŸ•Œ</span>{tickerData.hijriDate}</span>
                                <span className="text-white/20 mx-2">|</span>
                                <span className="ticker-item text-emerald-400 flex items-center gap-2"><span className="opacity-70">ğŸ’°</span>{tickerData.totalCashAvailable}</span>
                                <span className="text-white/20 mx-2">|</span>
                                <span className="ticker-item text-rose-400 flex items-center gap-2"><span className="opacity-70">âš ï¸</span>{tickerData.totalDebtRemaining}</span>
                                <span className="text-white/20 mx-2">|</span>
                                <span className="ticker-item text-cyan-300 flex items-center gap-2"><span className="opacity-70">ğŸ’</span>{quote}</span>
                                <span className="text-white/20 mx-4">âœ¦</span>
                                <span className="ticker-item text-blue-300 flex items-center gap-2"><span className="opacity-70">ğŸ“…</span>{tickerData.gregDate}</span>
                            </div>
                        </div>
                    </div>
                );
            });

            const OptimizedSummaryCard = React.memo(({ title, amount, icon: Icon, color, bgColor, subtitle, onClick }) => (
                <div onClick={onClick} className="glass p-6 rounded-[2.5rem] flex items-center justify-between hover-lift border-l-4 cursor-pointer transition-all duration-200 active:scale-[0.98]" style={{ borderLeftColor: color.replace('text-', '') }}>
                    <div className="flex-1">
                        <p className="text-slate-500 dark:text-slate-400 text-xs mb-2 font-bold uppercase tracking-wider">{title}</p>
                        <h3 className={`text-3xl font-black ${color} tracking-tight`}>
                            {Number(amount || 0).toLocaleString()} 
                            <span className="text-sm text-slate-400 font-medium mr-2">Ø¬.Ù…</span>
                        </h3>
                        {subtitle && <p className="text-[11px] text-slate-400 mt-2 font-bold opacity-80">{subtitle}</p>}
                    </div>
                    <div className={`p-4 rounded-2xl ${bgColor} dark:bg-slate-800/50 shadow-inner-glow hover-glow transition-transform hover:scale-110 duration-300`}>
                        <Icon className={`w-8 h-8 ${color}`} />
                    </div>
                </div>
            ));

            const NotificationCenter = React.memo(({ notifications, removeNotification }) => {
                if (!notifications || notifications.length === 0) return null;
                return (
                    <div className="fixed top-16 left-6 z-[3000] max-w-sm w-full space-y-3 animate-fadeInUp">
                        {notifications.map(n => (
                            <div key={n.id} className={`relative flex items-start p-4 text-white rounded-2xl shadow-xl shadow-black/10 border border-white/10 backdrop-blur-md animate-slideInRight ${n.type === 'success' ? 'bg-gradient-to-r from-emerald-500 to-emerald-600' : n.type === 'warning' ? 'bg-gradient-to-r from-amber-500 to-orange-500' : 'bg-gradient-to-r from-blue-500 to-blue-600'}`}>
                                <div className="ml-3 text-sm font-bold pr-6">
                                    <p className="font-black text-base mb-1 flex items-center gap-2">
                                        {n.type === 'success' && <CheckCircle2 size={16} />}
                                        {n.type === 'warning' && <AlertTriangle size={16} />}
                                        {n.type === 'info' && <Bell size={16} />}
                                        {n.title}
                                    </p>
                                    <p className="text-xs opacity-90 leading-relaxed">{n.message}</p>
                                </div>
                                <button type="button" onClick={() => removeNotification(n.id)} className="absolute top-3 left-3 p-1 hover:bg-white/20 rounded-full transition-colors" aria-label="Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±"><X size={16} /></button>
                            </div>
                        ))}
                    </div>
                );
            });

            const ConfirmDialog = () => {
                if (!confirmDialog.isOpen) return null;
                return (
                    <div className="fixed inset-0 z-[5000] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm animate-fadeIn p-4">
                        <div className="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2.5rem] shadow-2xl overflow-hidden animate-fadeIn border border-slate-200 dark:border-slate-700 text-center p-8">
                            <div className="w-20 h-20 bg-red-50 dark:bg-red-900/20 text-red-500 rounded-full flex items-center justify-center mx-auto mb-6 animate-pulse-slight">
                                <AlertTriangle size={40} />
                            </div>
                            <h3 className="text-2xl font-black text-slate-800 dark:text-white mb-3">{confirmDialog.title}</h3>
                            <p className="text-slate-500 dark:text-slate-400 font-medium mb-8 leading-relaxed">{confirmDialog.message}</p>
                            <div className="flex gap-4">
                                <button 
                                    onClick={() => dispatch({ type: 'HIDE_CONFIRM' })} 
                                    className="flex-1 bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 py-4 rounded-2xl font-bold hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors active:scale-95"
                                >
                                    Ø¥Ù„ØºØ§Ø¡
                                </button>
                                <button 
                                    onClick={() => { 
                                        if (confirmDialog.onConfirm) confirmDialog.onConfirm(); 
                                        dispatch({ type: 'HIDE_CONFIRM' }); 
                                    }} 
                                    className="flex-1 bg-red-500 text-white py-4 rounded-2xl font-bold shadow-lg shadow-red-500/30 hover:bg-red-600 hover:shadow-red-500/40 transition-all active:scale-95"
                                >
                                    Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderCalendarView = () => {
                const agendaItems = getAgendaItems();
                const grouped = agendaItems.reduce((acc, item) => {
                    const monthName = new Date(item.date).toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' });
                    if (!acc[monthName]) acc[monthName] = [];
                    acc[monthName].push(item);
                    return acc;
                }, {});

                return (
                    <div className="space-y-6 animate-fadeIn pb-20">
                        <div className="glass p-6 rounded-[2rem] flex justify-between items-center">
                            <h3 className="text-xl font-black flex items-center gap-3"><Calendar className="text-blue-500" /> Ø£Ø¬Ù†Ø¯Ø© Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</h3>
                        </div>
                        {Object.keys(grouped).length === 0 ? (<div className="glass p-20 text-center rounded-[2.5rem]"><p className="text-slate-400 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù‚Ø§Ø¯Ù…Ø©</p></div>) : (
                            Object.entries(grouped).map(([month, items]) => (
                                <div key={month} className="space-y-4">
                                    <h4 className="text-slate-500 font-bold mr-4 text-sm">{month}</h4>
                                    {items.map(item => {
                                        const daysLeft = calculateDaysLeft(item.date);

                                        return (
                                            <div key={item.id} className="glass p-5 rounded-3xl flex justify-between items-center shadow-sm hover:shadow-md transition-shadow">
                                                <div className="flex items-center gap-4 flex-1">
                                                    <div className={`p-3 rounded-2xl ${item.type === 'danger' ? 'bg-red-50 text-red-500' : 'bg-amber-50 text-amber-500'}`}><item.icon size={24} /></div>
                                                    <div className="flex-1">
                                                        <p className="font-bold text-slate-800 dark:text-white">{item.title}</p>
                                                        <p className={`text-[10px] font-black ${daysLeft <= 3 ? 'text-red-500 animate-pulse' : 'text-slate-400'}`}>
                                                            {daysLeft !== null ? (daysLeft > 0 ? `Ù…ØªØ¨Ù‚ÙŠ ${daysLeft} ÙŠÙˆÙ…` : daysLeft === 0 ? "ÙŠØ³ØªØ­Ù‚ Ø§Ù„ÙŠÙˆÙ…!" : "Ù…ØªØ£Ø®Ø±") : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}
                                                        </p>
                                                        <p className="text-[10px] text-slate-400">ØªØ§Ø±ÙŠØ®: {item.date}</p>
                                                    </div>
                                                </div>
                                                <div className="flex items-center gap-4">
                                                    <div className="text-left font-black text-lg text-slate-800 dark:text-white">{Number(item.amount).toLocaleString()} <span className="text-xs font-normal text-slate-400">Ø¬.Ù…</span></div>
                                                    <button 
                                                        onClick={() => {
                                                            dispatch({ type: 'SET_FORM_MODE', payload: 'add' });
                                                            dispatch({ type: 'SET_FORM_DATA', payload: { 
                                                                type: 'expense', 
                                                                amount: item.amount, 
                                                                description: item.title,
                                                                category: 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©',
                                                                date: getLocalISODate() 
                                                            }});
                                                            dispatch({ type: 'SET_FORM_OPEN', payload: true });
                                                        }}
                                                        className="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-colors active:scale-95"
                                                        title="Ø¯ÙØ¹ Ø³Ø±ÙŠØ¹"
                                                    >
                                                        <CheckCircle2 size={16} />
                                                    </button>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            ))
                        )}
                    </div>
                );
            };

            const renderDashboard = () => (
                <div className="space-y-8 animate-fadeIn">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <button 
                            onClick={() => dispatch({ type: 'SET_QUICK_TRANSFER_MODAL_OPEN', payload: true })}
                            className="col-span-2 md:col-span-4 glass p-4 rounded-2xl flex items-center justify-center gap-3 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 border-blue-200 dark:border-blue-800 hover:bg-blue-100 dark:hover:bg-blue-900/40 transition-all active:scale-95 group"
                        >
                            <div className="bg-blue-600 text-white p-2 rounded-xl group-hover:rotate-12 transition-transform"><ArrowRightLeft size={20} /></div>
                            <span className="font-bold text-blue-900 dark:text-blue-100">ØªØ­ÙˆÙŠÙ„ Ø³Ø±ÙŠØ¹ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙØ¸</span>
                        </button>
                        <button 
                             onClick={() => { dispatch({ type: 'SET_FORM_MODE', payload: 'add' }); dispatch({ type: 'SET_FORM_DATA', payload: { type: 'income', amount: '', date: getLocalISODate(), month: selectedMonth, method: 'cash', subType: 'deposit' } }); dispatch({ type: 'SET_FORM_OPEN', payload: true }); }}
                             className="glass p-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 border-emerald-200 dark:border-emerald-900 transition-all active:scale-95 group"
                        >
                            <div className="bg-emerald-500 text-white p-2 rounded-full group-hover:scale-110 transition-transform"><TrendingUp size={20} /></div>
                            <span className="text-xs font-bold text-slate-700 dark:text-slate-300">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®Ù„</span>
                        </button>
                        <button 
                             onClick={() => { dispatch({ type: 'SET_FORM_MODE', payload: 'add' }); dispatch({ type: 'SET_FORM_DATA', payload: { type: 'expense', amount: '', date: getLocalISODate(), month: selectedMonth, method: 'cash', subType: 'withdrawal' } }); dispatch({ type: 'SET_FORM_OPEN', payload: true }); }}
                             className="glass p-4 rounded-2xl flex flex-col items-center justify-center gap-2 hover:bg-red-50 dark:hover:bg-red-900/20 border-red-200 dark:border-red-900 transition-all active:scale-95 group"
                        >
                            <div className="bg-red-500 text-white p-2 rounded-full group-hover:scale-110 transition-transform"><TrendingDown size={20} /></div>
                            <span className="text-xs font-bold text-slate-700 dark:text-slate-300">ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</span>
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <OptimizedSummaryCard title="Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©" amount={financeSnapshot.projectedClosingBalance} subtitle={`Ø±ØµÙŠØ¯ Ø§Ù„ØªÙˆÙÙŠØ±: ${financeSnapshot.openingSavings.toLocaleString()}`} icon={Coins} color="text-emerald-500" bgColor="bg-emerald-500/10" />
                        <OptimizedSummaryCard title="Ù…ØµØ±ÙˆÙØ§Øª Ø§Ø¦ØªÙ…Ø§Ù†ÙŠØ© (Ø¯ÙŠÙˆÙ†)" amount={financeSnapshot.creditExpenses} subtitle="Ù…Ø³ØªØ­Ù‚Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯ Ù„Ø§Ø­Ù‚Ø§Ù‹" icon={CreditCard} color="text-amber-500" bgColor="bg-amber-500/10" />
                        <div className="glass p-6 rounded-[2.5rem] flex flex-col justify-between hover-lift border-l-4 border-blue-500 cursor-pointer transition-all active:scale-[0.98]" onClick={()=>dispatch({type:'SET_ACTIVE_TAB', payload:'planner'})}>
                            <div className="flex justify-between items-start">
                                <div><p className="text-slate-500 dark:text-slate-400 text-xs mb-2 font-bold uppercase tracking-wider">ØªÙˆÙ‚Ø¹Ø§Øª Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø±</p><h3 className={`text-3xl font-black tracking-tight ${financeSnapshot.projectedClosingBalance >= 0 ? 'text-blue-600' : 'text-red-500'}`}>{Math.round(financeSnapshot.projectedClosingBalance).toLocaleString()}<span className="text-sm text-slate-400 font-medium mr-2">Ø¬.Ù…</span></h3></div>
                                <div className="p-4 bg-blue-500/10 rounded-2xl text-blue-600 shadow-inner-glow"><TrendingUp size={28} /></div>
                            </div>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <div className="glass p-8 rounded-[2.5rem] h-[450px] relative overflow-hidden hover-lift">
                            <div className="flex justify-between items-center mb-8"><h3 className="text-xl font-bold dark:text-white flex items-center gap-3"><BarChart3 className="text-blue-500" /> Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3><div className="flex gap-2"><button className="text-xs font-bold bg-blue-100 text-blue-600 px-3 py-1 rounded-lg">{CURRENT_YEAR}</button></div></div>
                            <div className="h-[300px]"><ResponsiveContainer width="100%" height="100%"><BarChart data={chartData}><CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#e2e8f0" opacity={0.5} /><XAxis dataKey="name" stroke="#94a3b8" fontSize={12} axisLine={false} tickLine={false} dy={10} /><YAxis stroke="#94a3b8" fontSize={12} axisLine={false} tickLine={false} /><Tooltip cursor={{ fill: 'transparent' }} contentStyle={{ borderRadius: '16px', border: 'none', boxShadow: '0 10px 30px -5px rgba(0,0,0,0.1)', backgroundColor: isDarkMode ? '#1e293b' : 'white' }} formatter={(value) => `${Number(value).toLocaleString()} Ø¬.Ù…`} /><Legend wrapperStyle={{ paddingTop: '20px' }} /><Bar dataKey="Ø¯Ø®Ù„" fill="#10b981" radius={[8, 8, 8, 8]} barSize={12} /><Bar dataKey="Ù…ØµØ±ÙˆÙ" fill="#ef4444" radius={[8, 8, 8, 8]} barSize={12} /></BarChart></ResponsiveContainer></div>
                        </div>
                        <div className="glass p-8 rounded-[2.5rem] h-[450px] relative overflow-hidden hover-lift">
                            <div className="flex justify-between items-center mb-8"><h3 className="text-xl font-bold dark:text-white flex items-center gap-3"><PieChart className="text-purple-500" /> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª <span className="text-sm font-normal text-slate-500">({selectedMonth})</span></h3></div>
                            <div className="h-[300px]"><ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={transactions.filter(t => t.type === 'expense' && t.month === selectedMonth).map((t, i, arr) => { const name = t.category; const value = arr.filter(x => x.category === name).reduce((a, b) => a + Number(b.amount), 0); return { name, value }; }).filter((v, i, a) => a.findIndex(x => x.name === v.name) === i).sort((a, b) => b.value - a.value).slice(0, 5)} cx="50%" cy="45%" innerRadius={80} outerRadius={120} paddingAngle={4} dataKey="value" cornerRadius={6}>{transactions.filter(t => t.type === 'expense' && t.month === selectedMonth).map((t, i, arr) => { const name = t.category; const value = arr.filter(x => x.category === name).reduce((a, b) => a + Number(b.amount), 0); return { name, value }; }).filter((v, i, a) => a.findIndex(x => x.name === v.name) === i).sort((a, b) => b.value - a.value).slice(0, 5).map((entry, index) => (<Cell key={`cell-${index}`} fill={CATEGORY_COLORS[entry.name] || '#9ca3af'} stroke="none" />))}</Pie><Tooltip contentStyle={{ borderRadius: '16px', border: 'none', boxShadow: '0 10px 30px -5px rgba(0,0,0,0.1)', backgroundColor: isDarkMode ? '#1e293b' : 'white' }} formatter={(value) => `${Number(value).toLocaleString()} Ø¬.Ù…`} /><Legend layout="vertical" verticalAlign="middle" align="right" iconType="circle" /></PieChart></ResponsiveContainer></div>
                        </div>
                    </div>
                </div>
            );

            const renderCategoriesView = () => {
                const catTotals = transactions.filter(t => t.type === catViewType && t.month === selectedMonth).reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + Number(t.amount); return acc; }, {});
                const detailedTransactions = activeCategoryDetail ? transactions.filter(t => t.category === activeCategoryDetail && t.month === selectedMonth).sort((a,b) => new Date(b.date) - new Date(a.date)) : [];
                const detailedTotal = detailedTransactions.reduce((sum, t) => sum + Number(t.amount), 0);
                const printGlobalData = CATEGORIES[catViewType].map(cat => ({ date: selectedMonth, category: cat, description: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ¦Ø©', method: '-', amount: catTotals[cat] || 0 })).filter(i => i.amount > 0);
                return (
                    <div className="space-y-8 animate-fadeIn">
                        <div className="flex justify-between items-center glass p-3 rounded-3xl">
                            <div className="flex bg-slate-100 dark:bg-slate-800 p-1.5 rounded-2xl w-fit">
                                <button type="button" onClick={() => dispatch({ type: 'SET_CAT_VIEW_TYPE', payload: 'expense' })} className={`px-8 py-3 rounded-xl text-sm font-bold transition-all duration-300 ${catViewType === 'expense' ? 'bg-white dark:bg-slate-700 shadow-sm text-red-500' : 'text-gray-400 hover:text-gray-600'}`}>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
                                <button type="button" onClick={() => dispatch({ type: 'SET_CAT_VIEW_TYPE', payload: 'income' })} className={`px-8 py-3 rounded-xl text-sm font-bold transition-all duration-300 ${catViewType === 'income' ? 'bg-white dark:bg-slate-700 shadow-sm text-green-500' : 'text-gray-400 hover:text-gray-600'}`}>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</button>
                            </div>
                            <button type="button" onClick={() => printReport(`Ù…Ù„Ø®Øµ Ø§Ù„ÙØ¦Ø§Øª - ${catViewType === 'expense' ? 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª' : 'Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª'} - ${selectedMonth}`, printGlobalData)} className="bg-slate-100 hover:bg-slate-200 dark:bg-slate-800 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 px-6 py-3 rounded-2xl flex items-center gap-2 font-bold transition-all"><Printer size={18} /> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù„Ø®Øµ</button>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            {CATEGORIES[catViewType].map(cat => {
                                const spent = catTotals[cat] || 0; const budget = budgets[cat] || 0; const overBudget = budget > 0 && spent > budget;
                                return (
                                    <div key={cat} className="glass p-6 rounded-[2rem] relative group hover-lift cursor-pointer transition-all duration-300 hover:shadow-lg">
                                        <div className="flex justify-between mb-6">
                                            <div className="p-4 rounded-2xl bg-slate-50 dark:bg-slate-700/50 shadow-inner" style={{ color: CATEGORY_COLORS[cat] }}><Layers size={24} /></div>
                                            <div className="flex gap-2">
                                                <button type="button" onClick={(e) => { e.stopPropagation(); dispatch({ type: 'SET_ACTIVE_CATEGORY_DETAIL', payload: cat }); }} className="p-2 text-slate-300 hover:text-blue-500 transition-colors"><FileText size={20} /></button>
                                                <button type="button" onClick={(e) => { e.stopPropagation(); dispatch({ type: 'SET_EDITING_BUDGET_CATEGORY', payload: cat }); dispatch({ type: 'SET_BUDGET_AMOUNT', payload: budgets[cat] || '' }); }} className="p-2 text-slate-300 hover:text-blue-500 transition-colors"><Settings size={20} /></button>
                                            </div>
                                        </div>
                                        <h3 className="font-bold text-lg mb-1 dark:text-white">{cat}</h3>
                                        <p className="text-3xl font-black text-slate-800 dark:text-slate-100 tracking-tight">{spent.toLocaleString()}<span className="text-sm text-slate-400 font-medium"> Ø¬.Ù…</span></p>
                                        {catViewType === 'expense' && budget > 0 && (<div className="mt-6 pt-4 border-t border-slate-100 dark:border-slate-700/50"><div className="flex justify-between text-[10px] mb-2 font-bold uppercase tracking-tighter text-slate-400"><span>Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©: {budget.toLocaleString()}</span><span className={overBudget ? 'text-red-500' : 'text-emerald-500'}>{Math.round((spent / budget) * 100)}%</span></div><div className="h-2.5 bg-slate-100 dark:bg-slate-900 rounded-full overflow-hidden shadow-inner"><div style={{ width: `${Math.min(100, (spent / budget) * 100)}%` }} className={`h-full transition-all duration-1000 ${overBudget ? 'bg-gradient-to-r from-red-500 to-pink-500 shadow-[0 0 15px_rgba(239,68,68,0.5)]' : 'bg-gradient-to-r from-emerald-400 to-emerald-600'}`}></div></div></div>)}
                                    </div>
                                );
                            })}
                        </div>
                        {activeCategoryDetail && (
                            <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-[3000] backdrop-blur-xl p-4 animate-fadeIn">
                                <div className="bg-white dark:bg-slate-900 w-full max-w-4xl rounded-[2.5rem] shadow-2xl overflow-hidden border border-slate-200 dark:border-slate-700 flex flex-col max-h-[90vh]">
                                    <div className="p-8 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/30">
                                        <div><h3 className="text-3xl font-black text-slate-800 dark:text-white flex items-center gap-4"><span className="p-3 rounded-2xl bg-white dark:bg-slate-800 shadow-sm" style={{ color: CATEGORY_COLORS[activeCategoryDetail] }}><Layers size={32} /></span>{activeCategoryDetail}</h3><p className="text-sm text-slate-500 font-bold mt-2 mr-16">ØªÙØ§ØµÙŠÙ„ Ø´Ù‡Ø± {selectedMonth}</p></div>
                                        <div className="flex gap-3"><button type="button" onClick={() => printReport(`ØªÙ‚Ø±ÙŠØ± ØªÙØµÙŠÙ„ÙŠ - ${activeCategoryDetail} - ${selectedMonth}`, detailedTransactions)} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-2xl flex items-center gap-2 font-bold shadow-lg shadow-blue-500/30 active:scale-95 transition-all"><Printer size={18} /> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button><button type="button" onClick={() => dispatch({ type: 'SET_ACTIVE_CATEGORY_DETAIL', payload: null })} className="bg-slate-100 hover:bg-red-50 hover:text-red-500 text-slate-500 p-3 rounded-2xl transition-colors"><X size={24} /></button></div>
                                    </div>
                                    <div className="flex-1 overflow-y-auto p-8 scroll-hide">
                                        {detailedTransactions.length === 0 ? (
                                            <div className="text-center py-20 text-slate-400 font-bold">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>
                                        ) : (
                                            <table className="w-full text-right border-separate border-spacing-0">
                                                <thead className="text-xs text-slate-400 uppercase font-bold sticky top-0 bg-white/95 dark:bg-slate-900/95 backdrop-blur-md z-10 shadow-sm">
                                                    <tr>
                                                        <th className="px-6 py-4 border-b border-slate-100 dark:border-slate-800">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                                                        <th className="px-6 py-4 border-b border-slate-100 dark:border-slate-800">Ø§Ù„ÙˆØµÙ</th>
                                                        <th className="px-6 py-4 border-b border-slate-100 dark:border-slate-800">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</th>
                                                        <th className="px-6 py-4 border-b border-slate-100 dark:border-slate-800 text-left">Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                                        <th className="px-6 py-4 border-b border-slate-100 dark:border-slate-800 text-center">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="text-sm font-bold">
                                                    {detailedTransactions.map((t, idx) => (
                                                        <tr key={t.id} className={`transition-colors hover:bg-blue-50 dark:hover:bg-blue-900/20 group ${idx % 2 === 0 ? 'bg-transparent' : 'bg-slate-50 dark:bg-slate-800/30'}`}> 
                                                            <td className="px-6 py-4 text-slate-500 whitespace-nowrap border-b border-slate-100 dark:border-slate-800/50">{t.date}</td>
                                                            <td className="px-6 py-4 dark:text-slate-200 border-b border-slate-100 dark:border-slate-800/50">{t.description || '-'}</td>
                                                            <td className="px-6 py-4 border-b border-slate-100 dark:border-slate-800/50">
                                                                <span className="bg-white dark:bg-slate-800 px-3 py-1 rounded-lg text-xs text-blue-600 border border-slate-200 dark:border-slate-700 shadow-sm">
                                                                    {PAYMENT_METHODS.find(p => p.id === t.method)?.label}
                                                                </span>
                                                            </td>
                                                            <td className="px-6 py-4 text-left font-black text-slate-800 dark:text-white border-b border-slate-100 dark:border-slate-800/50">
                                                                {Number(t.amount).toLocaleString()}
                                                            </td>
                                                            <td className="px-6 py-4 text-center border-b border-slate-100 dark:border-slate-800/50">
                                                                <div className="flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                                    <button 
                                                                        type="button"
                                                                        onClick={(e) => { 
                                                                            e.stopPropagation();
                                                                            dispatch({ type: 'SET_FORM_MODE', payload: 'edit' }); 
                                                                            dispatch({ type: 'SET_FORM_DATA', payload: t }); 
                                                                            dispatch({ type: 'SET_FORM_OPEN', payload: true }); 
                                                                        }} 
                                                                        className="p-2 text-blue-500 hover:bg-blue-100 rounded-lg transition-colors"
                                                                        title="ØªØ¹Ø¯ÙŠÙ„"
                                                                    >
                                                                        <Edit size={16} />
                                                                    </button>
                                                                    <button 
                                                                        type="button"
                                                                        onClick={(e) => {
                                                                            e.stopPropagation();
                                                                            handleDelete(t.id)
                                                                        }} 
                                                                        className="p-2 text-red-500 hover:bg-red-100 rounded-lg transition-colors"
                                                                        title="Ø­Ø°Ù"
                                                                    >
                                                                        <Trash2 size={16} />
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        )}
                                    </div>
                                    <div className="p-8 border-t border-slate-100 dark:border-slate-800 bg-slate-50/80 dark:bg-slate-800/50 flex justify-between items-center backdrop-blur-md"><span className="text-slate-500 text-sm font-bold bg-white dark:bg-slate-700 px-4 py-2 rounded-xl shadow-sm">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª: {detailedTransactions.length}</span><div className="text-2xl font-black text-slate-800 dark:text-white">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: <span className="mr-2" style={{ color: CATEGORY_COLORS[activeCategoryDetail] }}>{detailedTotal.toLocaleString()} Ø¬.Ù…</span></div></div>
                                </div>
                            </div>
                        )}
                    </div>
                );
            };

            const renderLoansView = () => {
                const getMonthlyProjection = () => {
                    const projection = {};
                    const today = new Date();
                    for(let i =0; i<12; i++) {
                        const d = new Date(today.getFullYear(), today.getMonth() + i, 1);
                        const monthKey = d.toLocaleDateString('ar-EG', { month: 'long', year: 'numeric' });
                        projection[monthKey] = 0;
                        updatedLoans.forEach(loan => {
                            const monthsToFinish = Math.ceil(loan.remaining / (loan.monthlyInstallment ||1));
                            if(i < monthsToFinish && loan.monthlyInstallment > 0) {
                                projection[monthKey] += Number(loan.monthlyInstallment);
                            }
                        });
                    }
                    return projection;
                };

                const monthlyProjection = getMonthlyProjection();
                const totalRemaining = updatedLoans.reduce((sum, l) => sum + l.remaining, 0);
                const totalMonthlyCommitment = updatedLoans.reduce((sum, l) => sum + Number(l.monthlyInstallment), 0);

                return (
                    <div className="space-y-8 animate-fadeIn pb-24">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="bg-slate-800 text-white p-5 rounded-2xl shadow-lg hover:shadow-xl transition-shadow cursor-default">
                                <p className="text-slate-400 text-xs font-bold mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</p>
                                <p className="text-2xl font-mono font-black tracking-tighter">{totalRemaining.toLocaleString()}</p>
                            </div>
                            <div className="bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 p-5 rounded-2xl shadow-lg hover:shadow-xl transition-shadow cursor-default">
                                <p className="text-slate-500 text-xs font-bold mb-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ</p>
                                <p className="text-2xl font-mono font-black text-slate-800 dark:text-white">{totalMonthlyCommitment.toLocaleString()}</p>
                            </div>
                            <div className="col-span-2 flex">
                                 <button type="button" onClick={() => dispatch({ type: 'SET_EDITING_LOAN', payload: { id: Date.now(), name: '', totalAmount: 0, prePaidAmount: 0, monthlyInstallment: 0, dueDay: 1, description: '', type: 'loan' } })} className="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-bold flex items-center justify-center gap-2 transition-all shadow-lg shadow-blue-500/20 active:scale-95">
                                    <Plus size={20} /> ØªØ³Ø¬ÙŠÙ„ Ø¯ÙŠÙ† Ø¬Ø¯ÙŠØ¯
                                </button>
                            </div>
                        </div>

                        <div className="glass rounded-[2rem] overflow-hidden border border-slate-200 dark:border-slate-700">
                            <div className="p-6 border-b border-slate-100 dark:border-slate-800 bg-slate-50 dark:bg-slate-800/50">
                                <h3 className="font-black text-lg flex items-center gap-2">
                                    <CalendarDays className="text-blue-600" size={20} />
                                    Ø®Ø·Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©)
                                </h3>
                                <p className="text-xs text-slate-500 mt-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù†Ùƒ Ù„ÙƒÙ„ Ø´Ù‡Ø± Ù‚Ø§Ø¯Ù… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ø­Ø§Ù„ÙŠØ©.</p>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-right text-sm">
                                    <thead className="bg-slate-100 dark:bg-slate-900 text-slate-500">
                                        <tr>
                                            <th className="p-4">Ø§Ù„Ø´Ù‡Ø± / Ø§Ù„Ø³Ù†Ø©</th>
                                            <th className="p-4 text-left">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø³Ø¯Ø§Ø¯Ù‡</th>
                                            <th className="p-4 text-center">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100 dark:divide-slate-800 font-medium">
                                        {Object.entries(monthlyProjection).map(([month, amount], idx) => (
                                            <tr key={month} className={`hover:bg-blue-50/50 dark:hover:bg-slate-800/50 ${idx === 0 ? 'bg-blue-50/30' : ''}`}>
                                                <td className="p-4 font-bold text-slate-700 dark:text-slate-300">
                                                    {month} 
                                                    {idx === 0 && <span className="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded mr-2">Ø§Ù„Ø­Ø§Ù„ÙŠ</span>}
                                                </td>
                                                <td className="p-4 text-left font-mono font-bold text-slate-800 dark:text-white">
                                                    {amount > 0 ? `${amount.toLocaleString()} Ø¬.Ù…` : '-'}
                                                </td>
                                                <td className="p-4 text-center">
                                                    {amount > 0 ? 
                                                        <span className="text-xs font-bold text-amber-600 bg-amber-50 px-2 py-1 rounded">Ù…Ø³ØªØ­Ù‚</span> : 
                                                        <span className="text-xs font-bold text-emerald-600 bg-emerald-50 px-2 py-1 rounded">Ø­Ø±ÙŠØ© Ù…Ø§Ù„ÙŠØ© ğŸ‰</span>
                                                    }
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 gap-6">
                            {updatedLoans.map(loan => {
                                const isPaid = loan.remaining <= 0;
                                const percentPaid = loan.totalAmount > 0 ? (loan.totalPaid / loan.totalAmount) * 100 : 0;
                                return (
                                    <div key={loan.id} className={`glass p-0 rounded-[2rem] border overflow-hidden shadow-md ${isPaid ? 'border-emerald-200 bg-emerald-50/30' : 'border-slate-200 dark:border-slate-700'}`}>
                                        <div className="p-5 flex flex-col md:flex-row justify-between items-center gap-4 border-b border-slate-100 dark:border-slate-800">
                                            <div className="flex items-center gap-4">
                                                <div className={`p-3 rounded-xl ${isPaid ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 dark:bg-slate-800 text-slate-600'}`}>
                                                    <Banknote size={24} />
                                                </div>
                                                <div>
                                                    <h4 className="font-bold text-lg text-slate-800 dark:text-white">{loan.name}</h4>
                                                    <p className="text-xs text-slate-500 font-mono">ÙŠØ³ØªØ­Ù‚ ÙŠÙˆÙ… {loan.dueDay} Ù…Ù† ÙƒÙ„ Ø´Ù‡Ø±</p>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-6">
                                                <div className="text-center">
                                                    <p className="text-[10px] text-slate-400 font-bold uppercase">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</p>
                                                    <p className={`text-xl font-mono font-black ${isPaid ? 'text-emerald-600' : 'text-red-500'}`}>{loan.remaining.toLocaleString()}</p>
                                                </div>
                                                <div className="text-center pl-4 border-l border-slate-200 dark:border-slate-700">
                                                    <p className="text-[10px] text-slate-400 font-bold uppercase">Ø§Ù„Ù‚Ø³Ø·</p>
                                                    <p className="text-xl font-mono font-black text-slate-800 dark:text-white">{Number(loan.monthlyInstallment).toLocaleString()}</p>
                                                </div>
                                                <button type="button" onClick={() => dispatch({ type: 'SET_EDITING_LOAN', payload: loan })} className="p-2 hover:bg-slate-100 rounded-lg text-slate-400 hover:text-blue-600 transition-colors"><Edit size={18}/></button>
                                            </div>
                                        </div>
                                        
                                        <div className="p-3 bg-slate-50 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-700">
                                            <div className="flex justify-between items-center">
                                                <div className="flex items-center gap-3">
                                                    <Calendar size={14} className="text-blue-500" />
                                                    <div>
                                                        <p className="text-[10px] text-slate-500 font-bold uppercase mb-0.5">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…</p>
                                                        <input 
                                                            type="date" 
                                                            className="bg-transparent font-bold text-sm outline-none text-slate-700 dark:text-slate-200 focus:text-blue-600 transition-colors cursor-pointer border-b border-transparent focus:border-blue-500 pb-0.5"
                                                            value={loan.nextPaymentDate || ''} 
                                                            onChange={(e) => dispatch({ 
                                                                type: 'UPDATE_LOAN_DUE_DATE', 
                                                                payload: { loanId: loan.id, newDate: e.target.value } 
                                                            })}
                                                        />
                                                    </div>
                                                </div>
                                                
                                                <div className="text-right">
                                                    {loan.nextPaymentDate && (
                                                        <span className={`text-[10px] font-black px-3 py-1.5 rounded-lg inline-flex items-center gap-1 ${
                                                            (calculateDaysLeft(loan.nextPaymentDate) || 999) <= 3 
                                                            ? 'bg-red-100 text-red-600 animate-pulse' 
                                                            : 'bg-blue-50 text-blue-600'
                                                        }`}>
                                                            {(calculateDaysLeft(loan.nextPaymentDate) !== null) ? `${calculateDaysLeft(loan.nextPaymentDate)} ÙŠÙˆÙ… Ù…ØªØ¨Ù‚ÙŠ` : ''}
                                                        </span>
                                                    )}
                                                    {!loan.nextPaymentDate && (
                                                        <span className="text-[10px] text-slate-400">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ¯</span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="bg-slate-50 dark:bg-slate-800/50 p-4">
                                            <div className="flex justify-between text-[10px] mb-1 font-bold">
                                                <span>Ù†Ø³Ø¨Ø© Ø§Ù„Ø³Ø¯Ø§Ø¯</span>
                                                <span>{Math.round(percentPaid)}%</span>
                                            </div>
                                            <div className="w-full bg-slate-200 rounded-full h-1.5 dark:bg-slate-700">
                                                <div className="bg-emerald-500 h-1.5 rounded-full transition-all" 
                                                    style={{ width: `${Math.min(100, percentPaid)}%` }}>
                                                </div>
                                            </div>
                                        </div>

                                        {!isPaid && (
                                            <div className="bg-slate-50 dark:bg-slate-800/50 p-3 flex justify-end">
                                                 <button 
                                                    type="button"
                                                    onClick={() => {
                                                        dispatch({ type: 'SET_FORM_MODE', payload: 'add' });
                                                        dispatch({
                                                            type: 'SET_FORM_DATA',
                                                            payload: { type: 'expense', category: 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©', amount: loan.monthlyInstallment, description: `Ù‚Ø³Ø· ${loan.name}`, linkedLoanId: loan.id, method: 'instapay', date: getLocalISODate(), month: selectedMonth, status: 'paid', subType: 'withdrawal' }
                                                        });
                                                        dispatch({ type: 'SET_FORM_OPEN', payload: true });
                                                    }}
                                                    className="text-xs font-bold bg-white border border-slate-200 hover:bg-emerald-50 hover:text-emerald-600 hover:border-emerald-200 px-4 py-2 rounded-xl transition-all flex items-center gap-2 active:scale-95"
                                                >
                                                    <CheckCircle2 size={14}/> ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯ Ù‚Ø³Ø· Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
                                                </button>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                );
            };

            const renderWalletsAndCardsView = () => {
                const cardHistories = cards.map(card => calculateCardHistory(card));
                const cibLedger = getSavingsLedger('cib_savings');
                const aaibLedger = getSavingsLedger('aaib_savings');

                const ledgerProps = (key) => ({
                    walletKey: key,
                    ledgerData: key === 'fawry' ? fawryLedger : key === 'etisalat' ? etisalatLedger : key === 'cib_savings' ? cibLedger : aaibLedger,
                    isExpanded: expandedLedgers[key],
                    onToggle: () => dispatch({ type: 'TOGGLE_LEDGER', payload: key }),
                    onEdit: (id) => { /* Logic if needed */ },
                    onDelete: (id) => handleDelete(id),
                    onEditTransaction: (t) => { dispatch({ type: 'SET_FORM_MODE', payload: 'edit' }); dispatch({ type: 'SET_FORM_DATA', payload: t }); dispatch({ type: 'SET_FORM_OPEN', payload: true }); },
                    theme: WALLET_CONFIGS[key]
                });

                return (
                    <div className="space-y-12 animate-fadeIn">
                        <div className="glass rounded-[2.5rem] overflow-hidden border border-slate-200 dark:border-slate-700">
                            <div className="collapsible-header p-6 flex justify-between items-center border-b border-slate-100 dark:border-slate-800 bg-indigo-50/50 dark:bg-indigo-900/10" onClick={() => dispatch({ type: 'TOGGLE_CARDS_SECTION' })}>
                                <div className="flex items-center gap-3"><CreditCard size={28} className="text-indigo-600 dark:text-indigo-400" /><div><h3 className="text-xl font-black text-indigo-600 dark:text-indigo-400">Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†ÙŠØ©</h3><p className="text-xs text-slate-500 font-bold mt-1">Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙŠÙˆÙ† ÙˆØ§Ù„Ø³Ø¯Ø§Ø¯</p></div></div>
                                <ChevronDown size={24} className={`text-slate-400 transition-transform duration-300 ${expandedCardsSection ? 'rotate-180' : ''}`} />
                            </div>
                            {expandedCardsSection && (
                                <div className="p-6 animate-fadeIn">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-10">
                                        {cards.map((card, index) => {
                                            const history = cardHistories[index];
                                            const themeClasses = { silver: 'bg-gradient-to-br from-slate-700 via-slate-600 to-slate-800 shadow-slate-500/20', gold: 'bg-gradient-to-br from-yellow-600 via-yellow-500 to-yellow-700 shadow-yellow-500/20', platinum: 'bg-gradient-to-br from-slate-300 via-gray-200 to-slate-400 shadow-gray-400/20', black: 'bg-gradient-to-br from-slate-900 via-black to-slate-950 shadow-black/40', blue: 'bg-gradient-to-br from-blue-600 to-cyan-600 shadow-blue-500/30' };
                                            const themeClass = themeClasses[card.theme] || themeClasses.silver;
                                            return (
                                                <div key={card.id} className="flex flex-col gap-8">
                                                    <div className="relative group transition-transform hover:-translate-y-2 duration-300">
                                                        <button type="button" onClick={() => dispatch({ type: 'SET_EDITING_CARD', payload: card })} className="absolute -top-4 -right-4 z-20 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-2xl shadow-xl shadow-blue-500/30 transition-all hover:scale-110 active:scale-95"><Edit size={18} /></button>
                                                        <div dir="ltr" className={`p-10 rounded-[2.5rem] relative overflow-hidden shadow-2xl min-h-[280px] text-white flex flex-col justify-between ${themeClass}`}>
                                                            <div className="absolute top-0 right-0 w-64 h-64 bg-white/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                                                            <div className="flex justify-between items-start font-bold relative z-10"><span className="font-black text-2xl tracking-tighter opacity-90 uppercase">{card.bank}</span><div className="bg-white/20 p-3.5 rounded-2xl backdrop-blur-xl border border-white/10"><CreditCard size={32} /></div></div>
                                                            <div className="text-3xl font-mono tracking-[0.2em] py-6 font-bold relative z-10 text-white/90 shadow-sm">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ {card.last4}</div>
                                                            <div className="flex justify-between items-end font-bold relative z-10"><div className="flex flex-col"><span className="text-[9px] uppercase opacity-60 mb-1 tracking-[0.2em]">Card Holder</span><span className="font-bold text-base tracking-widest">{card.holderName}</span></div><div className="flex flex-col items-end"><span className="text-[9px] uppercase opacity-60 mb-1 tracking-[0.2em]">Expires</span><span className="font-bold text-base tracking-widest">{card.expiry}</span></div></div>
                                                        </div>
                                                    </div>
                                                    <div className="glass rounded-[2rem] overflow-hidden shadow-md"><table className="w-full text-right text-xs"><thead className="bg-slate-50/80 dark:bg-slate-800/80 backdrop-blur-sm"><tr><th className="p-4 text-slate-500 font-bold">Ø§Ù„Ø´Ù‡Ø±</th><th className="p-4 text-red-500 font-bold">Ø§Ù„Ø¯ÙŠÙ† (Ø£ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø©)</th><th className="p-4 text-amber-500 font-bold">Ù…ØµØ§Ø±ÙŠÙ</th><th className="p-4 text-emerald-500 font-bold">Ø³Ø¯Ø§Ø¯</th><th className="p-4 text-blue-500 font-bold">Ø§Ù„Ù…ØªØ§Ø­</th></tr></thead><tbody className="divide-y divide-slate-100 dark:divide-slate-800 font-bold">{history.map((h, idx) => { const isFuture = MONTHS.indexOf(h.month) > MONTHS.indexOf(selectedMonth); return (<tr key={idx} className={`${h.month === selectedMonth ? 'bg-blue-50/50 dark:bg-blue-900/10 border-l-4 border-blue-500' : ''} ${isFuture ? 'opacity-40 grayscale' : 'hover:bg-slate-50 dark:hover:bg-slate-800/50'}`}><td className="p-4 font-bold">{h.month}</td><td className="p-4 text-red-500">{Math.round(h.openingDebt).toLocaleString()}</td><td className="p-4 text-amber-500">{Math.round(h.expenses).toLocaleString()}</td><td className="p-4 text-emerald-500">{Math.round(h.payments).toLocaleString()}</td><td className="p-4 text-blue-500 font-black">{Math.round(h.available).toLocaleString()}</td></tr>); })}</tbody></table></div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="relative group"><button type="button" onClick={() => dispatch({ type: 'SET_EDITING_FAWRY', payload: fawryData })} className="absolute -top-3 -right-3 z-20 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-2xl shadow-xl shadow-blue-500/30 transition-all hover:scale-110 active:scale-95 font-bold"><Edit size={18} /></button><div className="bg-fawryYellow p-8 rounded-[2.5rem] flex flex-col justify-between shadow-lg h-full text-fawryBlue hover-lift cursor-pointer transition-transform" onClick={() => dispatch({ type: 'SET_EDITING_FAWRY', payload: fawryData })}><div className="flex justify-between items-start mb-6"><div className="flex items-center gap-4"><div className="bg-white p-3 rounded-2xl shadow-sm"><Store size={32} className="text-fawryBlue" /></div><div><h3 className="font-black text-2xl">Ù…Ø­ÙØ¸Ø© ÙÙˆØ±ÙŠ</h3><p className="text-sm font-bold opacity-80">Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</p></div></div><div className="text-left flex flex-col items-end"><span className="block text-xs uppercase font-bold mb-1 tracking-widest opacity-60">Ø§Ù„Ø±ØµÙŠØ¯</span><span className="font-black text-4xl group-hover:scale-105 transition-transform">{currentFawryBalance.toLocaleString()}</span></div></div><div className="grid grid-cols-2 gap-3 w-full font-bold mt-auto"><div className="bg-white/50 backdrop-blur-sm p-3 rounded-xl border border-white/40 text-center shadow-inner"><span className="block text-[10px] mb-1">Ø¥ÙŠØ¯Ø§Ø¹</span><span className="font-bold text-lg">+{fawryStats.deposits.toLocaleString()}</span></div><div className="bg-white/50 backdrop-blur-sm p-3 rounded-xl border border-white/40 text-center shadow-inner"><span className="block text-[10px] mb-1">Ø³Ø­Ø¨</span><span className="font-bold text-lg">-{fawryStats.withdrawals.toLocaleString()}</span></div></div></div></div>
                            <div className="relative group"><button type="button" onClick={() => dispatch({ type: 'SET_EDITING_ETISALAT', payload: etisalatData })} className="absolute -top-3 -right-3 z-20 bg-white hover:bg-slate-100 text-etisalatGreen p-3 rounded-2xl shadow-xl transition-all hover:scale-110 active:scale-95 font-bold"><Edit size={18} /></button><div className="bg-gradient-to-r from-etisalatGreen to-emerald-600 p-8 rounded-[2.5rem] flex flex-col justify-between shadow-lg h-full text-white relative overflow-hidden hover-lift cursor-pointer transition-transform" onClick={() => dispatch({ type: 'SET_EDITING_ETISALAT', payload: etisalatData })}><div className="absolute top-0 right-0 bg-etisalatRed w-24 h-24 rounded-bl-[4rem] z-0 shadow-lg"></div><div className="flex justify-between items-start mb-6 z-10 relative"><div className="flex items-center gap-4"><div className="bg-white p-3 rounded-2xl shadow-lg"><Signal size={32} className="text-etisalatGreen" /></div><div><h3 className="font-black text-2xl">Ø§ØªØµØ§Ù„Ø§Øª ÙƒØ§Ø´</h3><p className="text-sm font-bold opacity-80">e& wallet</p></div></div><div className="text-left flex flex-col items-end z-10 relative"><span className="block text-xs uppercase font-bold mb-1 tracking-widest opacity-80">Ø§Ù„Ø±ØµÙŠØ¯</span><span className="font-black text-4xl group-hover:scale-105 transition-transform">{currentEtisalatBalance.toLocaleString()}</span></div></div><div className="grid grid-cols-2 gap-3 w-full font-bold mt-auto z-10 relative"><div className="bg-white/20 backdrop-blur-md p-3 rounded-xl border border-white/10 text-center shadow-sm"><span className="block text-[10px] mb-1 opacity-80">Ø¥ÙŠØ¯Ø§Ø¹</span><span className="font-bold text-lg">+{etisalatStats.deposits.toLocaleString()}</span></div><div className="bg-white/20 backdrop-blur-md p-3 rounded-xl border border-white/10 text-center shadow-sm"><span className="block text-[10px] mb-1 opacity-80">Ø³Ø­Ø¨</span><span className="font-bold text-lg">-{etisalatStats.withdrawals.toLocaleString()}</span></div></div></div></div>
                        </div>

                        <GenericLedgerComponent {...ledgerProps('fawry')} />
                        <GenericLedgerComponent {...ledgerProps('etisalat')} />
                        <GenericLedgerComponent {...ledgerProps('cib_savings')} />
                        <GenericLedgerComponent {...ledgerProps('aaib_savings')} />
                    </div>
                );
            };

            const renderTransactionsViewFull = () => (
                <div className="space-y-8 animate-fadeIn">
                    <div className="glass p-2 rounded-2xl w-fit mx-auto mb-8 flex">
                        <button type="button" onClick={() => dispatch({ type: 'SET_TRANS_VIEW_MODE', payload: 'expense' })} className={`px-12 py-4 rounded-xl text-lg font-bold transition-all duration-300 flex items-center gap-3 ${transViewMode === 'expense' ? 'bg-red-50 text-red-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}><TrendingDown size={24} /> Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
                        <button type="button" onClick={() => dispatch({ type: 'SET_TRANS_VIEW_MODE', payload: 'income' })} className={`px-12 py-4 rounded-xl text-lg font-bold transition-all duration-300 flex items-center gap-3 ${transViewMode === 'income' ? 'bg-emerald-50 text-emerald-600 shadow-sm' : 'text-slate-400 hover:text-slate-600'}`}><TrendingUp size={24} /> Ø§Ù„Ø¯Ø®Ù„</button>
                    </div>
                    <div className="glass p-4 rounded-3xl overflow-x-auto"><div className="flex gap-3 pb-2 scroll-hide snap-x">{MONTHS.map(m => (<button key={m} type="button" onClick={() => dispatch({ type: 'SET_SELECTED_MONTH', payload: m })} className={`flex-shrink-0 px-8 py-3 rounded-2xl text-sm font-bold transition-all duration-300 ${selectedMonth === m ? 'bg-slate-900 text-white shadow-lg scale-105' : 'bg-slate-50 text-slate-500 hover:bg-slate-200'}`}>{m}</button>))}</div></div>
                    
                    <div className="flex gap-2 justify-center flex-wrap px-2 mb-4">
                        <button type="button" onClick={() => dispatch({ type: 'SET_STATUS_FILTER', payload: 'all' })} className={`px-3 py-1.5 rounded-xl text-[11px] font-bold transition-all border border-slate-200 dark:border-slate-700 flex items-center gap-1 ${statusFilter === 'all' ? 'bg-slate-800 text-white shadow-md' : 'bg-white dark:bg-slate-800 text-slate-500'}`}><Filter size={12}/> Ø§Ù„ÙƒÙ„</button>
                        <button type="button" onClick={() => dispatch({ type: 'SET_STATUS_FILTER', payload: 'pending' })} className={`px-3 py-1.5 rounded-xl text-[11px] font-bold transition-all border border-slate-200 dark:border-slate-700 flex items-center gap-1 ${statusFilter === 'pending' ? 'bg-amber-500 text-white shadow-md' : 'bg-white dark:bg-slate-800 text-slate-500'}`}><Clock size={12}/> Ù…Ø¹Ù„Ù‚</button>
                        <button type="button" onClick={() => dispatch({ type: 'SET_STATUS_FILTER', payload: 'paid' })} className={`px-3 py-1.5 rounded-xl text-[11px] font-bold transition-all border border-slate-200 dark:border-slate-700 flex items-center gap-1 ${statusFilter === 'paid' ? 'bg-emerald-500 text-white shadow-md' : 'bg-white dark:bg-slate-800 text-slate-500'}`}><CheckCircle2 size={12}/> Ù…Ø¯ÙÙˆØ¹</button>
                    </div>

                    <div className="flex gap-2 flex-wrap justify-center px-2 mb-6">
                        <button type="button" onClick={() => dispatch({ type: 'SET_FILTER_TYPE', payload: 'all' })} className={`px-3 py-1.5 rounded-xl text-[11px] font-bold transition-all border ${filterType === 'all' ? 'bg-slate-800 text-white shadow-md scale-105' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500'}`}>Ø§Ù„ÙƒÙ„</button>
                        {PAYMENT_METHODS.map(method => (
                            <button key={method.id} type="button" onClick={() => dispatch({ type: 'SET_FILTER_TYPE', payload: method.id })} className={`px-3 py-1.5 rounded-xl text-[11px] font-bold transition-all border whitespace-nowrap ${filterType === method.id ? 'bg-blue-600 border-blue-600 text-white shadow-md scale-105' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500 hover:border-blue-300'}`}>{method.label}</button>
                        ))}
                        <button type="button" onClick={() => dispatch({ type: 'SET_FILTER_TYPE', payload: 'high' })} className={`px-3 py-1.5 rounded-xl text-[11px] font-bold transition-all border ${filterType === 'high' ? 'bg-orange-500 border-orange-500 text-white shadow-md scale-105' : 'bg-white dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-500 hover:border-orange-300'}`}>Ù…Ø¨Ø§Ù„Øº ÙƒØ¨ÙŠØ±Ø©</button>
                    </div>

                    <div className="glass p-4 rounded-3xl"><div className="relative"><Search className="absolute right-4 top-1/2 transform -translate-y-1/2 text-slate-400" size={20} /><input type="text" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª..." className="w-full p-4 pr-12 bg-transparent border-0 focus:outline-none text-lg" value={searchTerm} onChange={(e) => dispatch({ type: 'SET_SEARCH_TERM', payload: e.target.value })} /></div></div>
                    
                    <div className="glass rounded-[2.5rem] overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="w-full text-right text-sm">
                                <thead className="bg-slate-50/80 dark:bg-slate-800/50 backdrop-blur-sm"><tr><th className="p-6 font-bold text-slate-400 text-xs uppercase tracking-widest">Ø¥Ø¬Ø±Ø§Ø¡</th><th className="p-6 font-bold text-slate-400 text-xs uppercase tracking-widest">Ø§Ù„Ø¨Ù†Ø¯ / Ø§Ù„ÙØ¦Ø©</th><th className="p-6 font-bold text-slate-400 text-center uppercase tracking-widest text-xs">Ø§Ù„Ø¹Ø¯Ø¯</th><th className="p-6 font-bold text-slate-400 text-left uppercase tracking-widest text-xs">Ø§Ù„Ù…Ø¨Ù„Øº</th><th className="p-6 text-center font-bold text-slate-400 uppercase tracking-widest text-xs">ØªØ¹Ø¯ÙŠÙ„</th></tr></thead>
                                <tbody className="divide-y divide-slate-100 dark:divide-slate-800 font-bold">
                                    {groupedTransactions.map(g => (
                                        <React.Fragment key={g.category}>
                                            <tr className="hover:bg-slate-50 dark:hover:bg-slate-800/30 cursor-pointer transition-colors" onClick={() => dispatch({ type: 'SET_EXPANDED_GROUP', payload: expandedGroup === g.category ? null : g.category })}>
                                                <td className="p-6 text-center"><div className={`p-2 rounded-full transition-transform ${expandedGroup === g.category ? 'bg-blue-50 text-blue-500 rotate-180' : 'bg-slate-50 text-slate-400'}`}><ChevronDown size={16} /></div></td>
                                                <td className="p-6 font-bold flex items-center gap-4 text-slate-700 dark:text-slate-200"><span className="p-3 rounded-2xl shadow-sm" style={{ backgroundColor: `${CATEGORY_COLORS[g.category]}20`, color: CATEGORY_COLORS[g.category] }}><Layers size={20} /></span>{g.category}</td>
                                                <td className="p-6 text-center text-slate-400">{g.count}</td>
                                                <td className={`p-6 font-black text-left text-lg tracking-tight ${transViewMode === 'income' ? 'text-emerald-500' : 'text-slate-700 dark:text-white'}`}>{g.total.toLocaleString()}</td>
                                                <td className="p-6 text-center"></td>
                                            </tr>
                                            {expandedGroup === g.category && g.items.map(t => (
                                                <tr key={t.id} className="bg-slate-50/50 dark:bg-slate-900/30 text-xs animate-fadeIn border-l-4 border-l-blue-500">
                                                    <td className="py-4 text-center"><button type="button" onClick={(e) => { e.stopPropagation(); const current = t.status || 'pending'; const next = current === 'pending' ? 'paid' : (current === 'paid' ? 'partial' : 'pending'); const newTrans = transactions.map(tr => tr.id === t.id ? { ...tr, status: next } : tr); dispatch({ type: 'UPDATE_TRANSACTIONS', payload: newTrans }); }} className="transition-transform active:scale-95 hover:scale-110">{t.status === 'paid' ? <CheckCircle2 className="text-emerald-500 w-6 h-6" /> : t.status === 'partial' ? <Clock className="text-amber-500 w-6 h-6" /> : <Circle className="text-slate-300 w-6 h-6" />}</button></td>
                                                    <td className="pr-20 py-4 text-slate-500 font-bold leading-relaxed"><div className="font-bold text-slate-800 dark:text-slate-200 text-base mb-1">{t.description || 'Ø¨Ø¯ÙˆÙ† ÙˆØµÙ'}</div><div className="flex gap-3 items-center opacity-80"><span className="bg-white dark:bg-slate-800 px-3 py-1 border border-slate-200 dark:border-slate-700 rounded-lg shadow-sm">{t.date}</span><span className="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg font-bold">{PAYMENT_METHODS.find(p=>p.id===t.method)?.label}</span></div></td>
                                                    <td className="py-4 text-center text-slate-400 font-bold">{t.quantity > 1 ? `${t.quantity} Ã— ${t.unitPrice}` : '-'}</td>
                                                    <td className="py-4 font-black text-left text-base dark:text-slate-200">{Number(t.amount).toLocaleString()}</td>
                                                    <td className="py-4 text-center"><div className="flex gap-2 justify-center"><button type="button" onClick={() => { dispatch({ type: 'SET_FORM_MODE', payload: 'edit' }); dispatch({ type: 'SET_FORM_DATA', payload: t }); dispatch({ type: 'SET_FORM_OPEN', payload: true }); }} className="text-blue-500 hover:bg-blue-50 p-2 rounded-xl transition-colors"><Edit size={16} /></button><button type="button" onClick={() => handleDelete(t.id)} className="text-red-400 hover:bg-red-50 p-2 rounded-xl transition-colors"><Trash2 size={16} /></button></div></td>
                                                </tr>
                                            ))}
                                        </React.Fragment>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        {visibleStats.count > 0 && (
                            <div className="floating-stats glass border-2 border-slate-200 dark:border-slate-700 mx-4 my-4 p-4 rounded-2xl flex justify-between items-center shadow-2xl">
                                <div className="flex items-center gap-2"><div className="bg-blue-100 dark:bg-blue-900/30 p-2 rounded-lg text-blue-600 dark:text-blue-400"><BarChart3 size={20} /></div><div><p className="text-[10px] text-slate-500 uppercase font-bold">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p><p className="text-sm font-bold text-slate-800 dark:text-white">{visibleStats.count} Ø¹Ù…Ù„ÙŠØ©</p></div></div>
                                <div className="text-right"><p className="text-[10px] text-slate-500 uppercase font-bold">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶</p><p className="text-xl font-black text-blue-600">{visibleStats.sum.toLocaleString()} <span className="text-xs text-slate-400">Ø¬.Ù…</span></p></div>
                            </div>
                        )}
                        {visibleTransactions < groupedTransactions.length && (<div className="p-6 border-t border-slate-100 dark:border-slate-800 text-center"><button type="button" onClick={() => setVisibleTransactions(prev => prev + 10)} className="bg-blue-600 hover:bg-blue-700 text-white px-8 py-3 rounded-2xl font-bold transition-all flex items-center gap-2 mx-auto"><Plus size={20} /> ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø²ÙŠØ¯</button></div>)}
                    </div>
                </div>
            );

            // ğŸ¯ NEW: STRATEGIC PLANNER RENDERER
            const renderStrategicPlanner = () => {
                const currentMonthIdx = new Date().getMonth();
                const monthsRemaining = MONTHS.slice(currentMonthIdx);
                
                // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©
                let runningLiquidity = financeSnapshot.projectedClosingBalance; // Ù†Ø¨Ø¯Ø£ Ø¨Ø±ØµÙŠØ¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
                let simulatedLoans = JSON.parse(JSON.stringify(updatedLoans));
                
                // Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                let simulatedCards = cards.map(card => {
                    const history = calculateCardHistory(card);
                    const currentMonthDebt = history.find(h => h.month === selectedMonth)?.closingDebt || 0;
                    return { ...card, currentDebt: currentMonthDebt };
                });

                return (
                    <div className="space-y-8 animate-fadeIn pb-24">
                        {/* Header Section */}
                        <div className="glass p-8 rounded-[2.5rem] bg-gradient-to-r from-slate-900 to-blue-900 text-white shadow-glow">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-3xl font-black flex items-center gap-3">
                                        <Target className="text-emerald-400" size={32} /> Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ {CURRENT_YEAR}
                                    </h2>
                                    <p className="text-slate-400 mt-2 font-bold">Ù…Ø­Ø§ÙƒØ§Ø© Ø°ÙƒÙŠØ© Ù„Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠ ÙˆØ¥Ù‡Ù„Ø§Ùƒ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©</p>
                                </div>
                                <div className="hidden md:block text-left">
                                    <div className="text-xs uppercase tracking-widest text-slate-500 font-bold mb-1">Ø§Ù„ÙˆØ¶Ø¹ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
                                    <div className="text-2xl font-black text-emerald-400">{runningLiquidity.toLocaleString()} <span className="text-sm">Ø¬.Ù…</span></div>
                                </div>
                            </div>
                        </div>

                        {/* Main Simulation Table */}
                        <div className="glass rounded-[2.5rem] overflow-hidden border border-slate-200 dark:border-slate-700 shadow-pro-card">
                            <div className="overflow-x-auto">
                                <table className="w-full text-right text-sm border-collapse">
                                    <thead>
                                        <tr className="bg-slate-50 dark:bg-slate-800/50 text-slate-500 font-bold">
                                            <th className="p-6 border-b dark:border-slate-700">Ø§Ù„Ø´Ù‡Ø±</th>
                                            <th className="p-6 border-b dark:border-slate-700">Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ©</th>
                                            <th className="p-6 border-b dark:border-slate-700 text-rose-500">Ø§Ù„ØªØ²Ø§Ù…Ø§Øª (Ø¯ÙŠÙˆÙ† + ÙƒØ±ÙˆØª)</th>
                                            <th className="p-6 border-b dark:border-slate-700 text-emerald-600 bg-emerald-50/20">ØµØ§ÙÙŠ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                                            <th className="p-6 border-b dark:border-slate-700">Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</th>
                                            <th className="p-6 border-b dark:border-slate-700 text-center">Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ù…Ø§Ù†</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y dark:divide-slate-800">
                                        {monthsRemaining.map((month, idx) => {
                                            // Ø£- Ø­Ø³Ø§Ø¨ Ø£Ù‚Ø³Ø§Ø· Ø§Ù„Ù‚Ø±ÙˆØ¶ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
                                            let monthlyLoanPayments = 0;
                                            simulatedLoans = simulatedLoans.map(l => {
                                                const payment = Math.min(l.remaining, l.monthlyInstallment);
                                                monthlyLoanPayments += payment;
                                                return { ...l, remaining: l.remaining - payment };
                                            });

                                            // Ø¨- Ø­Ø³Ø§Ø¨ Ø³Ø¯Ø§Ø¯ Ø§Ù„ÙƒØ±ÙˆØª (Ù†ÙØªØ±Ø¶ Ø³Ø¯Ø§Ø¯ Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø£Ùˆ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰)
                                            // Ù„ØºØ±Ø¶ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© Ø³Ù†ÙØªØ±Ø¶ Ø³Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØªØ±Ø§ÙƒÙ… Ø§Ù„ÙÙˆØ§Ø¦Ø¯
                                            let monthlyCardPayments = simulatedCards.reduce((sum, c) => sum + c.currentDebt, 0);
                                            simulatedCards = simulatedCards.map(c => ({ ...c, currentDebt: 0 }));

                                            // Ø¬- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬Ø© Ù„Ù„Ø¯ÙŠÙˆÙ†
                                            const totalOutflow = monthlyLoanPayments + monthlyCardPayments;
                                            
                                            // Ø¯- Ø­Ø³Ø§Ø¨ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© (Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± = Ø¨Ø¯Ø§ÙŠØ© + Ø¯Ø®Ù„ - Ù…ØµØ§Ø±ÙŠÙ Ø«Ø§Ø¨ØªØ© - Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø¯ÙŠÙˆÙ†)
                                            // Ø³Ù†Ø¹ØªØ¨Ø± ØµØ§ÙÙŠ Ø§Ù„ØªØ¯Ø®Ù„ (Ø§Ù„Ø¯Ø®Ù„ - Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ) Ø«Ø§Ø¨Øª Ø¨Ù†Ø§Ø¡ Ø¹Ù„Ù‰ Ø´Ù‡Ø± ÙŠÙ†Ø§ÙŠØ± Ù„ØºØ±Ø¶ Ø§Ù„ØªØ®Ø·ÙŠØ·
                                            const monthlyNetIncome = financeSnapshot.income - financeSnapshot.cashExpenses;
                                            const openingLiquidity = runningLiquidity;
                                            runningLiquidity = (openingLiquidity + monthlyNetIncome) - totalOutflow;

                                            // Ù‡Ù€- Ø§Ù„Ù…Ø¯ÙŠÙˆÙ†ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ÙÙŠ Ø°Ù…Ø© Ø£Ø­Ù…Ø¯ Ø¨Ù†Ù‡Ø§ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
                                            const remainingTotalDebt = simulatedLoans.reduce((sum, l) => sum + l.remaining, 0);

                                            const isDanger = runningLiquidity < 0;

                                            return (
                                                <tr key={month} className={`transition-colors ${idx === 0 ? 'bg-blue-50/20' : 'hover:bg-slate-50 dark:hover:bg-slate-800/30'}`}>
                                                    <td className="p-6 font-black text-slate-800 dark:text-white">{month}</td>
                                                    <td className="p-6 font-mono text-slate-500">{Math.round(openingLiquidity).toLocaleString()}</td>
                                                    <td className="p-6 font-mono text-rose-500 font-bold">-{Math.round(totalOutflow).toLocaleString()}</td>
                                                    <td className={`p-6 font-mono text-lg font-black ${isDanger ? 'text-red-600 bg-red-50/50' : 'text-emerald-600 bg-emerald-50/20'}`}>
                                                        {Math.round(runningLiquidity).toLocaleString()}
                                                    </td>
                                                    <td className="p-6 font-mono text-slate-600">{Math.round(remainingTotalDebt).toLocaleString()}</td>
                                                    <td className="p-6 text-center">
                                                        {isDanger ? (
                                                            <span className="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-[10px] font-black animate-pulse flex items-center justify-center gap-1">
                                                                <AlertTriangle size={12} /> Ø¹Ø¬Ø² Ù…Ø§Ù„ÙŠ
                                                            </span>
                                                        ) : runningLiquidity < 10000 ? (
                                                            <span className="px-3 py-1 bg-amber-100 text-amber-600 rounded-lg text-[10px] font-black flex items-center justify-center gap-1">
                                                                <ShieldAlert size={12} /> Ø§Ù†ØªØ¨Ø§Ù‡
                                                            </span>
                                                        ) : (
                                                            <span className="px-3 py-1 bg-emerald-100 text-emerald-600 rounded-lg text-[10px] font-black flex items-center justify-center gap-1">
                                                                <ShieldCheck size={12} /> Ù…Ø³ØªÙ‚Ø±
                                                            </span>
                                                        )}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        {/* Strategy Cards */}
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div className="glass p-8 rounded-[2.5rem] border-r-4 border-r-blue-500">
                                <h4 className="font-black text-xl mb-4 flex items-center gap-2 text-slate-800 dark:text-white">
                                    <Sparkles className="text-blue-500" /> ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙØ§Ø¦Ø¶ Ø§Ù„Ù…Ø§Ù„ÙŠ
                                </h4>
                                <p className="text-sm text-slate-500 leading-relaxed font-medium">
                                    Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©ØŒ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø°ÙŠ Ø³ØªÙ…ØªÙ„Ùƒ ÙÙŠÙ‡ Ø£ÙƒØ¨Ø± Ù‚Ø¯Ø± Ù…Ù† Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ù‡Ùˆ Ø´Ù‡Ø± <span className="text-blue-600 font-black">Ø¯ÙŠØ³Ù…Ø¨Ø±</span>. 
                                    Ù†Ù†ØµØ­ Ø¨ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ÙØ§Ø¦Ø¶ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ù„Ø³Ø¯Ø§Ø¯ Ø¬Ø²Ø¡ Ù…Ù† Ø£ØµÙ„ <span className="font-bold text-slate-800 dark:text-slate-200">Ù‚Ø±Ø¶ AAIB</span> Ù„ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙØ§Ø¦Ø¯Ø© Ø§Ù„Ù…ØªØ±Ø§ÙƒÙ…Ø©.
                                </p>
                            </div>
                            <div className="glass p-8 rounded-[2.5rem] border-r-4 border-r-amber-500">
                                <h4 className="font-black text-xl mb-4 flex items-center gap-2 text-slate-800 dark:text-white">
                                    <BellRing className="text-amber-500" /> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
                                </h4>
                                <p className="text-sm text-slate-500 leading-relaxed font-medium">
                                    ØªØ¬Ù†Ø¨ Ø£ÙŠ Ù…Ø´ØªØ±ÙŠØ§Øª ØªÙ‚Ø³ÙŠØ· Ø¬Ø¯ÙŠØ¯Ø© ØªÙ†ØªÙ‡ÙŠ Ø¨Ø¹Ø¯ Ø´Ù‡Ø± <span className="text-amber-600 font-black">Ø£Ø¨Ø±ÙŠÙ„</span> Ø­ØªÙ‰ ØªØ¶Ù…Ù† Ø¨Ù‚Ø§Ø¡ ØµØ§ÙÙŠ Ø§Ù„Ø³ÙŠÙˆÙ„Ø© Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ© ÙÙˆÙ‚ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ù…Ø§Ù† (5,000 Ø¬.Ù…).
                                </p>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderActiveView = () => {
                switch (activeTab) {
                    case 'dashboard': return renderDashboard();
                    case 'transactions': return renderTransactionsViewFull();
                    case 'categories': return renderCategoriesView();
                    case 'loans': return renderLoansView();
                    case 'cards': return renderWalletsAndCardsView();
                    case 'calendar': return renderCalendarView();
                    case 'planner': return renderStrategicPlanner(); // ğŸ¯ NEW ROUTE
                    case 'duplicates': return <DuplicateDetectionSystem transactions={transactions} dispatch={dispatch} addNotification={addNotification} MONTHS={MONTHS} />; // âœ… NEW DUPLICATES VIEW
                    default: return renderDashboard();
                }
            };

            if (!isAuthenticated) return <LoginScreen onLogin={() => { 
                setIsAuthenticated(true); 
                dispatch({ type: 'SET_BACKUP_REMINDER_OPEN', payload: true }); // âœ… NEW: Trigger backup reminder on login
            }} />;

            return (
                <div className="flex h-screen overflow-hidden text-slate-800 dark:text-slate-100 font-sans">
                    
                    <ProfessionalTicker />

                    <NotificationCenter notifications={notifications} removeNotification={removeNotification} />
                    
                    {isProcessing && (<div className="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-[9999] animate-fadeIn"><div className="text-center"><div className="loading-spinner mx-auto mb-6"></div><p className="text-white text-xl font-bold animate-pulse">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p></div></div>)}
                    
                    <ConfirmDialog />

                    <div className="bottom-nav-container"><div className="scrollable-nav scroll-hide">
                        {[{ id: 'dashboard', label: 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©', icon: LayoutDashboard }, { id: 'transactions', label: 'Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª', icon: ArrowUpRight }, { id: 'cards', label: 'Ø§Ù„Ù…Ø­Ø§ÙØ¸', icon: CreditCard }, { id: 'loans', label: 'Ø§Ù„Ù‚Ø±ÙˆØ¶', icon: Banknote }, { id: 'planner', label: 'Ø§Ù„Ù…Ø®Ø·Ø·', icon: Target }, { id: 'calendar', label: 'Ø§Ù„Ø£Ø¬Ù†Ø¯Ø©', icon: CalendarDays }, { id: 'duplicates', label: 'Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª', icon: Filter }, { id: 'categories', label: 'Ø§Ù„ÙØ¦Ø§Øª', icon: Layers }].map(item => (<button key={item.id} type="button" onClick={() => dispatch({ type: 'SET_ACTIVE_TAB', payload: item.id })} className={`nav-btn ${activeTab === item.id ? 'active' : ''}`} aria-label={item.label}><item.icon size={24} /><span>{item.label}</span>{activeTab === item.id && (<div className="absolute -top-1 w-1.5 h-1.5 bg-blue-500 rounded-full animate-pulse" />)}</button>))}
                        <div className="v-line"></div>
                        <button type="button" onClick={handleExportCSV} className="nav-btn text-emerald-600 hover:bg-emerald-50" aria-label="ØªØµØ¯ÙŠØ± CSV"><FileSpreadsheet size={24} /><span>CSV</span></button>
                        <button type="button" onClick={handleExport} className="nav-btn text-blue-600 hover:bg-blue-50" aria-label="Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©"><Download size={24} /><span>Ø­ÙØ¸</span></button>
                        <label className="nav-btn cursor-pointer text-purple-600 hover:bg-purple-50"><input type="file" accept=".json" onChange={handleImport} className="hidden" /><Upload size={24} /><span>Ø¬Ù„Ø¨</span></label>
                        <button type="button" onClick={resetData} className="nav-btn text-red-500 hover:bg-red-50" aria-label="Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†"><RefreshCcw size={24} /><span>Ø¥Ø¹Ø§Ø¯Ø©</span></button>
                        <div className="v-line"></div>
                        <button type="button" onClick={() => mainContentRef.current?.scrollTo({top:0, behavior:'smooth'})} className="nav-btn" aria-label="Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¥Ù„Ù‰ Ø§Ù„Ø£Ø¹Ù„Ù‰"><ArrowUp size={24} /><span>Ø£Ø¹Ù„Ù‰</span></button>
                        <button type="button" onClick={() => dispatch({ type: 'SET_IS_LOCKED', payload: true })} className="nav-btn text-amber-500 hover:bg-amber-50" aria-label="Ù‚ÙÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"><Lock size={24} /><span>Ù‚ÙÙ„</span></button>
                    </div></div>

                    {!isLocked && (<button type="button" onClick={() => { dispatch({ type: 'SET_FORM_MODE', payload: 'add' }); dispatch({ type: 'SET_FORM_DATA', payload: { type: 'expense', category: '', amount: '', quantity:1, unitPrice: '', date: getLocalISODate(), month: selectedMonth, method: 'cash', subType: 'withdrawal' } }); dispatch({ type: 'SET_FORM_OPEN', payload: true }); }} className="fab" title="Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©" aria-label="Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©"><Plus size={32} /></button>)}

                    <aside className="w-80 glass border-l-0 dark:border-r border-white/20 hidden md:flex flex-col p-8 z-40 relative">
                        <div className="flex items-center gap-4 mb-12 px-2 group cursor-pointer hover-lift p-4 rounded-2xl" onClick={() => dispatch({ type: 'SET_ACTIVE_TAB', payload: 'dashboard' })}><div className="bg-gradient-to-br from-blue-600 to-blue-500 p-3.5 rounded-2xl text-white shadow-lg shadow-blue-500/30 group-hover:scale-110 transition-transform duration-300"><Wallet size={28} /></div><div><h1 className="font-black text-2xl tracking-tight dark:text-white">Ù…Ø­ÙØ¸ØªÙŠ</h1><p className="text-xs font-bold text-slate-400 tracking-widest uppercase">Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</p></div></div>
                        <nav className="space-y-3 flex-1 scroll-hide overflow-y-auto">
                            {[{ id: 'dashboard', label: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…', icon: LayoutDashboard }, { id: 'transactions', label: 'Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª', icon: ArrowUpRight }, { id: 'categories', label: 'Ø§Ù„ÙØ¦Ø§Øª ÙˆØ§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©', icon: Layers }, { id: 'loans', label: 'Ø§Ù„Ù‚Ø±ÙˆØ¶ ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†', icon: Banknote }, { id: 'cards', label: 'Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸', icon: CreditCard }, { id: 'planner', label: 'Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ', icon: Target }, { id: 'calendar', label: 'Ø§Ù„Ø£Ø¬Ù†Ø¯Ø© ÙˆÙ…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø³Ø¯Ø§Ø¯', icon: CalendarDays }, { id: 'duplicates', label: 'ÙƒØ´Ù Ø§Ù„Ù…ÙƒØ±Ø±Ø§Øª', icon: Filter }].map(item => (<button key={item.id} type="button" onClick={() => dispatch({ type: 'SET_ACTIVE_TAB', payload: item.id })} className={`w-full flex items-center gap-4 px-6 py-4 rounded-2xl transition-all duration-300 font-bold ${activeTab === item.id ? 'bg-gradient-to-r from-blue-600 to-blue-500 text-white shadow-lg shadow-blue-500/30 scale-[1.02]' : 'text-slate-500 dark:text-slate-400 hover:bg-white/50 dark:hover:bg-slate-800/50 hover:text-blue-600'}`}><item.icon size={22} className={activeTab === item.id ? 'animate-pulse' : ''} /><span className="text-sm tracking-wide">{item.label}</span></button>))}
                        </nav>
                        <div className="mt-auto pt-8 border-t border-slate-200 dark:border-slate-700/50"><button type="button" onClick={() => setIsAuthenticated(false)} className="w-full flex items-center gap-4 px-6 py-4 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-2xl transition-all font-bold active:scale-95 group"><LogOut size={22} className="group-hover:-translate-x-1 transition-transform" /> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button></div>
                    </aside>

                    <main ref={mainContentRef} className="flex-1 overflow-y-auto p-6 md:p-12 relative scroll-smooth pt-16"> 
                        {isLocked ? (
                            <div className="lock-screen backdrop-blur-3xl animate-fadeIn"><Lock size={80} className="mb-8 text-blue-500 animate-bounce-slight" /><h2 className="text-4xl font-black mb-8 tracking-tight">Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù‚ÙÙ„</h2><button type="button" onClick={() => dispatch({ type: 'SET_IS_LOCKED', payload: false })} className="bg-white text-slate-900 px-16 py-5 rounded-full font-bold shadow-2xl flex items-center gap-3 transition-all hover:scale-105 active:scale-95 uppercase tracking-widest"><Unlock size={24} /> ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</button></div>
                        ) : (
                            <div className="max-w-7xl mx-auto space-y-12 animate-fadeIn pb-24">
                                <header className="flex justify-between items-end bg-transparent pb-4">
                                    <div><h2 className="text-4xl font-black text-slate-800 dark:text-white tracking-tight mb-2">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ Ø£Ø­Ù…Ø¯ ğŸ‘‹</h2><p className="text-slate-500 font-bold text-base">Ø¥Ù„ÙŠÙƒ Ù…Ù„Ø®Øµ Ù…Ø­ÙØ¸ØªÙƒ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ù„Ø¹Ø§Ù… <span className="text-blue-600 font-black">{CURRENT_YEAR}</span></p></div>
                                    <div className="flex gap-4">
                                        <button type="button" onClick={() => dispatch({ type: 'SET_AI_MODAL_OPEN', payload: true })} className="bg-gradient-to-r from-purple-600 to-indigo-600 text-white p-4 rounded-2xl shadow-lg shadow-purple-500/30 transition-all hover:scale-110 active:scale-95 hover:rotate-6" aria-label="Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ"><Sparkles size={24} /></button>
                                        <button type="button" onClick={() => dispatch({ type: 'SET_HIDE_PAST', payload: !hidePast })} className={`p-4 rounded-2xl shadow-lg transition-all font-bold flex items-center gap-2 ${hidePast ? 'bg-orange-100 text-orange-600' : 'bg-white text-slate-400 hover:text-slate-600'}`} title="ÙˆØ¶Ø¹ Ø§Ù„ØªØ±ÙƒÙŠØ²" aria-label={hidePast ? 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ' : 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø§Ø¶ÙŠ'}>{hidePast ? <EyeOff size={24} /> : <Eye size={24} />}</button>
                                        <div className="flex bg-white dark:bg-slate-800 p-1.5 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700"><button type="button" onClick={() => dispatch({ type: 'TOGGLE_DARK_MODE', payload: false })} className={`p-3 rounded-xl transition-all ${!isDarkMode ? 'bg-yellow-100 text-yellow-600 shadow-sm' : 'text-slate-400'}`} aria-label="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­"><Sun size={20} /></button><button type="button" onClick={() => dispatch({ type: 'TOGGLE_DARK_MODE', payload: true })} className={`p-3 rounded-xl transition-all ${isDarkMode ? 'bg-slate-700 text-blue-400 shadow-sm' : 'text-slate-400'}`} aria-label="Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†"><Moon size={20} /></button></div>
                                        <div className="h-8 w-px bg-slate-300 mx-1"></div><button type="button" onClick={() => dispatch({ type: 'UNDO' })} disabled={history.length === 0} className={`p-4 rounded-2xl shadow-lg transition-all font-bold flex items-center gap-2 ${history.length > 0 ? 'bg-white dark:bg-slate-800 text-blue-600' : 'bg-slate-50 text-slate-300'}`}><Undo2 size={20} /></button><button type="button" onClick={() => dispatch({ type: 'REDO' })} disabled={future.length === 0} className={`p-4 rounded-2xl shadow-lg transition-all font-bold flex items-center gap-2 ${future.length > 0 ? 'bg-white dark:bg-slate-800 text-blue-600' : 'bg-slate-50 text-slate-300'}`}><Redo2 size={20} /></button>
                                    </div>
                                </header>
                                {renderActiveView()}
                            </div>
                        )}
                    </main>

                    {isFormOpen && (
                        <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-[2500] backdrop-blur-md p-4 transition-all">
                            <div className="bg-white dark:bg-slate-900 w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden animate-fadeIn border border-white/20">
                                <div className="p-8 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50/50 dark:bg-slate-800/30">
                                    <h3 className="text-2xl font-black text-slate-800 dark:text-white flex items-center gap-3"><div className="bg-blue-500 p-2 rounded-xl text-white shadow-lg shadow-blue-500/30"><Plus size={20} /></div>{formMode === 'add' ? 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ©' : 'ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ©'}</h3>
                                    <button type="button" onClick={() => dispatch({ type: 'SET_FORM_OPEN', payload: false })} className="text-slate-400 hover:text-red-500 p-2 hover:bg-red-50 rounded-xl transition-colors" aria-label="Ø¥ØºÙ„Ø§Ù‚"><X size={24} /></button>
                                </div>
                                <form onSubmit={handleSaveTransaction} className="p-8 space-y-6" id="transaction-form">
                                    <div className="grid grid-cols-2 gap-6">
                                        <div><label className="block text-sm font-bold mb-3 text-slate-400 uppercase mb-2">Ø§Ù„Ù†ÙˆØ¹</label><select className="input-field font-bold" value={formData.type} onChange={(e) => { const newType = e.target.value; const newSubType = newType === 'income' ? 'deposit' : 'withdrawal'; dispatch({ type: 'SET_FORM_DATA', payload: { ...formData, type: newType, subType: newSubType } }); }}><option value="expense">Ù…ØµØ±ÙˆÙ ğŸ’¸</option><option value="income">Ø¯Ø®Ù„ ğŸ’°</option></select></div>
                                        <div><label className="block text-sm font-bold mb-3 text-slate-400 uppercase mb-2">Ø§Ù„ÙØ¦Ø©</label><select className="input-field font-bold" value={formData.category} onChange={e => dispatch({ type: 'SET_FORM_DATA', payload: { ...formData, category: e.target.value } }) } required><option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ...</option>{Object.entries(CATEGORY_GROUPS[formData.type]).map(([groupName, items]) => (<optgroup key={groupName} label={groupName}>{items.map(c => (<option key={c} value={c}>{c}</option>))}</optgroup>))}</select></div>
                                    </div>
                                    
                                    {(['fawry', 'etisalat', 'cib_savings', 'aaib_savings'].includes(formData.method)) && (
                                        <div className="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-dashed border-slate-300 mb-4">
                                            <label className="block text-xs font-bold mb-3 text-slate-500">Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</label>
                                            <div className="flex gap-4">
                                                <label className={`flex-1 flex items-center justify-center gap-2 p-3 rounded-xl cursor-pointer border-2 transition-all ${formData.subType === 'deposit' ? 'border-emerald-500 bg-emerald-50' : 'border-transparent bg-white'}`}>
                                                    <input type="radio" name="subType" value="deposit" className="hidden"
                                                           checked={formData.subType === 'deposit'} 
                                                           onChange={() => dispatch({ type: 'SET_FORM_DATA', payload: { ...formData, subType: 'deposit' } })} />
                                                    <span className="text-sm font-bold">Ø¥ÙŠØ¯Ø§Ø¹ (+)</span>
                                                </label>
                                                <label className={`flex-1 flex items-center justify-center gap-2 p-3 rounded-xl cursor-pointer border-2 transition-all ${formData.subType === 'withdrawal' ? 'border-red-500 bg-red-50' : 'border-transparent bg-white'}`}>
                                                    <input type="radio" name="subType" value="withdrawal" className="hidden"
                                                           checked={formData.subType === 'withdrawal'} 
                                                           onChange={() => dispatch({ type: 'SET_FORM_DATA', payload: { ...formData, subType: 'withdrawal' } })} />
                                                    <span className="text-sm font-bold">Ø³Ø­Ø¨ (-)</span>
                                                </label>
                                            </div>
                                        </div>
                                    )}

                                    <div className="bg-slate-50 dark:bg-slate-800/50 p-4 rounded-2xl border border-dashed border-slate-200 dark:border-slate-700 flex items-center gap-4"><div className="flex-1"><label className="text-[10px] text-slate-400 block mb-1 font-bold">Ø§Ù„Ø¹Ø¯Ø¯</label><input type="number" className="w-full bg-transparent border-b-2 border-slate-200 focus:border-blue-500 text-center font-bold text-lg outline-none transition-colors" value={formData.quantity} onChange={e => dispatch({ type: 'SET_FORM_DATA', payload: { ...formData, quantity: e.target.value, amount: (e.target.value * (formData.unitPrice || 0)) } })} /></div><span className="text-slate-300 text-lg">Ã—</span><div className="flex-1"><label className="text-[10px] text-slate-400 block mb-1 font-bold">Ø§Ù„Ø³Ø¹Ø±</label><input type="number" className="w-full bg-transparent border-b-2 border-slate-200 focus:border-blue-500 text-center font-bold text-lg outline-none transition-colors" value={formData.unitPrice} onChange={e => dispatch({ type: 'SET_FORM_DATA', payload: { ...formData, unitPrice: e.target.value, amount: (e.target.value * (formData.quantity ||0)) } })} /></div></div>
                                    <div className="grid grid-cols-3 gap-4"><div className="col-span-1"><label className="block text-sm font-bold mb-3 text-slate-400 uppercase mb-2">Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" required step="0.01" className="input-field text-xl font-black text-blue-600" value={formData.amount} onChange={e => dispatch({ type: 'SET_FORM_DATA', payload: { ...formData, amount: e.target.value, unitPrice: e.target.value / (formData.quantity ||1) } })} /></div><div className="col-span-1"><label className="block text-sm font-bold mb-3 text-slate-400 uppercase mb-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" required className="input-field text-sm font-bold" value={formData.date} onChange={e => dispatch({ type: 'SET_FORM_DATA', payload: { ...formData, date: e.target.value } })} /></div><div className="col-span-1"><label className="block text-sm font-bold mb-3 text-slate-400 uppercase mb-2">Ø§Ù„Ø¯ÙØ¹</label><select className="input-field text-sm font-bold" value={formData.method} 
                                        onChange={e => {
                                            const newMethod = e.target.value;
                                            let newSubType = formData.subType;
                                            
                                            if (['fawry', 'etisalat', 'cib_savings', 'aaib_savings'].includes(newMethod)) {
                                                newSubType = formData.type === 'income' ? 'deposit' : 'withdrawal';
                                            }
                                            
                                            dispatch({ 
                                                type: 'SET_FORM_DATA', 
                                                payload: { ...formData, method: newMethod, subType: newSubType } 
                                            });
                                        }}
                                    >
                                        {PAYMENT_METHODS.map(m => (<option key={m.id} value={m.id}>{m.label}</option>))}
                                    </select></div></div>
                                    
                                    {formData.type === 'expense' && (
                                        <details className="group border border-slate-200 dark:border-slate-700 rounded-2xl overflow-hidden bg-white dark:bg-slate-800">
                                            <summary className="p-4 cursor-pointer text-xs font-bold text-slate-500 flex items-center justify-between select-none hover:bg-slate-50 transition-colors">
                                                <span className="flex items-center gap-2"><Hash size={16} className="text-blue-500" /> Ø±Ø¨Ø· Ø¨Ù‚Ø±Ø¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</span>
                                                <ChevronDown size={16} className="group-open:rotate-180 transition-transform" />
                                            </summary>
                                            <div className="p-4 border-t border-slate-100 dark:border-slate-700">
                                                <select className="input-field text-sm font-bold w-full" value={formData.linkedLoanId || ''} onChange={e => dispatch({ type: 'SET_FORM_DATA', payload: { ...formData, linkedLoanId: e.target.value ? Number(e.target.value) : '' } }) }><option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø±Ø¶ --</option>{updatedLoans.map(l => (<option key={l.id} value={l.id}>{l.name}</option>))}</select>
                                            </div>
                                        </details>
                                    )}

                                    {formData.type === 'expense' && formData.category === 'Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ© ÙˆØ§Ù„ØªÙ…ÙˆÙŠÙ„ÙŠØ©' && (
                                        <div>
                                            <label className="block text-sm font-bold mb-3 text-slate-400 uppercase mb-2 flex items-center gap-2 tracking-wider"><CreditCard size={14} /> Ø³Ø¯Ø§Ø¯ Ø¨Ø·Ø§Ù‚Ø© Ø§Ø¦ØªÙ…Ø§Ù†</label>
                                            <select className="input-field text-sm font-bold bg-blue-50/50 border-blue-200" value={formData.linkedCardId || ''} onChange={e => dispatch({ type: 'SET_FORM_DATA', payload: { ...formData, linkedCardId: e.target.value ? Number(e.target.value) : '' } }) }><option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© --</option>{cards.map(c => (<option key={c.id} value={c.id}>{c.name} - {c.bank}</option>))}</select>
                                        </div>
                                    )}

                                    <div><label className="block text-sm font-bold mb-3 text-slate-400 uppercase mb-2 block tracking-wider">Ø§Ù„ÙˆØµÙ</label><input type="text" id="form-desc" className="input-field font-bold" value={formData.description} onChange={e => dispatch({ type: 'SET_FORM_DATA', payload: { ...formData, description: e.target.value } })} placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ©..." /></div>
                                    {formMode === 'add' && (<details className="group border border-slate-200 dark:border-slate-700 rounded-2xl overflow-hidden bg-white dark:bg-slate-800"><summary className="p-4 cursor-pointer text-xs font-bold text-slate-500 flex items-center justify-between select-none hover:bg-slate-50 transition-colors"><span className="flex items-center gap-2"><Repeat size={16} className="text-blue-500" /> ØªÙƒØ±Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„</span><ChevronDown size={16} className="group-open:rotate-180 transition-transform" /></summary><div className="p-4 border-t border-slate-100 dark:border-slate-700 flex flex-wrap gap-2">{MONTHS.map((m, idx) => { if (idx <= MONTHS.indexOf(selectedMonth)) return null; return (<label key={m} className="inline-flex items-center gap-2 bg-slate-50 dark:bg-slate-700 px-4 py-2 rounded-xl border border-slate-200 dark:border-slate-600 cursor-pointer select-none text-xs font-bold hover:border-blue-300 transition-colors"><input type="checkbox" className="rounded text-blue-600 focus:rope-0 w-4 h-4" onChange={(e) => { if (e.target.checked) { dispatch({ type: 'SET_REPEAT_MONTHS', payload: [...repeatMonths, m] }); } else { dispatch({ type: 'SET_REPEAT_MONTHS', payload: repeatMonths.filter(rm => rm !== m) }); } }} />{m}</label>); })}</div></details>)}
                                    <button type="submit" className="w-full bg-gradient-to-r from-blue-600 to-blue-500 text-white py-4 rounded-2xl font-black text-lg shadow-xl shadow-blue-500/30 hover:shadow-blue-500/50 hover:scale-[1.02] active:scale-95 transition-all mt-4" disabled={isProcessing}>{isProcessing ? (<span className="flex items-center justify-center gap-2"><div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...</span>) : 'Ø­ÙØ¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©'}</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {isAiModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-[3500] backdrop-blur-md p-4 animate-fadeIn">
                            <div className="bg-white dark:bg-slate-900 w-full max-w-2xl rounded-[2.5rem] shadow-2xl overflow-hidden animate-fadeIn border border-purple-500/20 flex flex-col max-h-[90vh]">
                                <div className="p-8 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-gradient-to-r from-purple-50 to-indigo-50 dark:bg-purple-900/20">
                                    <h3 className="text-2xl font-black text-slate-800 dark:text-white flex items-center gap-3"><div className="bg-purple-500 p-2 rounded-xl text-white shadow-lg shadow-purple-500/30"><Bot size={20} /></div>Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h3>
                                    <button type="button" onClick={() => dispatch({ type: 'SET_AI_MODAL_OPEN', payload: false })} className="text-slate-400 hover:text-red-500 p-2 hover:bg-red-50 rounded-xl transition-colors"><X size={24} /></button>
                                </div>
                                <div className="p-8 flex-1 overflow-y-auto scroll-hide">
                                    <div className="flex gap-4 mb-6 border-b border-slate-100 dark:border-slate-800 pb-4"><button type="button" onClick={() => dispatch({ type: 'SET_AI_TAB', payload: 'analyze' })} className={`pb-2 px-4 rounded-xl font-bold transition-all ${aiTab === 'analyze' ? 'bg-purple-100 text-purple-600' : 'text-slate-400 hover:text-slate-600'}`}>ØªØ­Ù„ÙŠÙ„</button><button type="button" onClick={() => dispatch({ type: 'SET_AI_TAB', payload: 'smart_add' })} className={`pb-2 px-4 rounded-xl font-bold transition-all ${aiTab === 'smart_add' ? 'bg-purple-100 text-purple-600' : 'text-slate-400 hover:text-slate-600'}`}>Ø¥Ø¶Ø§ÙØ© Ø³Ø±ÙŠØ¹Ø©</button></div>
                                    {aiTab === 'analyze' && (<div className="space-y-6"><button type="button" onClick={handleAnalyzeFinances} disabled={isAiLoading} className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg shadow-purple-500/30 flex items-center justify-center gap-3 hover:scale-[1.02] active:scale-95 transition-all">{isAiLoading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„...' : 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø§Ù„ÙŠ'}</button>{aiResponse && (<div className="bg-slate-50 dark:bg-slate-800 p-6 rounded-2xl border border-slate-200 dark:border-slate-700 animate-fadeIn"><p className="text-slate-700 dark:text-slate-200 leading-relaxed font-medium">{aiResponse}</p></div>)}</div>)}
                                    {aiTab === 'smart_add' && (<div className="space-y-4"><label className="block text-sm font-bold text-slate-500 uppercase">Ø§ÙƒØªØ¨ Ù…ØµØ±ÙˆÙÙƒ Ø£Ùˆ Ø¯Ø®Ù„Ùƒ Ø¨Ø£Ø³Ù„ÙˆØ¨ Ø­Ø¯ÙŠØ« (Ù…Ø«Ø§Ù„: Ù‚Ø¨Ø¶Øª 500 Ø¬.Ù… Ø£Ø¬Ø±)</label><textarea className="input-field h-32 resize-none" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§..." value={aiQuery} onChange={e => dispatch({ type: 'SET_AI_QUERY', payload: e.target.value })}></textarea><button type="button" onClick={handleSmartAdd} disabled={isAiLoading || !aiQuery} className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-500/30 flex items-center justify-center gap-3 hover:scale-[1.02] active:scale-95 transition-all">{isAiLoading ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...' : 'ØªÙ†ÙÙŠØ°'}</button>{aiResponse && (<div className="bg-orange-50 text-orange-700 p-4 rounded-xl text-sm font-bold animate-fadeIn">{aiResponse}</div>)}</div>)}
                                </div>
                            </div>
                        </div>
                    )}

                    {editingBudgetCategory && (
                        <div className="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-[3500] backdrop-blur-md p-4 animate-fadeIn">
                            <div className="bg-white dark:bg-slate-900 w-full max-w-sm rounded-[2.5rem] shadow-2xl p-8 animate-fadeIn border border-blue-500/20">
                                <h3 className="text-2xl font-black mb-6 text-slate-800 dark:text-white">ØªØ¹Ø¯ÙŠÙ„ Ù…ÙŠØ²Ø§Ù†ÙŠØ©: <span className="text-blue-600">{editingBudgetCategory}</span></h3>
                                <div className="space-y-6">
                                    <div><label className="block text-sm font-bold mb-3 text-slate-500 uppercase">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø®ØµØµ</label><input type="number" className="input-field text-xl font-black text-blue-600" value={budgetAmount} onChange={e => dispatch({ type: 'SET_BUDGET_AMOUNT', payload: e.target.value })} /></div>
                                    <div className="flex gap-4"><button type="button" onClick={handleSaveBudget} className="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-2xl font-bold shadow-lg shadow-blue-500/30">Ø­ÙØ¸</button><button type="button" onClick={() => dispatch({ type: 'SET_EDITING_BUDGET_CATEGORY', payload: null })} className="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-500 py-3 rounded-2xl font-bold">Ø¥Ù„ØºØ§Ø¡</button></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {editingCard && (
                        <div className="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-[3500] backdrop-blur-md p-4 animate-fadeIn">
                            <div className="bg-white dark:bg-slate-900 w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden animate-fadeIn border border-slate-200 dark:border-slate-700 max-h-[90vh] flex flex-col">
                                <div className="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
                                    <h3 className="text-xl font-black text-slate-800 dark:text-white flex items-center gap-2"><Edit size={20} className="text-blue-500"/> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</h3>
                                    <button type="button" onClick={() => dispatch({ type: 'SET_EDITING_CARD', payload: null })} className="p-2 hover:bg-red-50 hover:text-red-500 rounded-xl transition-colors"><X size={24} /></button>
                                </div>
                                <form onSubmit={handleUpdateCard} className="p-6 space-y-4 overflow-y-auto scroll-hide">
                                    <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500 mb-1 block">Ø§Ø³Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label><input type="text" required className="input-field" value={editingCard.name} onChange={e=>dispatch({type:'SET_EDITING_CARD', payload:{...editingCard, name:e.target.value}})} /></div><div><label className="text-xs font-bold text-slate-500 mb-1 block">Ø§Ù„Ø¨Ù†Ùƒ</label><input type="text" required className="input-field" value={editingCard.bank} onChange={e=>dispatch({type:'SET_EDITING_CARD', payload:{...editingCard, bank:e.target.value}})} /></div></div>
                                    <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500 mb-1 block">Ø§Ù„Ø­Ø¯ Ø§Ù„Ø§Ø¦ØªÙ…Ø§Ù†ÙŠ (Limit)</label><input type="number" required className="input-field text-blue-600 font-bold" value={editingCard.limit} onChange={e=>dispatch({type:'SET_EDITING_CARD', payload:{...editingCard, limit:Number(e.target.value)}})} /></div><div><label className="text-xs font-bold text-slate-500 mb-1 block">Ø±ØµÙŠØ¯ Ø£ÙˆÙ„ Ø§Ù„Ù…Ø¯Ø© (Ù…Ø¯ÙŠÙˆÙ†ÙŠØ©)</label><input type="number" className="input-field text-red-500 font-bold" value={editingCard.openingBalance} onChange={e=>dispatch({type:'SET_EDITING_CARD', payload:{...editingCard, openingBalance:Number(e.target.value)}})} /></div></div>
                                    <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500 mb-1 block">Ø§Ø³Ù… Ø­Ø§Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label><input type="text" className="input-field uppercase text-sm" value={editingCard.holderName} onChange={e=>dispatch({type:'SET_EDITING_CARD', payload:{...editingCard, holderName:e.target.value}})} /></div><div><label className="text-xs font-bold text-slate-500 mb-1 block">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡</label><input type="text" placeholder="MM/YY" className="input-field text-center" value={editingCard.expiry} onChange={e=>dispatch({type:'SET_EDITING_CARD', payload:{...editingCard, expiry:e.target.value}})} /></div></div>
                                    <div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500 mb-1 block">Ø¢Ø®Ø± 4 Ø£Ø±Ù‚Ø§Ù…</label><input type="text" maxLength="4" className="input-field text-center tracking-widest" value={editingCard.last4} onChange={e=>dispatch({type:'SET_EDITING_CARD', payload:{...editingCard, last4:e.target.value}})} /></div><div><label className="text-xs font-bold text-slate-500 mb-1 block">ÙŠÙˆÙ… Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label><input type="text" className="input-field text-center" value={editingCard.dueDate} onChange={e=>dispatch({type:'SET_EDITING_CARD', payload:{...editingCard, dueDate:e.target.value}})} /></div></div>
                                    <div><label className="text-xs font-bold text-slate-500 mb-1 block">Ù„ÙˆÙ† Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Theme)</label><select className="input-field" value={editingCard.theme} onChange={e=>dispatch({type:'SET_EDITING_CARD', payload:{...editingCard, theme:e.target.value}})}><option value="silver">ÙØ¶ÙŠ (Silver)</option><option value="gold">Ø°Ù‡Ø¨ÙŠ (Gold)</option><option value="platinum">Ø¨Ù„Ø§ØªÙŠÙ†ÙŠ (Platinum)</option><option value="black">Ø£Ø³ÙˆØ¯ (Black)</option><option value="blue">Ø£Ø²Ø±Ù‚ (Blue)</option></select></div>
                                    <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-500/30 transition-all mt-2 active:scale-95">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {editingLoan && (
                         <div className="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-[3500] backdrop-blur-md p-4 animate-fadeIn">
                            <div className="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden animate-fadeIn">
                                <div className="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center"><h3 className="text-xl font-black">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</h3><button type="button" onClick={() => dispatch({ type: 'SET_EDITING_LOAN', payload: null })}><X size={24} /></button></div>
                                <form onSubmit={handleUpdateLoan} className="p-6 space-y-4"><div><label className="text-xs font-bold text-slate-500">Ø§Ù„Ø§Ø³Ù…</label><input type="text" className="input-field" value={editingLoan.name} onChange={e=>dispatch({type:'SET_EDITING_LOAN', payload:{...editingLoan, name:e.target.value}})} /></div><div className="grid grid-cols-2 gap-4"><div><label className="text-xs font-bold text-slate-500">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„ÙƒÙ„ÙŠ</label><input type="number" className="input-field" value={editingLoan.totalAmount} onChange={e=>dispatch({type:'SET_EDITING_LOAN', payload:{...editingLoan, totalAmount:e.target.value}})} /></div><div><label className="text-xs font-bold text-slate-500">Ø§Ù„Ù‚Ø³Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠ</label><input type="number" className="input-field" value={editingLoan.monthlyInstallment} onChange={e=>dispatch({type:'SET_EDITING_LOAN', payload:{...editingLoan, monthlyInstallment:e.target.value}})} /></div></div><button type="submit" className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold mt-4">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button></form>
                            </div>
                        </div>
                    )}

                    {editingFawry && (
                        <div className="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-[3500] backdrop-blur-md p-4 animate-fadeIn">
                            <div className="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden animate-fadeIn border border-yellow-400/50">
                                <div className="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-yellow-50 dark:bg-yellow-900/10">
                                    <h3 className="text-xl font-black text-slate-800 dark:text-white">Ø¶Ø¨Ø· Ø±ØµÙŠØ¯ ÙÙˆØ±ÙŠ</h3>
                                    <button type="button" onClick={() => dispatch({ type: 'SET_EDITING_FAWRY', payload: null })} className="p-2 hover:bg-red-50 hover:text-red-500 rounded-xl transition-colors"><X size={24} /></button>
                                </div>
                                <form onSubmit={(e) => { e.preventDefault(); localStorage.setItem('fawryData', JSON.stringify(editingFawry)); dispatch({ type: 'UPDATE_FAWRY_DATA', payload: editingFawry }); dispatch({ type: 'SET_EDITING_FAWRY', payload: null }); addNotification({ type: 'success', title: 'ØªÙ… Ø§Ù„Ø­ÙØ¸', message: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ ÙÙˆØ±ÙŠ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ' }); }} className="p-6 space-y-6">
                                    <div className="bg-slate-50 dark:bg-slate-800 rounded-2xl p-5 border border-slate-200 dark:border-slate-700">
                                        <div className="flex items-center gap-2 mb-4 text-sm font-bold text-fawryBlue"><Calculator size={18} /> Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</div>
                                        <div className="space-y-2 text-sm font-mono">
                                            <div className="flex justify-between items-center"><span className="text-slate-500">Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ)</span><span className="font-bold text-slate-800 dark:text-white">{Number(editingFawry.openingBalance).toLocaleString()}</span></div>
                                            <div className="flex justify-between items-center text-emerald-600"><span>+ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø­Ù† (Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª)</span><span className="font-bold">+{fawryStats.deposits.toLocaleString()}</span></div>
                                            <div className="flex justify-between items-center text-red-500"><span>- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª (Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù…Ù„Ø§Øª)</span><span className="font-bold">-{fawryStats.withdrawals.toLocaleString()}</span></div>
                                            <div className="h-px bg-slate-300 dark:bg-slate-600 my-2"></div>
                                            <div className="flex justify-between items-center text-lg font-black text-fawryBlue"><span>= Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</span><span>{((Number(editingFawry.openingBalance) || 0) + fawryStats.deposits - fawryStats.withdrawals).toLocaleString()} Ø¬.Ù…</span></div>
                                        </div>
                                    </div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-2">ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label><input type="number" step="0.01" className="input-field text-xl font-black text-fawryBlue" value={editingFawry.openingBalance} onChange={e => dispatch({ type: 'SET_EDITING_FAWRY', payload: { ...editingFawry, openingBalance: Number(e.target.value) } })} placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ù‚Ø¨Ù„ 2026..." /><p className="text-[10px] text-slate-400 mt-2 leading-relaxed">ğŸ’¡ ØªÙ„Ù…ÙŠØ­: Ù„Ø§ ØªÙ‚Ù… Ø¨ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‡Ù†Ø§. ÙÙ‚Ø· Ø§ÙƒØªØ¨ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø°ÙŠ Ø¨Ø¯Ø£Øª Ø¨Ù‡ Ø§Ù„Ø³Ù†Ø© (Ø£Ùˆ Ø±ØµÙŠØ¯ Ø§Ù„ØªØ±Ø­ÙŠÙ„)ØŒ ÙˆØ³ÙŠÙ‚ÙˆÙ… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ø§Ù‚ÙŠ.</p></div>
                                    <button type="submit" className="w-full bg-fawryBlue text-white py-3 rounded-xl font-bold shadow-lg hover:bg-blue-800 transition-all">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {editingEtisalat && (
                        <div className="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-[3500] backdrop-blur-md p-4 animate-fadeIn">
                            <div className="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden animate-fadeIn border border-green-500/50">
                                <div className="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-green-50 dark:bg-green-900/10">
                                    <h3 className="text-xl font-black text-slate-800 dark:text-white">Ø¶Ø¨Ø· Ø§ØªØµØ§Ù„Ø§Øª ÙƒØ§Ø´</h3>
                                    <button type="button" onClick={() => dispatch({ type: 'SET_EDITING_ETISALAT', payload: null })} className="p-2 hover:bg-red-50 hover:text-red-500 rounded-xl transition-colors"><X size={24} /></button>
                                </div>
                                <form onSubmit={(e) => { e.preventDefault(); localStorage.setItem('etisalatData', JSON.stringify(editingEtisalat)); dispatch({ type: 'UPDATE_ETISALAT_DATA', payload: editingEtisalat }); dispatch({ type: 'SET_EDITING_ETISALAT', payload: null }); addNotification({ type: 'success', title: 'ØªÙ… Ø§Ù„Ø­ÙØ¸', message: 'ØªÙ… ØªØ­Ø¯ÙŠØ« Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ' }); }} className="p-6 space-y-6">
                                    <div className="bg-slate-50 dark:bg-slate-800 rounded-2xl p-5 border border-slate-200 dark:border-slate-700">
                                        <div className="flex items-center gap-2 mb-4 text-sm font-bold text-etisalatGreen"><Calculator size={18} /> Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</div>
                                        <div className="space-y-2 text-sm font-mono">
                                            <div className="flex justify-between items-center"><span className="text-slate-500">Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© (Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ)</span><span className="font-bold text-slate-800 dark:text-white">{Number(editingEtisalat.openingBalance).toLocaleString()}</span></div>
                                            <div className="flex justify-between items-center text-emerald-600"><span>+ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ¯Ø§Ø¹/Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª</span><span className="font-bold">+{etisalatStats.deposits.toLocaleString()}</span></div>
                                            <div className="flex justify-between items-center text-red-500"><span>- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø­Ø¨/Ø§Ù„Ø´Ø±Ø§Ø¡</span><span className="font-bold">-{etisalatStats.withdrawals.toLocaleString()}</span></div>
                                            <div className="h-px bg-slate-300 dark:bg-slate-600 my-2"></div>
                                            <div className="flex justify-between items-center text-lg font-black text-etisalatGreen"><span>= Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹</span><span>{((Number(editingEtisalat.openingBalance) || 0) + etisalatStats.deposits - etisalatStats.withdrawals).toLocaleString()} Ø¬.Ù…</span></div>
                                        </div>
                                    </div>
                                    <div><label className="block text-xs font-bold text-slate-500 mb-2">ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©</label><input type="number" step="0.01" className="input-field text-xl font-black text-etisalatGreen" value={editingEtisalat.openingBalance} onChange={e => dispatch({ type: 'SET_EDITING_ETISALAT', payload: { ...editingEtisalat, openingBalance: Number(e.target.value) } })} placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ..." /></div>
                                    <button type="submit" className="w-full bg-etisalatGreen text-white py-3 rounded-xl font-bold shadow-lg hover:bg-green-700 transition-all">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {isQuickTransferModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/80 flex items-center justify-center z-[3500] backdrop-blur-md p-4 animate-fadeIn">
                            <div className="bg-white dark:bg-slate-900 w-full max-w-md rounded-[2.5rem] shadow-2xl overflow-hidden animate-fadeIn border border-blue-500/50">
                                <div className="p-6 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center bg-blue-50 dark:bg-blue-900/10">
                                    <h3 className="text-xl font-black text-slate-800 dark:text-white flex items-center gap-2"><ArrowLeftRight size={20} className="text-blue-600"/> ØªØ­ÙˆÙŠÙ„ Ø³Ø±ÙŠØ¹</h3>
                                    <button type="button" onClick={() => dispatch({ type: 'SET_QUICK_TRANSFER_MODAL_OPEN', payload: false })} className="p-2 hover:bg-red-50 hover:text-red-500 rounded-xl transition-colors"><X size={24} /></button>
                                </div>
                                <form onSubmit={handleQuickTransfer} className="p-6 space-y-6">
                                    <div className="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-2xl">
                                        <div className="flex justify-between items-center text-sm font-bold text-blue-700 dark:text-blue-300 mb-2">
                                            <span>Ù…Ù†</span>
                                            <span>Ø¥Ù„Ù‰</span>
                                        </div>
                                        <div className="flex justify-between items-center gap-4">
                                            <select className="input-field text-sm" value={quickTransferData.from} onChange={e => dispatch({ type: 'SET_QUICK_TRANSFER_DATA', payload: { from: e.target.value } })}>
                                                {PAYMENT_METHODS.map(m => <option key={m.id} value={m.id}>{m.label}</option>)}
                                            </select>
                                            <div className="text-blue-300"><ArrowLeftRight size={20} /></div>
                                            <select className="input-field text-sm" value={quickTransferData.to} onChange={e => dispatch({ type: 'SET_QUICK_TRANSFER_DATA', payload: { to: e.target.value } })}>
                                                {PAYMENT_METHODS.map(m => <option key={m.id} value={m.id}>{m.label}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <div><label className="block text-sm font-bold mb-3 text-slate-500 uppercase">Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" required step="0.01" className="input-field text-xl font-black text-blue-600" value={quickTransferData.amount} onChange={e => dispatch({ type: 'SET_QUICK_TRANSFER_DATA', payload: { amount: e.target.value } })} placeholder="0.00" /></div>
                                    <button type="submit" className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 rounded-2xl font-bold shadow-lg shadow-blue-500/30 transition-all active:scale-95">ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ­ÙˆÙŠÙ„</button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const rootElement = document.getElementById('root');
        if(rootElement) {
            createRoot(rootElement).render(
                <ErrorBoundary>
                    <App />
                </ErrorBoundary>
            );
        }
    </script>
</body>
</html>